!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("hyphaWebsocketClient",[],t):"object"==typeof exports?exports.hyphaWebsocketClient=t():e.hyphaWebsocketClient=t()}(this,(()=>(()=>{"use strict";var __webpack_modules__={144:(e,t,n)=>{n.d(t,{Ci:()=>h,Xe:()=>l,oC:()=>a,sb:()=>_});var r=n(887),o=n(878),i=n(287),s=n(915),c=n(290);class a{constructor(e,t,n=null,r=null,i=null,s=60,c=7200){(0,o.vA)(e&&t,"server_url and client_id are required"),this._server_url=e.replace(/\/$/,""),this._client_id=t,this._workspace=n,this._token=r,this._reconnection_token=i,this._timeout=s,this._token_refresh_interval=c,this._handle_message=null,this._handle_disconnected=null,this._handle_connected=null,this._closed=!1,this._enable_reconnect=!1,this._is_reconnection=!1,this.connection_info=null,this.manager_id=null,this._abort_controller=null,this._refresh_token_task=null}on_message(e){(0,o.vA)(e,"handler is required"),this._handle_message=e}on_disconnected(e){this._handle_disconnected=e}on_connected(e){this._handle_connected=e}_get_headers(e=!1){const t={"Content-Type":"application/msgpack"};return e&&(t.Accept="application/x-msgpack-stream"),this._token&&(t.Authorization=`Bearer ${this._token}`),t}async open(){console.info(`Opening HTTP streaming connection to ${this._server_url}`);const e=this._workspace||"public",t=`${this._server_url}/${e}/rpc?client_id=${this._client_id}`;this._startStreamLoop(t);const n=Date.now();for(;null===this.connection_info;){if(await new Promise((e=>setTimeout(e,100))),Date.now()-n>1e3*this._timeout)throw new Error("Timeout waiting for connection info");if(this._closed)throw new Error("Connection closed during setup")}if(this.manager_id=this.connection_info.manager_id,this._workspace){const e=this.connection_info.workspace;if(e!==this._workspace)throw new Error(`Connected to wrong workspace: ${e}, expected: ${this._workspace}`)}if(this._workspace=this.connection_info.workspace,this.connection_info.reconnection_token&&(this._reconnection_token=this.connection_info.reconnection_token),this.connection_info.reconnection_token_life_time){const e=this.connection_info.reconnection_token_life_time;this._token_refresh_interval>e/1.5&&(console.warn(`Token refresh interval (${this._token_refresh_interval}s) is too long, adjusting to ${(e/1.5).toFixed(0)}s based on token lifetime`),this._token_refresh_interval=e/1.5)}return console.info(`HTTP streaming connected to workspace: ${this._workspace}, manager_id: ${this.manager_id}`),this._token_refresh_interval>0&&this._startTokenRefresh(),this._handle_connected&&await this._handle_connected(this.connection_info),this.connection_info}_startTokenRefresh(){this._refresh_token_task&&clearInterval(this._refresh_token_task),setTimeout((()=>{this._sendRefreshToken(),this._refresh_token_task=setInterval((()=>{this._sendRefreshToken()}),1e3*this._token_refresh_interval)}),2e3)}async _sendRefreshToken(){if(!this._closed)try{const e=this._workspace||"public",t=`${this._server_url}/${e}/rpc?client_id=${this._client_id}`,n=(0,s.l)({type:"refresh_token"}),r=await fetch(t,{method:"POST",headers:this._get_headers(!1),body:n});r.ok?console.debug("Token refresh requested successfully"):console.warn(`Token refresh request failed: ${r.status}`)}catch(e){console.warn(`Failed to send refresh token request: ${e.message}`)}}async _startStreamLoop(e){this._enable_reconnect=!0,this._closed=!1;let t=0;for(this._is_reconnection=!1;!this._closed&&t<1e6;){try{const e=this._workspace||"public";let n=`${this._server_url}/${e}/rpc?client_id=${this._client_id}`;this._reconnection_token&&(n+=`&reconnection_token=${encodeURIComponent(this._reconnection_token)}`),this._abort_controller=new AbortController;const r=await fetch(n,{method:"GET",headers:this._get_headers(!0),signal:this._abort_controller.signal});if(!r.ok){const e=await r.text();throw new Error(`Stream failed with status ${r.status}: ${e}`)}t=0,await this._processMsgpackStream(r)}catch(e){if(this._closed)break;if(console.error(`Connection error: ${e.message}`),!this._enable_reconnect)break}if(this._is_reconnection=!0,this._closed||!this._enable_reconnect)break;{t+=1;const e=Math.min(Math.pow(2,Math.min(t,6)),60);console.warn(`Stream disconnected, reconnecting in ${e.toFixed(1)}s (attempt ${t})`),await new Promise((t=>setTimeout(t,1e3*e)))}}!this._closed&&this._handle_disconnected&&this._handle_disconnected("Stream ended")}_tryDecodeControlMessage(e){try{const t=(0,c.D4)(e);return"object"==typeof t&&null!==t&&t.type&&["connection_info","ping","pong","reconnection_token","error"].includes(t.type)?t:null}catch{return null}}async _processMsgpackStream(e){const t=e.body.getReader();let n=new Uint8Array(4096),r=0;for(;!this._closed;){const{done:e,value:o}=await t.read();if(e)break;const i=r+o.length;if(i>n.length){let e=n.length;for(;e<i;)e*=2;const t=new Uint8Array(e);t.set(n.subarray(0,r)),n=t}n.set(o,r),r+=o.length;let s=0;for(;r-s>=4;){const e=n[s]<<24|n[s+1]<<16|n[s+2]<<8|n[s+3];if(r-s<4+e)break;const t=n.slice(s+4,s+4+e);s+=4+e;const o=this._tryDecodeControlMessage(t);if(o){const e=o.type;if("connection_info"===e){this.connection_info=o,this._is_reconnection&&this._handleReconnection(o).catch((e=>{console.error(`Reconnection handling failed: ${e.message}`)}));continue}if("ping"===e||"pong"===e)continue;if("reconnection_token"===e){this._reconnection_token=o.reconnection_token;continue}if("error"===e){console.error(`Server error: ${o.message}`);continue}}if(this._handle_message)try{await this._handle_message(t)}catch(e){console.error(`Error in message handler: ${e.message}`)}}if(s>0){const e=r-s;e>0&&n.copyWithin(0,s,r),r=e}}}async _handleReconnection(e){if(this.manager_id=e.manager_id,this._workspace=e.workspace,e.reconnection_token&&(this._reconnection_token=e.reconnection_token),e.reconnection_token_life_time){const t=e.reconnection_token_life_time;this._token_refresh_interval>t/1.5&&(this._token_refresh_interval=t/1.5)}console.warn(`Stream reconnected to workspace: ${this._workspace}, manager_id: ${this.manager_id}`),this._handle_connected&&await this._handle_connected(this.connection_info),await new Promise((e=>setTimeout(e,500)))}async emit_message(e){if(this._closed)throw new Error("Connection is closed");const t=this._workspace||"public";let n=`${this._server_url}/${t}/rpc?client_id=${this._client_id}`;const r=e instanceof Uint8Array?e:new Uint8Array(e);for(let e=0;e<3;e++)try{const t=r.length<6e4,o=await fetch(n,{method:"POST",headers:this._get_headers(!1),body:r,...t&&{keepalive:!0}});if(!o.ok){const t=await o.text();if(400===o.status&&e<2){console.warn(`POST failed (attempt ${e+1}/3): ${t}, retrying...`),await new Promise((t=>setTimeout(t,500*(e+1))));continue}throw new Error(`POST failed with status ${o.status}: ${t}`)}return!0}catch(t){if(!(e<2)||this._closed)throw console.error(`Failed to send message: ${t.message}`),t;console.warn(`Failed to send message (attempt ${e+1}/3): ${t.message}, retrying...`),await new Promise((t=>setTimeout(t,500*(e+1))))}}set_reconnection(e){this._enable_reconnect=e}async disconnect(e="client disconnect"){this._closed||(this._closed=!0,this._refresh_token_task&&(clearInterval(this._refresh_token_task),this._refresh_token_task=null),this._abort_controller&&(this._abort_controller.abort(),this._abort_controller=null),this._handle_disconnected&&this._handle_disconnected(e))}}function _(e){if(!e)throw new Error("server_url is required");return e.startsWith("ws://")?e=e.replace("ws://","http://"):e.startsWith("wss://")&&(e=e.replace("wss://","https://")),e.endsWith("/ws")&&(e=e.slice(0,-3)),e.replace(/\/$/,"")}async function l(e={}){return await async function(e){let t=e.clientId||e.client_id;t||(t=(0,o.bq)());const n=_(e.serverUrl||e.server_url),s=new a(n,t,e.workspace,e.token,e.reconnection_token,e.method_timeout||30,e.token_refresh_interval||7200),c=await s.open();(0,o.vA)(c,"Failed to connect to server"),await new Promise((e=>setTimeout(e,100)));const l=c.workspace,h=new r.y(s,{client_id:t,workspace:l,default_context:{connection_type:"http_streaming"},name:e.name,method_timeout:e.method_timeout,app_id:e.app_id,server_base_url:c.public_base_url});await h.waitFor("services_registered",e.method_timeout||120);const d=await h.get_manager_service({timeout:e.method_timeout||30,case_conversion:"camel"});d.rpc=h,d.disconnect=(0,i.G)(h.disconnect.bind(h),{name:"disconnect",description:"Disconnect from server",parameters:{properties:{},type:"object"}}),d.registerService=(0,i.G)(h.register_service.bind(h),{name:"registerService",description:"Register a service",parameters:{properties:{service:{description:"Service to register",type:"object"}},required:["service"],type:"object"}});const u=d.getService;return d.getService=async(e,t={})=>await u(e,t),u.__schema__&&(d.getService.__schema__=u.__schema__),d.serve=(0,i.G)((async function(){await new Promise((()=>{}))}),{name:"serve",description:"Run event loop forever",parameters:{type:"object",properties:{}}}),c&&(d.config=Object.assign(d.config||{},c)),s.manager_id&&h.on("force-exit",(async e=>{e.from==="*/"+s.manager_id&&(console.info(`Disconnecting from server: ${e.reason}`),await h.disconnect())})),d}(e)}async function h(e,t={}){const{serverUrl:n,workspace:r,clientId:i,serviceId:s,appId:c}=(0,o.iO)(e),a=`${r}/${i}:${s}@${c}`;if(t.serverUrl&&t.serverUrl!==n)throw new Error("server_url mismatch");t.serverUrl=n;const _=await l(t);return await _.getService(a)}},887:(e,t,n)=>{n.d(t,{m:()=>c,y:()=>g});var r=n(878),o=n(287),i=n(290),s=n(915);const c=3,a=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function _(e){if(null==e)return!0;const t=typeof e;return"number"===t||"string"===t||"boolean"===t}function l(e){for(let t=0;t<e.length;t++){const n=e[t];if(!(_(n)||n instanceof Uint8Array))if(Array.isArray(n)){if(!l(n))return!1}else{if(!n||n.constructor!==Object)return!1;if("_rtype"in n)return!1;if(!h(n))return!1}}return!0}function h(e){const t=Object.values(e);for(let e=0;e<t.length;e++){const n=t[e];if(!(_(n)||n instanceof Uint8Array))if(Array.isArray(n)){if(!l(n))return!1}else{if(!n||n.constructor!==Object)return!1;if("_rtype"in n)return!1;if(!h(n))return!1}}return!0}function d(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function u(e,t,n="Operation timed out"){return new Promise(((r,o)=>{const i=setTimeout((()=>{o(new Error(`TimeoutError: ${n}`))}),t);e.then((e=>{clearTimeout(i),r(e)})).catch((e=>{clearTimeout(i),o(e)}))}))}function p(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?p(e,t.split(".")):0===t.length?e:p(e[t[0]],t.slice(1))}function f(e,t=null,n=!1){if(Array.isArray(e))return e.map(((e,t)=>f(e,null,n)));if("object"==typeof e&&null!==e){let t={};for(let r in e)t[r]=f(e[r],r,n);return t}if("function"==typeof e){if(e.__schema__){const r=JSON.parse(JSON.stringify(e.__schema__));if(t&&(r.name=t,e.__schema__.name=t),n&&(r.parameters&&r.parameters.properties&&delete r.parameters.properties.context,r.parameters&&r.parameters.required)){const e=r.parameters.required.indexOf("context");e>-1&&r.parameters.required.splice(e,1)}return{type:"function",function:r}}return{type:"function",function:{name:t||e.name||"function"}}}return"number"==typeof e?{type:"number"}:"string"==typeof e?{type:"string"}:"boolean"==typeof e?{type:"boolean"}:null===e?{type:"null"}:{}}class y{constructor(e,t,n,r){this._timeout=e,this._callback=t,this._args=n,this._label=r||"timer",this._task=null,this.started=!1}start(){this.started?this.reset():(this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0)}clear(){this._task&&this.started?(clearTimeout(this._task),this._task=null,this.started=!1):console.warn(`Clearing a timer (${this._label}) which is not started`)}reset(){this._task&&clearTimeout(this._task),this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0}}class m extends Object{}class g extends r.sw{constructor(e,{client_id:t=null,default_context:n=null,name:o=null,codecs:i=null,method_timeout:s=null,max_message_buffer_size:a=0,debug:_=!1,workspace:l=null,silent:h=!1,app_id:d=null,server_base_url:p=null,long_message_chunk_size:f=null}){if(super(_),this._codecs=i||{},(0,r.vA)(t&&"string"==typeof t),(0,r.vA)(t,"client_id is required"),this._client_id=t,this._name=o,this._app_id=d||"*",this._local_workspace=l,this._silent=h,this.default_context=n||{},this._method_annotations=new WeakMap,this._max_message_buffer_size=a,this._chunk_store={},this._method_timeout=s||30,this._server_base_url=p,this._long_message_chunk_size=f||262144,this._services={},this._object_store={services:this._services},this._targetIdIndex={},this._background_tasks=new Set,this._sessionMaxAge=6e5,this._sessionSweepInterval=setInterval((()=>{this._sweepStaleSessions()}),this._sessionMaxAge/2),this._unhandledRejectionHandler=e=>{const t=e.reason;if(t&&"object"==typeof t){const n=t.toString();if(n.includes("Method not found")||n.includes("Session not found")||n.includes("Method expired")||n.includes("Connection is closed")||n.includes("Client disconnected")||n.includes("RPC connection closed"))return console.debug("Ignoring expected disconnection/method error:",t),void e.preventDefault()}console.warn("Unhandled RPC promise rejection:",t)},this._unhandledRejectionNodeHandler=null,g._rejectionHandlerCount||(g._rejectionHandlerCount=0),g._rejectionHandlerCount++,1===g._rejectionHandlerCount&&("undefined"!=typeof window?window.addEventListener("unhandledrejection",this._unhandledRejectionHandler):"undefined"!=typeof process&&(this._unhandledRejectionNodeHandler=(e,t)=>{this._unhandledRejectionHandler({reason:e,promise:t,preventDefault:()=>{}})},process.on("unhandledRejection",this._unhandledRejectionNodeHandler))),e){this.add_service({id:"built-in",type:"built-in",name:`Built-in services for ${this._local_workspace}/${this._client_id}`,config:{require_context:!0,visibility:"public",api_version:c},ping:this._ping.bind(this),get_service:this.get_local_service.bind(this),message_cache:{create:this._create_message.bind(this),append:this._append_message.bind(this),set:this._set_message.bind(this),process:this._process_message.bind(this),remove:this._remove_message.bind(this)}}),this._boundHandleMethod=this._handle_method.bind(this),this._boundHandleError=console.error,this.on("method",this._boundHandleMethod),this.on("error",this._boundHandleError),(0,r.vA)(e.emit_message&&e.on_message),(0,r.vA)(void 0!==e.manager_id,"Connection must have manager_id"),this._emit_message=e.emit_message.bind(e),e.on_message(this._on_message.bind(this)),this._connection=e;const t=async e=>{if(!this._silent&&this._connection.manager_id){console.debug("Connection established, reporting services...");try{const e=await this.get_manager_service({timeout:20,case_conversion:"camel"}),t=Object.values(this._services),n=t.length;let r=0;const o=[],i=this._method_timeout||3e4;for(let n of t)try{const t=this._extract_service_info(n);await u(e.registerService(t),i,`Timeout registering service ${n.id||"unknown"}`),r++,console.debug(`Successfully registered service: ${n.id||"unknown"}`)}catch(e){o.push(n.id||"unknown"),e.message&&e.message.includes("TimeoutError")?console.error(`Timeout registering service ${n.id||"unknown"}`):console.error(`Failed to register service ${n.id||"unknown"}: ${e}`)}r===n?console.info(`Successfully registered all ${r} services with the server`):console.warn(`Only registered ${r} out of ${n} services with the server. Failed services: ${o.join(", ")}`),this._fire("services_registered",{total:n,registered:r,failed:o});try{if(e.subscribe&&"function"==typeof e.subscribe){console.debug("Subscribing to client_disconnected events");const t=async e=>{const t=e.data?.id||e.client,n=e.data?.workspace;if(t&&n){const e=`${n}/${t}`;console.debug(`Client ${e} disconnected, cleaning up sessions`),await this._handleClientDisconnected(e)}else t&&(console.debug(`Client ${t} disconnected, cleaning up sessions`),await this._handleClientDisconnected(t))};this._clientDisconnectedSubscription=await u(e.subscribe(["client_disconnected"]),i,"Timeout subscribing to client_disconnected events"),this.on("client_disconnected",t),console.debug("Successfully subscribed to client_disconnected events")}else console.debug("Manager does not support subscribe method, skipping client_disconnected handling"),this._clientDisconnectedSubscription=null}catch(e){console.debug(`Failed to subscribe to client_disconnected events: ${e}`),this._clientDisconnectedSubscription=null}}catch(e){console.error(`Failed to get manager service for registering services: ${e}`),this._fire("services_registration_failed",{error:e.toString(),total_services:Object.keys(this._services).length})}}e&&(e.public_base_url&&(this._server_base_url=e.public_base_url),this._fire("connected",e))};e.on_connected(t),"function"==typeof e.on_disconnected&&e.on_disconnected((t=>{e._enable_reconnect?console.info(`Connection lost (${t}), reconnection enabled - pending calls will be handled by timeout`):(console.warn(`Connection lost (${t}), rejecting all pending RPC calls`),this._rejectPendingCalls(`Connection lost: ${t||"unknown reason"}`))})),t()}else this._emit_message=function(){console.log("No connection to emit message")}}register_codec(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(this._codecs))this._codecs[t].type!==e.type&&t!==e.name||(delete this._codecs[t],console.warn("Remove duplicated codec: "+t));this._codecs[e.name]=e}async _ping(e,t){return(0,r.vA)("ping"==e),"pong"}async ping(e,t){let n=this._generate_remote_method({_rserver:this._server_base_url,_rtarget:e,_rmethod:"services.built-in.ping",_rpromise:!0,_rdoc:"Ping a remote client"});(0,r.vA)("pong"==await n("ping",t))}_create_message(e,t,n,r){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}this._object_store.message_cache||(this._object_store.message_cache={});const o=this._object_store.message_cache,i=Object.keys(o);if(i.length>=256){const e=Date.now();for(const t of i){const n=o[t];n&&n._cache_created_at&&e-n._cache_created_at>3e5&&delete o[t]}const t=Object.keys(o);t.length>=256&&t.sort(((e,t)=>(o[e]._cache_created_at||0)-(o[t]._cache_created_at||0))).slice(0,t.length-256+1).forEach((e=>delete o[e]))}if(!n&&o[e])throw new Error(`Message with the same key (${e}) already exists in the cache store, please use overwrite=true or remove it first.`);o[e]=[],o[e]._cache_created_at=Date.now()}_append_message(e,t,n,o){if(n){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const i=this._object_store.message_cache;if(!i[e])throw new Error(`Message with key ${e} does not exists.`);(0,r.vA)(t instanceof a),i[e].push(t)}_set_message(e,t,n,o,i){if(o){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if(!s[e])throw new Error(`Message with key ${e} does not exists.`);(0,r.vA)(n instanceof a),s[e][t]=n}_remove_message(e,t){const n=this._object_store.message_cache;if(!n[e])throw new Error(`Message with key ${e} does not exists.`);delete n[e]}_process_message(e,t,n){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const o=this._object_store.message_cache;if((0,r.vA)(!!n,"Context is required"),!o[e])throw new Error(`Message with key ${e} does not exists.`);var s,c,a,_;o[e]=(a=(c=(s=o[e]).map((function(e){return e.byteLength}))).reduce((function(e,t){return e+t}),0),_=new Uint8Array(a),c.reduce((function(e,t,n){return _.set(new Uint8Array(s[n]),e),e+t}),0),_.buffer);let l=(0,i.UN)(o[e]);const{done:h,value:d}=l.next(),u=d;if(Object.assign(u,{from:n.from,to:n.to,ws:n.ws,user:n.user}),u.ctx=JSON.parse(JSON.stringify(u)),Object.assign(u.ctx,this.default_context),!h){let e=l.next();Object.assign(u,e.value)}this._fire(u.type,u),delete o[e]}_on_message(e){if("string"==typeof e){const t=JSON.parse(e);t.ctx=Object.assign({},t,this.default_context),this._fire(t.type,t)}else if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){let t=(0,i.UN)(e);const{done:n,value:r}=t.next(),o=r;if(o.ctx=Object.assign({},o,this.default_context),!n){let e=t.next();Object.assign(o,e.value)}this._fire(o.type,o)}else{if("object"!=typeof e)throw new Error("Invalid message format");e.ctx=Object.assign({},e,this.default_context),this._fire(e.type,e)}}reset(){this._removeRejectionHandler(),this._event_handlers={},this._services={}}_removeRejectionHandler(){g._rejectionHandlerCount&&g._rejectionHandlerCount>0&&(g._rejectionHandlerCount--,0===g._rejectionHandlerCount&&("undefined"!=typeof window&&this._unhandledRejectionHandler?window.removeEventListener("unhandledrejection",this._unhandledRejectionHandler):"undefined"!=typeof process&&this._unhandledRejectionNodeHandler&&process.removeListener("unhandledRejection",this._unhandledRejectionNodeHandler))),this._unhandledRejectionHandler=null,this._unhandledRejectionNodeHandler=null}close(){if(this._cleanupOnDisconnect(),this._boundHandleMethod&&(this.off("method",this._boundHandleMethod),this._boundHandleMethod=null),this._boundHandleError&&(this.off("error",this._boundHandleError),this._boundHandleError=null),this._clientDisconnectedSubscription){try{"function"==typeof this._clientDisconnectedSubscription.unsubscribe&&this._clientDisconnectedSubscription.unsubscribe()}catch(e){console.debug(`Error unsubscribing client_disconnected: ${e}`)}this.off("client_disconnected"),this._clientDisconnectedSubscription=null}this._removeRejectionHandler(),this.off();try{for(const e of this._background_tasks)if(e&&"function"==typeof e.cancel)try{e.cancel()}catch(e){console.debug(`Error canceling background task: ${e}`)}this._background_tasks.clear()}catch(e){console.debug(`Error cleaning up background tasks: ${e}`)}this._sessionSweepInterval&&(clearInterval(this._sessionSweepInterval),this._sessionSweepInterval=null);try{this._connection=null,this._emit_message=function(){return console.debug("RPC connection closed, ignoring message"),Promise.reject(new Error("Connection is closed"))}}catch(e){console.debug(`Error during connection cleanup: ${e}`)}this._fire("disconnected")}async _handleClientDisconnected(e){try{console.debug(`Handling disconnection for client: ${e}`);const t=this._cleanupSessionsForClient(e);t>0&&console.debug(`Cleaned up ${t} sessions for disconnected client: ${e}`),this._fire("remote_client_disconnected",{client_id:e,sessions_cleaned:t})}catch(t){console.error(`Error handling client disconnection for ${e}: ${t}`)}}_removeFromTargetIdIndex(e){const t=e.split(".")[0],n=this._object_store[t];if(n&&"object"==typeof n){const e=n.target_id;e&&e in this._targetIdIndex&&(this._targetIdIndex[e].delete(t),0===this._targetIdIndex[e].size&&delete this._targetIdIndex[e])}}_cleanupSessionEntry(e,t=null){if(e&&"object"==typeof e){if(t&&e.reject&&"function"==typeof e.reject)try{e.reject(new Error(t))}catch(e){console.debug(`Error rejecting session: ${e}`)}if(e.heartbeat_task)try{clearInterval(e.heartbeat_task)}catch(e){}if(e.timer&&e.timer.started&&"function"==typeof e.timer.clear)try{e.timer.clear()}catch(e){}}}_cleanupSessionsForClient(e){let t=0;const n=this._targetIdIndex[e];if(!n)return 0;const r=`Client disconnected: ${e}`;for(const o of n){const n=this._object_store[o];n&&"object"==typeof n&&n.target_id===e&&(this._cleanupSessionEntry(n,r),delete this._object_store[o],t++,console.debug(`Cleaned up session: ${o}`))}return delete this._targetIdIndex[e],t}_rejectPendingCalls(e="Connection lost"){try{let t=0;for(const n of Object.keys(this._object_store)){if("services"===n||"message_cache"===n)continue;const r=this._object_store[n];"object"==typeof r&&null!==r&&(r.reject&&"function"==typeof r.reject&&t++,this._cleanupSessionEntry(r,e))}t>0&&console.warn(`Rejected ${t} pending RPC call(s) due to: ${e}`)}catch(e){console.error(`Error rejecting pending calls: ${e}`)}}_cleanupOnDisconnect(){try{console.debug("Cleaning up all sessions due to local RPC disconnection");const e=[];for(const t of Object.keys(this._object_store)){if("services"===t||"message_cache"===t)continue;const n=this._object_store[t];this._cleanupSessionEntry(n,"RPC connection closed"),e.push(t)}for(const t of e)delete this._object_store[t];this._targetIdIndex={}}catch(e){console.error(`Error during cleanup on disconnect: ${e}`)}}async disconnect(){const e=this._connection;if(this.close(),e)try{await e.disconnect()}catch(e){console.debug(`Error disconnecting underlying connection: ${e}`)}}async get_manager_service(e,t=20){e=e||{};let n=null;for(let r=0;r<t;r++){const o=Math.min(500*Math.pow(2,r),1e4);if(!this._connection.manager_id){if(r<t-1){console.warn(`Manager ID not set, retrying in ${o}ms (attempt ${r+1}/${t})`),await new Promise((e=>setTimeout(e,o)));continue}throw new Error("Manager ID not set after maximum retries")}try{return await this.get_remote_service(`*/${this._connection.manager_id}:default`,e)}catch(e){n=e,console.warn(`Failed to get manager service (attempt ${r+1}/${t}): ${e.message}`),r<t-1&&await new Promise((e=>setTimeout(e,o)))}}throw n}get_all_local_services(){return this._services}get_local_service(e,t){(0,r.vA)(e),(0,r.vA)(t,"Context is required");const[n,o]=t.to.split("/");(0,r.vA)(o===this._client_id,"Services can only be accessed locally");const i=this._services[e];if(!i)throw new Error("Service not found: "+e);if("public"==i.config.visibility||"unlisted"==i.config.visibility)return i;if(t.ws===n)return i;const s=i.config.authorized_workspaces;if(s&&s.includes(t.ws))return i;throw new Error(`Permission denied for getting protected service: ${e}, workspace mismatch: ${n} != ${t.ws}`)}async get_remote_service(e,t){let{timeout:n,case_conversion:o,kwargs_expansion:i}=t||{};n=void 0===n?this._method_timeout:n,!e&&this._connection.manager_id?e="*/"+this._connection.manager_id:e.includes(":")||(e=this._client_id+":"+e);const s=e.split(":")[0];let c=e.split(":")[1];if(c.includes("@")){c=c.split("@")[0];const t=e.split("@")[1];this._app_id&&"*"!==this._app_id&&(0,r.vA)(t===this._app_id,`Invalid app id: ${t} != ${this._app_id}`)}(0,r.vA)(s,`Invalid service uri: ${e}`);try{const t=this._generate_remote_method({_rserver:this._server_base_url,_rtarget:s,_rmethod:"services.built-in.get_service",_rpromise:!0,_rdoc:"Get a remote service"});let a=await(0,r.fm)(t(c),n,"Timeout Error: Failed to get remote service: "+e);return a.id=`${s}:${c}`,i&&(a=(0,r.uX)(a)),o?Object.assign(new m,(0,r.gX)(a,o)):Object.assign(new m,a)}catch(t){throw console.warn("Failed to get remote service: "+e,t),t}}_annotate_service_methods(e,t,n,r,o,i){if("function"==typeof e){let s=t.split(".")[1];this._method_annotations.set(e,{require_context:Array.isArray(n)?n.includes(s):!!n,run_in_executor:r,method_id:"services."+t,visibility:o,authorized_workspaces:i})}else if(e instanceof Array||e instanceof Object)for(let s of Object.keys(e)){let c=e[s];if("function"==typeof c&&c.__rpc_object__){let t=c.__rpc_object__._rtarget;if(t.includes("/")&&(t=t.split("/")[1]),this._client_id!==t)throw new Error(`Local method not found: ${c.__rpc_object__._rmethod}, client id mismatch ${this._client_id} != ${t}`);e instanceof Array&&(e=e.slice()),e[s]=p(this._object_store,c.__rpc_object__._rmethod),c=e[s]}this._annotate_service_methods(c,t+"."+s,n,r,o,i)}}add_service(e,t){if(!e||Array.isArray(e))throw new Error("Invalid service object");if(e.constructor===Object)e=Object.assign({},e);else{const t={},n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertyNames(Object.getPrototypeOf(e)));for(let r of n)"constructor"!==r&&("function"==typeof e[r]?t[r]=e[r].bind(e):t[r]=e[r]);e.id=e.id||"default",e=t}(0,r.vA)(e.id&&"string"==typeof e.id,`Service id not found: ${e}`),e.name||(e.name=e.id),e.config||(e.config={}),e.type||(e.type="generic");let n=!1,o=!1;e.config.require_context&&(n=e.config.require_context),e.config.run_in_executor&&(o=!0);const i=e.config.visibility||"protected";(0,r.vA)(["protected","public","unlisted"].includes(i));const s=e.config.authorized_workspaces;if(void 0!==s){if("protected"!==i)throw new Error(`authorized_workspaces can only be set when visibility is 'protected', got visibility='${i}'`);if(!Array.isArray(s))throw new Error("authorized_workspaces must be an array of workspace ids");for(const e of s)if("string"!=typeof e)throw new Error("Each workspace id in authorized_workspaces must be a string, got "+typeof e)}if(this._annotate_service_methods(e,e.id,n,o,i,s),this._services[e.id]){if(!t)throw new Error(`Service already exists: ${e.id}, please specify a different id (not ${e.id}) or overwrite=true`);delete this._services[e.id]}return this._services[e.id]=e,e}_extract_service_info(e){const t=e.config||{};if(t.workspace=t.workspace||this._local_workspace||this._connection.workspace,!t.workspace)throw new Error("Workspace is not set. Please ensure the connection has a workspace or set local_workspace.");const n=t.require_context,r=["id","config","name","description","type","docs","app_id","service_schema"],o={};for(const t of Object.keys(e))r.includes(t)||(o[t]=e[t]);const i=f(o,null,n);return{config:t,id:`${t.workspace}/${this._client_id}:${e.id}`,name:e.name||e.id,description:e.description||"",type:e.type||"generic",docs:e.docs||null,app_id:this._app_id,service_schema:i}}async get_service_schema(e){return f(e,null,e.config.require_context)}async register_service(e,t){let n,{check_type:r,notify:i,overwrite:s}=t||{};if(i=void 0===i||i,r&&e.type)try{n=await this.get_manager_service({timeout:10,case_conversion:"camel"}),e=function(e,t){function n(e,t,n="root"){for(let r in t)if(!e.hasOwnProperty(r))throw new Error(`Missing key '${r}' in service at path '${n}'`);for(let r in e)if("type"!==r&&!t.hasOwnProperty(r))throw new Error(`Unexpected key '${r}' in service at path '${n}'`)}return n(e,t.definition),function e(t,r,i="root"){if("object"!=typeof t||Array.isArray(t)){if(Array.isArray(t)){if(t.length!==r.length)throw new Error(`Length mismatch at path '${i}'`);t.forEach(((n,s)=>{let c=`${i}[${s}]`;if("object"!=typeof n||Array.isArray(n)){if("function"==typeof n){if(!r.hasOwnProperty(s))throw new Error(`Missing schema for function at index ${s} in path '${c}'`);t[s]=(0,o.G)(n,{name:r[s].name,description:r[s].description||"",parameters:r[s].parameters})}}else e(n,r[s],c)}))}}else{n(t,r,i);for(let n in t){let s=t[n],c=`${i}.${n}`;if("object"!=typeof s||Array.isArray(s)){if("function"==typeof s){if(!r.hasOwnProperty(n))throw new Error(`Missing schema for function '${n}' at path '${c}'`);t[n]=(0,o.G)(s,{name:r[n].name,description:r[n].description||"",parameters:r[n].parameters})}}else e(s,r[n],c)}}}(e,t.definition),e}(e,await n.get_service_type(e.type))}catch(t){throw new Error(`Failed to get service type ${e.type}, error: ${t}`)}const c=this.add_service(e,s),a=this._extract_service_info(c);if(i)try{n=n||await this.get_manager_service({timeout:10,case_conversion:"camel"}),await n.registerService(a)}catch(e){throw new Error(`Failed to notify workspace manager: ${e}`)}return a}async unregister_service(e,t){let n;if(t=void 0===t||t,n="string"==typeof e?e:e.id,(0,r.vA)(n&&"string"==typeof n,`Invalid service id: ${n}`),n.includes(":")&&(n=n.split(":")[1]),n.includes("@")&&(n=n.split("@")[0]),!this._services[n])throw new Error(`Service not found: ${n}`);if(n.startsWith("_rintf_")&&(t=!1),t){const e=await this.get_manager_service({timeout:10,case_conversion:"camel"});await e.unregisterService(n)}delete this._services[n]}_ndarray(e,t,n){const o=(0,r.D4)(e);if(n&&n!==o)throw"dtype doesn't match the type of the array: "+o+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:o}}_encode_callback(e,t,n,r,o,i,s){let c=`${n}.${e}`,a={_rtype:"method",_rtarget:i?`${i}/${this._client_id}`:this._client_id,_rmethod:c,_rpromise:!1};const _=this;let l=function(){try{t.apply(null,Array.prototype.slice.call(arguments))}catch(e){console.error(`Error in callback(${c}, ${s}): ${e}`)}finally{o&&o.started&&o.clear(),r&&_._object_store[n]&&("resolve"===e||"reject"===e?(_._removeFromTargetIdIndex(n),delete _._object_store[n]):_._cleanup_session_if_needed(n,e))}};return l.__name__=`callback(${c})`,[a,l]}_cleanup_session_if_needed(e,t){if(e)try{const n=this._get_session_store(e,!1);if(!n)return void console.debug(`Session ${e} not found for cleanup`);let r=!1;if(n._promise_manager)try{const o=n._promise_manager;o.should_cleanup_on_callback&&o.should_cleanup_on_callback(t)&&(o.settle&&o.settle(),r=!0,console.debug(`Promise session ${e} settled and marked for cleanup`))}catch(t){console.warn(`Error in promise manager cleanup for session ${e}:`,t)}else("resolve"===t||"reject"===t)&&n._callbacks&&Object.keys(n._callbacks).includes(t)&&(r=!0,console.debug(`Regular session ${e} marked for cleanup after ${t}`));r&&this._cleanup_session_completely(e)}catch(t){console.warn(`Error during session cleanup for ${e}:`,t)}else console.debug("Cannot cleanup session: session_id is empty")}_cleanup_session_completely(e){try{this._removeFromTargetIdIndex(e);const t=this._get_session_store(e,!1);if(!t)return void console.debug(`Session ${e} already cleaned up`);if(t.timer&&t.timer.started&&"function"==typeof t.timer.clear)try{t.timer.clear()}catch(t){console.warn(`Error clearing timer for session ${e}:`,t)}if(t.heartbeat_task&&"function"==typeof t.heartbeat_task.cancel)try{t.heartbeat_task.cancel()}catch(t){console.warn(`Error canceling heartbeat for session ${e}:`,t)}const n=e.split(".");let r=this._object_store;for(let t=0;t<n.length-1;t++){const o=n[t];if(!r[o])return void console.debug(`Session path ${e} not found at level ${o}`);r=r[o]}const o=n[n.length-1];r[o]&&(delete r[o],console.debug(`Cleaned up session ${e}`),this._cleanup_empty_containers(n.slice(0,-1)))}catch(t){console.warn(`Error in complete session cleanup for ${e}:`,t)}}_cleanup_empty_containers(e){try{for(let t=e.length-1;t>=0;t--){let n=this._object_store;for(let r=0;r<t;r++)if(n=n[e[r]],!n)return;const r=e[t],o=n[r];if(!o||"object"!=typeof o||0!==Object.keys(o).length)break;delete n[r],console.debug(`Cleaned up empty container at depth ${t}: ${e.slice(0,t+1).join(".")}`)}}catch(e){console.warn("Error cleaning up empty containers:",e)}}get_session_stats(){const e={total_sessions:0,promise_sessions:0,regular_sessions:0,sessions_with_timers:0,sessions_with_heartbeat:0,system_stores:{},session_ids:[],memory_usage:0};if(!this._object_store)return e;for(const t in this._object_store){const n=this._object_store[t];["services","message_cache"].includes(t)?e.system_stores[t]={size:"object"==typeof n&&n?Object.keys(n).length:0}:n&&"object"==typeof n&&Object.keys(n).length>0&&(e.total_sessions++,e.session_ids.push(t),n._promise_manager?e.promise_sessions++:e.regular_sessions++,(n._timer||n.timer)&&e.sessions_with_timers++,(n._heartbeat||n.heartbeat)&&e.sessions_with_heartbeat++,e.memory_usage+=JSON.stringify(n).length)}return e}_force_cleanup_all_sessions(){if(!this._object_store)return void console.debug("Force cleaning up 0 sessions");let e=0;const t=[];for(const n in this._object_store)if(!["services","message_cache"].includes(n)){const r=this._object_store[n];r&&"object"==typeof r&&Object.keys(r).length>0&&(t.push(n),e++)}for(const e of t)delete this._object_store[e];this._targetIdIndex={},console.debug(`Force cleaning up ${e} sessions`)}_sweepStaleSessions(){const e=Date.now();let t=0;for(const n of Object.keys(this._object_store)){if("services"===n||"message_cache"===n)continue;const r=this._object_store[n],o=r&&(r._last_activity_at||r._created_at);if(r&&"object"==typeof r&&o&&e-o>this._sessionMaxAge&&(!r.timer||!r.timer.started)){if("function"==typeof r.resolve||"function"==typeof r.reject)continue;this._removeFromTargetIdIndex(n),r.heartbeat_task&&clearInterval(r.heartbeat_task),delete this._object_store[n],t++}}t>0&&console.debug(`Swept ${t} stale session(s)`)}_is_promise_method_call(e){const t=e.split(".")[0],n=this._get_session_store(t,!1);return n&&n._promise_manager}_create_promise_manager(){return{should_cleanup_on_callback:e=>["resolve","reject"].includes(e),settle:()=>{console.debug("Promise settled")}}}async _encode_promise(e,t,n,r,o,i,s){let c=this._get_session_store(n,!0);c||(console.warn(`Failed to create session store ${n}, session management may be impaired`),c={}),c._promise_manager=this._create_promise_manager();let a={};return o&&t&&this._method_timeout?([a.heartbeat,c.heartbeat]=this._encode_callback("heartbeat",o.reset.bind(o),n,!1,null,i),c.timer=o,a.interval=this._method_timeout/2):o=null,[a.resolve,c.resolve]=this._encode_callback("resolve",e,n,r,o,i,`resolve (${s})`),[a.reject,c.reject]=this._encode_callback("reject",t,n,r,o,i,`reject (${s})`),a}async _send_chunks(e,t,n){const o=await this.get_remote_service(`${t}:built-in`);if(!o.message_cache)throw new Error("Remote client does not support message caching for large messages.");const i=o.message_cache,s=n||(0,r.bq)(),c=e.length,a=Date.now(),_=Math.ceil(c/this._long_message_chunk_size);if(o.config.api_version>=3){await i.create(s,!!n);const t=new r.jf(30),o=[];for(let r=0;r<_;r++){const c=r*this._long_message_chunk_size,a=e.slice(c,c+this._long_message_chunk_size),_=async()=>{await i.set(s,r,a,!!n)};o.push(t.run(_))}try{await Promise.all(o)}catch(e){try{await i.remove(s)}catch(e){console.error(`Failed to clean up message cache after error: ${e}`)}throw e}}else{await i.create(s,!!n);for(let t=0;t<_;t++){const r=t*this._long_message_chunk_size,o=e.slice(r,r+this._long_message_chunk_size);await i.append(s,o,!!n)}}await i.process(s,!!n),((Date.now()-a)/1e3).toFixed(2)}emit(e,t){if((0,r.vA)("object"==typeof e&&e.type,"Invalid message, must be an object with a `type` fields."),!e.to)return void this._fire(e.type,e);let n=(0,s.l)(e);if(t){const e=(0,s.l)(t),r=new Uint8Array(n.length+e.length);r.set(n),r.set(e,n.length),n=r}const o=n.length;return o>this._long_message_chunk_size+1024&&console.warn(`Sending large message (size=${o})`),this._emit_message(n)}_generate_remote_method(e,t,n,o,i){let c=e._rtarget;o&&!c.includes("/")&&(c.startsWith("*/")||(o!==c&&(c=o+"/"+c),e._rtarget=c));let a=e._rmethod,_=e._rpromise||!1;const l=`method: ${a}, docs: ${e._rdoc}`,h=this;function d(){return new Promise((async(e,o)=>{try{let u=(0,r.bq)();n&&(u=n+"."+u);let p=h._get_session_store(u,!0);if(!p)return void o(new Error(`Runtime Error: Failed to get session store ${u} (context: ${l})`));p.target_id=c;const f=u.split(".")[0];c in h._targetIdIndex||(h._targetIdIndex[c]=new Set),h._targetIdIndex[c].add(f);const m=await h._encode(Array.prototype.slice.call(arguments),u,i),g=m.length,w=g>0&&"object"==typeof m[g-1]&&null!==m[g-1]&&m[g-1]._rkwargs;let v;w&&delete m[g-1]._rkwargs,v=h._local_workspace?h._local_workspace+"/"+h._client_id:h._client_id;let b={type:"method",from:v,to:c,method:a},k={};m&&(k.args=m),w&&(k.with_kwargs=w),t&&(b.parent=t);let E=null;if(_){b.session=u;let t=`${c}:${a}`;const n=function(e){o(new Error(e)),h._object_store[u]&&(h._removeFromTargetIdIndex(u),delete h._object_store[u],console.debug(`Cleaned up session ${u} after timeout`))};E=new y(h._method_timeout,n,[`Method call timed out: ${t}, context: ${l}`],t);let r=!0;const s=await h._encode_promise(e,o,u,r,E,i,l);if(!0===_)k.promise=s;else{if("*"!==_)throw new Error(`Unsupported promise type: ${_}`);k.promise="*",k.t=h._method_timeout/2}}let j=(0,s.l)(b);if(k){const e=(0,s.l)(k),t=new Uint8Array(j.length+e.length);t.set(j),t.set(e,j.length),j=t}j.length<=h._long_message_chunk_size+1024||d.__no_chunk__?h._emit_message(j).then((function(){E&&E.start(),_||e(null)})).catch((function(e){const t=`Failed to send the request when calling method (${c}:${a}), error: ${e}`;o?o(new Error(t)):console.warn("Unhandled RPC method call error:",t),E&&E.started&&E.clear()})):h._send_chunks(j,c,t).then((function(){E&&E.start(),_||e(null)})).catch((function(e){const t=`Failed to send the request when calling method (${c}:${a}), error: ${e}`;o?o(new Error(t)):console.warn("Unhandled RPC method call error:",t),E&&E.started&&E.clear()}))}catch(e){o(e)}}))}d.__rpc_object__=e;const u=a.split(".");return d.__name__=e._rname||u[u.length-1],d.__name__.includes("#")&&(d.__name__=d.__name__.split("#")[1]),d.__doc__=e._rdoc||`Remote method: ${a}`,d.__schema__=e._rschema,d.__no_chunk__="services.built-in.message_cache.append"===e._rmethod,d}get_client_info(){const e=[];for(let t of Object.values(this._services))e.push(this._extract_service_info(t));return{id:this._client_id,services:e}}async _handle_method(e){let t=null,n=null,o=null;try{(0,r.vA)(e.method&&e.ctx&&e.from);const i=e.from+":"+e.method,s=e.from.split("/")[0],c=e.from.split("/")[1];let a;e.to=e.to.includes("/")?e.to:s+"/"+e.to,e.ctx.to=e.to,this._local_workspace?(this._local_workspace&&"*"!==this._local_workspace&&(0,r.vA)(e.to.split("/")[0]===this._local_workspace,"Workspace mismatch: "+e.to.split("/")[0]+" != "+this._local_workspace),a=this._local_workspace):a=e.to.split("/")[0];const _=e.parent;if(e.promise){const d=await this._decode("*"===e.promise?this._expand_promise(e):e.promise,e.session,_,s,a);if(t=d.resolve,n=d.reject,d.heartbeat&&d.interval){async function u(){try{await d.heartbeat()}catch(e){console.error(e)}}if(o=setInterval(u,1e3*d.interval),e.session){const f=this._get_session_store(e.session,!1);f&&(f.heartbeat_task=o)}}}let l,h;try{l=p(this._object_store,e.method);const y=e.method.split(".");if(y.length>1){const m=y[0];if("services"!==m&&"message_cache"!==m){const g=this._object_store[m];g&&"object"==typeof g&&(g._last_activity_at=Date.now())}}}catch(w){if(this._is_promise_method_call(e.method))return void console.debug(`Promise method ${e.method} not available (detected by session type), ignoring: ${i}`);const v=e.method.split(".");if(v.length>1){const k=v[0];return k in this._object_store?(console.debug(`Session ${k} exists but method ${e.method} not found, likely expired callback: ${i}`),void("function"==typeof n&&n(new Error(`Method expired or not found: ${i}`)))):(console.debug(`Session ${k} not found for method ${e.method}, likely cleaned up: ${i}`),void("function"==typeof n&&n(new Error(`Session not found: ${i}`))))}console.debug(`Failed to find method ${i} at ${this._client_id}`);const b=new Error(`Method not found: ${i} at ${this._client_id}`);return void("function"==typeof n?n(b):console.warn("Method not found and no reject callback:",b.message))}if((0,r.vA)(l&&"function"==typeof l,"Invalid method: "+i),this._method_annotations.has(l)){if("protected"===this._method_annotations.get(l).visibility)if(a===s);else if(this._method_annotations.get(l).authorized_workspaces&&this._method_annotations.get(l).authorized_workspaces.includes(s));else if("*"!==s||c!==this._connection.manager_id)throw new Error("Permission denied for invoking protected method "+i+", workspace mismatch: "+a+" != "+s)}else{let E=this._object_store[e.method.split(".")[0]].target_id;if(a===s&&E&&-1===E.indexOf("/")&&(E=a+"/"+E),E!==e.from)throw new Error("Access denied for method call ("+i+") from "+e.from+" to target "+E)}if(_&&!e.method.startsWith("services.")&&(0,r.vA)(null!==this._get_session_store(_,!0),"Parent session was closed: "+_),h=e.args?await this._decode(e.args,e.session,null,s,null):[],this._method_annotations.has(l)&&this._method_annotations.get(l).require_context){if(h.length+1<l.length)for(let j=h.length;j<l.length-1;j++)h.push(void 0);h.push(e.ctx)}if(e.promise){const S=l.apply(null,h);S instanceof Promise?S.then((e=>{t(e)})).catch((e=>{n(e)})).finally((()=>{clearInterval(o)})):(t(S),clearInterval(o))}else l.apply(null,h),clearInterval(o)}catch(A){n?n(A):console.error("Error during calling method: ",A),clearInterval(o)}}encode(e,t){return this._encode(e,t)}_get_session_store(e,t){if(!e)return null;let n=this._object_store;const r=e.split(".");if(t){const e=r.length-1;for(let t of r.slice(0,e))n[t]||(n[t]={}),n=n[t];if(!n[r[e]]){n[r[e]]={};const t=Date.now();n[r[e]]._created_at=t,n[r[e]]._last_activity_at=t}return n[r[e]]}for(let e of r){if(!n[e])return null;n=n[e]}return n}async _encode(e,t,n){const o=typeof e;if("number"===o||"string"===o||"boolean"===o||null==e||e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return{_rtype:"memoryview",_rvalue:new Uint8Array(e)};if(e.__rpc_object__&&(e.__rpc_object__._rserver||this._server_base_url)===this._server_base_url)return e.__rpc_object__;let i;if(e.constructor instanceof Object&&e._rtype){const c=e._rtype;return delete e._rtype,i=await this._encode(e,t,n),i._rtype=c,i}if((0,r.WH)(e)||(0,r.aU)(e)||(0,r.P5)(e)||(0,r.M3)(e)){(0,r.vA)(t&&"string"==typeof t,"Session ID is required for generator encoding");const _=(0,r.bq)(),d=_+":close",u=this._get_session_store(t,!0);(0,r.vA)(null!==u,`Failed to create session store ${t} due to invalid parent`);const p=(0,r.aU)(e)||(0,r.P5)(e),f=async()=>{if(p){const t=await e.next();return t.done?(delete u[_],delete u[d],{_rtype:"stop_iteration"}):t.value}{const t=e.next();return t.done?(delete u[_],delete u[d],{_rtype:"stop_iteration"}):t.value}},y=async()=>{try{"function"==typeof e.return&&(p?await e.return():e.return())}catch(e){}finally{delete u[_],delete u[d]}return!0};return u[_]=f,u[d]=y,i={_rtype:"generator",_rserver:this._server_base_url,_rtarget:this._client_id,_rmethod:`${t}.${_}`,_rclose_method:`${t}.${d}`,_rpromise:"*",_rdoc:"Remote generator"},i}if("function"==typeof e){if(this._method_annotations.has(e)){let g=this._method_annotations.get(e);i={_rtype:"method",_rserver:this._server_base_url,_rtarget:this._client_id,_rmethod:g.method_id,_rpromise:"*",_rname:e.name}}else{let w;(0,r.vA)("string"==typeof t),w=e.__name__?`${(0,r.bq)()}#${e.__name__}`:(0,r.bq)(),i={_rtype:"method",_rserver:this._server_base_url,_rtarget:this._client_id,_rmethod:`${t}.${w}`,_rpromise:"*",_rname:e.name};let v=this._get_session_store(t,!0);(0,r.vA)(null!==v,`Failed to create session store ${t} due to invalid parent`),v[w]=e}if(i._rdoc=e.__doc__,!i._rdoc)try{const b=function(e){const t=e.toString(),n=t.match(/function\s*(\w*)/),r=n&&n[1]||"",o=t.match(/\(([^)]*)\)/);let i="";o&&(i=o[1].split(",").map((e=>e.replace(/\/\*.*?\*\//g,"").replace(/\/\/.*$/g,""))).filter((e=>e.trim().length>0)).map((e=>e.trim())).join(", "));let s=t.match(/\)\s*\{\s*\/\*([\s\S]*?)\*\//);const c=s&&s[1].trim()||"";s=t.match(/\)\s*\{\s*(\/\/[\s\S]*?)\n\s*[^\s\/]/);const a=s&&s[1].split("\n").map((e=>e.replace(/^\/\/\s*/,"").trim())).join("\n")||"",_=c||a;return r&&i.length>0&&{name:r,sig:i,doc:_}}(e);b&&!i._rdoc&&(i._rdoc=`${b.doc}`)}catch(k){console.error("Failed to extract function docstring:",e)}return i._rschema=e.__schema__,i}const s=Array.isArray(e);for(let E of Object.keys(this._codecs)){const j=this._codecs[E];if(j.encoder&&e instanceof j.type){let S=await Promise.resolve(j.encoder(e));if(S&&!S._rtype&&(S._rtype=j.name),"object"==typeof S){const A=S._rtype;delete S._rtype,S=await this._encode(S,t,n),S._rtype=A}return i=S,i}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const x=e.dataSync();i={_rtype:"ndarray",_rvalue:new Uint8Array(x.buffer),_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){if(!e.selection||!e.selection.data)throw new Error("Invalid NumJS array: missing selection or data");const $=(0,r.D4)(e.selection.data);i={_rtype:"ndarray",_rvalue:new Uint8Array(e.selection.data.buffer),_rshape:e.shape,_rdtype:$}}else if(e instanceof Error)console.error(e),i={_rtype:"error",_rvalue:e.toString(),_rtrace:e.stack};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||"undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)i=e;else if(e instanceof Blob){let T=0;async function U(t){let n;n=t?e.slice(T,T+t):e.slice(T);const r=new Uint8Array(await n.arrayBuffer());return T+=r.byteLength,r}function C(e){T=e}i={_rtype:"iostream",_rnative:"js:blob",type:e.type,name:e.name,size:e.size,path:e._path||e.webkitRelativePath,read:await this._encode(U,t,n),seek:await this._encode(C,t,n)}}else if(e instanceof a){const O=(0,r.D4)(e);i={_rtype:"typedarray",_rvalue:new Uint8Array(e.buffer),_rdtype:O}}else if(e instanceof DataView)i={_rtype:"memoryview",_rvalue:new Uint8Array(e.buffer)};else if(e instanceof Set)i={_rtype:"set",_rvalue:await this._encode(Array.from(e),t,n)};else if(e instanceof Map)i={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t,n)};else{if(!(e.constructor===Object||Array.isArray(e)||e instanceof m))throw`hypha-rpc: Unsupported data type: ${e}, you can register a custom codec to encode/decode the object.`;{if(!s&&!0===e._rintf&&Object.keys(e).some((t=>!t.startsWith("_")&&"function"==typeof e[t]))){const P=`_rintf_${(0,r.bq)()}`,D={id:P};for(const M of Object.keys(e))M.startsWith("_")||"function"!=typeof e[M]||(D[M]=e[M]);this.add_service(D,!0),e._rintf_service_id=P,i={};for(const R of Object.keys(e))i[R]=await this._encode(e[R],t,n);return i._rintf_service_id=P,i}if(s){if(l(e))return e}else if(!("_rtype"in e||e instanceof m)&&h(e))return e;i=s?[]:{};const I=Object.keys(e);for(let W of I)i[W]=await this._encode(e[W],t,n)}}if(!i)throw new Error("Failed to encode object");return i}async decode(e){return await this._decode(e)}async _decode(e,t,n,o,i){if(!e)return e;let s;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){const c=e._rtype;delete e._rtype,(e=await this._decode(e,t,n,o,i))._rtype=c,s=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("method"===e._rtype)s=this._generate_remote_method(e,t,n,o,i);else if("generator"===e._rtype){const a=this._generate_remote_method(e,t,n,o,i);let _=null;if(e._rclose_method){const p={_rtype:"method",_rserver:e._rserver,_rtarget:e._rtarget,_rmethod:e._rclose_method,_rpromise:"*"};_=this._generate_remote_method(p,t,n,o,i)}async function*u(){let e=!1;try{for(;;){const t=await a();if(t&&"stop_iteration"===t._rtype){e=!0;break}yield t}}catch(e){throw console.error("Error in generator:",e),e}finally{if(!e&&_)try{await _()}catch(e){}}}s=u()}else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(d)),s=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(d));const f=r.RR[e._rdtype];s=tf.tensor(new f(e._rvalue),e._rshape,e._rdtype)}else s=e;else if("error"===e._rtype)s=new Error("RemoteError: "+e._rvalue+"\n"+(e._rtrace||""));else if("typedarray"===e._rtype){const y=r.RR[e._rdtype];if(!y)throw new Error("unsupported dtype: "+e._rdtype);s=new y(e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength))}else if("memoryview"===e._rtype)s=e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength);else if("iostream"===e._rtype){if("js:blob"===e._rnative){const m=await this._generate_remote_method(e.read,t,n,o,i),g=await m();s=new Blob([g],{type:e.type,name:e.name})}else{s={};for(let w of Object.keys(e))w.startsWith("_")||(s[w]=await this._decode(e[w],t,n,o,i))}s.__rpc_object__=e}else if("orderedmap"===e._rtype)s=new Map(await this._decode(e._rvalue,t,n,o,i));else if("set"===e._rtype)s=new Set(await this._decode(e._rvalue,t,n,o,i));else{const v=e._rtype;delete e._rtype,s=await this._decode(e,t,n,o,i),s._rtype=v}else if(e.constructor===Object||Array.isArray(e)){const b=Array.isArray(e);if(b){if(l(e))return e}else if(h(e))return e;s=b?[]:{};for(let k of Object.keys(e))if(b||e.hasOwnProperty(k)){const E=e[k];s[k]=await this._decode(E,t,n,o,i)}}else s=e;if(void 0===s)throw new Error("Failed to decode object");return s}_expand_promise(e){return{heartbeat:{_rtype:"method",_rtarget:e.from.split("/")[1],_rmethod:e.session+".heartbeat",_rdoc:`heartbeat callback for method: ${e.method}`},resolve:{_rtype:"method",_rtarget:e.from.split("/")[1],_rmethod:e.session+".resolve",_rdoc:`resolve callback for method: ${e.method}`},reject:{_rtype:"method",_rtarget:e.from.split("/")[1],_rmethod:e.session+".reject",_rdoc:`reject callback for method: ${e.method}`},interval:e.t}}}},878:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}function toCamelCase(e){return e.includes("_")?e.replace(/_./g,(e=>e[1].toUpperCase())):e}function toSnakeCase(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase()}function expandKwargs(e){if("object"!=typeof e||null===e)return e;const t=Array.isArray(e)?[]:{};for(const n in e)if(e.hasOwnProperty(n)){const r=e[n];"function"==typeof r?(t[n]=(...e)=>{if(0===e.length)throw new Error(`Function "${n}" expects at least one argument.`);const t=e[e.length-1];let o={};return"object"!=typeof t||null===t||Array.isArray(t)||(o={...t,_rkwarg:!0},e=e.slice(0,-1)),r(...e,o)},t[n].__name__=n,r.__schema__&&(t[n].__schema__={...r.__schema__},t[n].__schema__.name=n)):t[n]=expandKwargs(r)}return t}function convertCase(e,t){if("object"!=typeof e||null===e||!t)return e;const n=Array.isArray(e)?[]:{};for(const r in e)if(e.hasOwnProperty(r)){const o=e[r],i=toCamelCase(r),s=toSnakeCase(r);"camel"===t?(n[i]=convertCase(o,t),"function"==typeof o&&(n[i].__name__=i,o.__schema__&&(n[i].__schema__={...o.__schema__},n[i].__schema__.name=i))):"snake"===t?(n[s]=convertCase(o,t),"function"==typeof o&&(n[s].__name__=s,o.__schema__&&(n[s].__schema__={...o.__schema__},n[s].__schema__.name=s))):(t.includes("camel")&&(n[i]=convertCase(o,"camel")),t.includes("snake")&&(n[s]=convertCase(o,"snake")))}return n}function parseServiceUrl(e){e=e.replace(/\/$/,"");const t=new RegExp("^(https?:\\/\\/[^/]+)\\/([a-z0-9_-]+)\\/services\\/(?:(?<clientId>[a-zA-Z0-9_-]+):)?(?<serviceId>[a-zA-Z0-9_-]+)(?:@(?<appId>[a-zA-Z0-9_-]+))?"),n=e.match(t);if(!n)throw new Error("URL does not match the expected pattern");const r=n[1],o=n[2],i=n.groups?.clientId||"*",s=n.groups?.serviceId;return{serverUrl:r,workspace:o,clientId:i,serviceId:s,appId:n.groups?.appId||"*"}}__webpack_require__.d(__webpack_exports__,{D4:()=>typedArrayToDtype,M3:()=>isSyncIterator,P5:()=>isAsyncIterator,RR:()=>dtypeToTypedArray,V0:()=>loadRequirements,WH:()=>isGenerator,aU:()=>isAsyncGenerator,bq:()=>randId,fm:()=>waitFor,gX:()=>convertCase,iO:()=>parseServiceUrl,jf:()=>Semaphore,sw:()=>MessageEmitter,uX:()=>expandKwargs,vA:()=>assert});const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var o=0;o<e.length;o++)e[o].toLowerCase().endsWith(".css")||e[o].startsWith("css:")?(e[o].startsWith("css:")&&(e[o]=e[o].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[o],document.head.appendChild(r)):e[o].toLowerCase().endsWith(".mjs")||e[o].startsWith("mjs:")?(e[o].startsWith("mjs:")&&(e[o]=e[o].slice(4)),await new Function("url","return import(url)")(e[o])):e[o].toLowerCase().endsWith(".js")||e[o].startsWith("js:")?(e[o].startsWith("js:")&&(e[o]=e[o].slice(3)),await n(e[o])):e[o].startsWith("http")?await n(e[o]):e[o].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[o])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const o=new MessageChannel;o.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[o.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}function waitFor(e,t,n){let r;return Promise.race([e,new Promise(((e,o)=>r=setTimeout((()=>{o(n||"Timeout Error")}),1e3*t)))]).finally((()=>clearTimeout(r)))}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}waitFor(e,t){return new Promise(((n,r)=>{const o=e=>{clearTimeout(i),n(e)};this.once(e,o);const i=setTimeout((()=>{this.off(e,o),r(new Error("Timeout"))}),1e3*t)}))}}class Semaphore{constructor(e){this.max=e,this.queue=[],this.current=0}async run(e){this.current>=this.max&&await new Promise((e=>this.queue.push(e))),this.current++;try{return await e()}finally{this.current--,this.queue.length>0&&this.queue.shift()()}}}function isGenerator(e){return!!e&&"object"==typeof e&&"function"==typeof e.next&&"function"==typeof e.throw&&"function"==typeof e.return}function isAsyncGenerator(e){return!!e&&"object"==typeof e&&"function"==typeof e.next&&"function"==typeof e.throw&&"function"==typeof e.return&&Symbol.asyncIterator in Object(e)&&"AsyncGenerator"===e[Symbol.toStringTag]}function isAsyncIterator(e){return!(!e||isAsyncGenerator(e))&&"object"==typeof e&&Symbol.asyncIterator in Object(e)&&"function"==typeof e.next}function isSyncIterator(e){return!(!e||isGenerator(e))&&"object"==typeof e&&Symbol.iterator in Object(e)&&"function"==typeof e.next&&!Array.isArray(e)&&"string"!=typeof e}},287:(e,t,n)=>{n.d(t,{G:()=>i});var r=n(878);const o={object:e=>({type:"object",properties:e,required:Object.keys(e).filter((t=>!e[t]._optional))}),string:()=>({type:"string",_optional:!1}),number:()=>({type:"number",_optional:!1}),integer:()=>({type:"integer",_optional:!1}),boolean:()=>({type:"boolean",_optional:!1}),array:e=>({type:"array",items:e,_optional:!1}),optional:e=>({...e,_optional:!0})};function i(e,{schema_type:t="auto",name:n=null,description:o=null,parameters:i=null}){if(!e||"function"!=typeof e)throw Error("func should be a function");(0,r.vA)("auto"===t,"schema_type should be auto");const s=n||e.name;(0,r.vA)(s,"name should not be null");let c=i;if(i&&"object"==typeof i&&"object"===i.type){c={type:"object",properties:i.properties||{},required:i.required||[]};for(const[e,t]of Object.entries(c.properties))void 0!==t._optional&&delete t._optional}return(0,r.vA)(c&&"object"===c.type,"parameters should be an object schema"),e.__schema__={name:s,description:o||"",parameters:c},e}["string","number","integer","boolean","array"].forEach((e=>{o[e]=()=>{const t={type:"integer"===e?"integer":e,_optional:!1,describe:e=>({...t,description:e})};return t}}))},831:(e,t,n)=>{n.d(t,{b:()=>a,e:()=>_});var r=n(887),o=n(878),i=n(287);class s{constructor(e){this._data_channel=e,this._handle_message=null,this._reconnection_token=null,this._handle_disconnected=null,this._handle_connected=()=>{},this.manager_id=null,this._data_channel.onopen=async()=>{this._handle_connected&&this._handle_connected({channel:this._data_channel})},this._data_channel.onmessage=async e=>{let t=e.data;t instanceof Blob&&(t=await t.arrayBuffer()),this._handle_message&&this._handle_message(t)},this._data_channel.onclose=()=>{this._handle_disconnected&&this._handle_disconnected("closed"),console.log("data channel closed"),this._data_channel=null}}on_disconnected(e){this._handle_disconnected=e}on_connected(e){this._handle_connected=e}on_message(e){(0,o.vA)(e,"handler is required"),this._handle_message=e}async emit_message(e){(0,o.vA)(this._handle_message,"No handler for message");try{this._data_channel.send(e)}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}async disconnect(e){this._data_channel=null,console.info(`data channel connection disconnected (${e})`)}}async function c(e){(0,o.vA)(e.channel,"No channel provided"),(0,o.vA)(e.workspace,"No workspace provided");const t=e.channel,n=e.client_id||(0,o.bq)(),i=new s(t);return e.context=e.context||{},e.context.connection_type="webrtc",e.context.ws=e.workspace,new r.y(i,{client_id:n,default_context:e.context,name:e.name,method_timeout:e.method_timeout||10,workspace:e.workspace,app_id:e.app_id,long_message_chunk_size:e.long_message_chunk_size})}async function a(e,t,n){(n=n||{}).peer_id=n.peer_id||(0,o.bq)();const r=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});return new Promise((async(s,a)=>{let _=!1;const l=setTimeout((()=>{_||(_=!0,r.close(),a(new Error("WebRTC Connection timeout")))}),3e4);try{r.addEventListener("connectionstatechange",(()=>{console.log("WebRTC Connection state: ",r.connectionState),"failed"===r.connectionState?_||(_=!0,clearTimeout(l),r.close(),a(new Error("WebRTC Connection failed"))):"closed"===r.connectionState?_||(_=!0,clearTimeout(l),a(new Error("WebRTC Connection closed"))):"connected"===r.connectionState&&console.log("WebRTC Connection established successfully")}),!1),r.addEventListener("iceconnectionstatechange",(()=>{console.log("ICE Connection state: ",r.iceConnectionState),"failed"===r.iceConnectionState&&(_||(_=!0,clearTimeout(l),r.close(),a(new Error("ICE Connection failed"))))})),n.on_init&&(await n.on_init(r),delete n.on_init);let h=r.createDataChannel(n.peer_id,{ordered:!0});h.binaryType="arraybuffer";const d=await r.createOffer();await r.setLocalDescription(d),await new Promise((e=>{"complete"===r.iceGatheringState?e():(r.addEventListener("icegatheringstatechange",(()=>{"complete"===r.iceGatheringState&&e()})),setTimeout(e,5e3))}));const u=await e.getService(t),p=await u.offer({sdp:r.localDescription.sdp,type:r.localDescription.type});h.onopen=()=>{n.channel=h,n.workspace=p.workspace,setTimeout((async()=>{if(!_)try{const e=await c(n);async function t(t,...r){return(0,o.vA)(!t.includes(":"),"WebRTC service name should not contain ':'"),(0,o.vA)(!t.includes("/"),"WebRTC service name should not contain '/'"),await e.get_remote_service(n.workspace+"/"+n.peer_id+":"+t,...r)}async function h(){await e.disconnect(),r.close()}r.rpc=e,r.getService=(0,i.G)(t,{name:"getService",description:"Get a remote service via webrtc",parameters:{type:"object",properties:{service_id:{type:"string",description:"Service ID. This should be a service id in the format: 'workspace/service_id', 'workspace/client_id:service_id' or 'workspace/client_id:service_id@app_id'"},config:{type:"object",description:"Options for the service"}},required:["id"]}}),r.disconnect=(0,i.G)(h,{name:"disconnect",description:"Disconnect from the webrtc connection via webrtc",parameters:{type:"object",properties:{}}}),r.registerCodec=(0,i.G)(e.register_codec,{name:"registerCodec",description:"Register a codec for the webrtc connection",parameters:{type:"object",properties:{codec:{type:"object",description:"Codec to register",properties:{name:{type:"string"},type:{},encoder:{type:"function"},decoder:{type:"function"}}}}}}),_=!0,clearTimeout(l),s(r)}catch(d){_||(_=!0,clearTimeout(l),a(d))}}),1e3)},h.onclose=()=>{_||(_=!0,clearTimeout(l),a(new Error("Data channel closed")))},h.onerror=e=>{_||(_=!0,clearTimeout(l),a(new Error(`Data channel error: ${e}`)))},await r.setRemoteDescription(new RTCSessionDescription({sdp:p.sdp,type:p.type}))}catch(e){_||(_=!0,clearTimeout(l),a(e))}}))}async function _(e,t,n){const r=(n=n||{visibility:"protected",require_context:!0}).on_init;return delete n.on_init,await e.registerService({id:t,config:n,offer:(t,o)=>async function(e,t,n,r,o){n=n||{};let i=new RTCSessionDescription({sdp:e.sdp,type:e.type}),s=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});t&&s.addEventListener("datachannel",(async e=>{const n=e.channel;let r=null;o&&o.user&&(r={user:o.user,ws:o.ws}),(await c({channel:n,client_id:n.label,workspace:t.config.workspace,context:r}))._services=t.rpc._services})),r&&await r(s),await s.setRemoteDescription(i);let a=await s.createAnswer();return await s.setLocalDescription(a),await new Promise((e=>{"complete"===s.iceGatheringState?e():(s.addEventListener("icegatheringstatechange",(()=>{"complete"===s.iceGatheringState&&e()})),setTimeout(e,5e3))})),{sdp:s.localDescription.sdp,type:s.localDescription.type,workspace:t.config.workspace}}(t,e,n,r,o)})}},448:(e,t,n)=>{n.d(t,{X:()=>i});var r,o=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=function(e){function t(n){var r=e.call(this,n)||this,o=Object.create(t.prototype);return Object.setPrototypeOf(r,o),Object.defineProperty(r,"name",{configurable:!0,enumerable:!1,value:t.name}),r}return o(t,e),t}(Error)},656:(e,t,n)=>{n.d(t,{g:()=>c});var r=function(e,t){this.type=e,this.data=t},o=n(448),i=n(989),s={type:-1,encode:function(e){var t,n,r,o;return e instanceof Date?function(e){var t,n=e.sec,r=e.nsec;if(n>=0&&r>=0&&n<=17179869183){if(0===r&&n<=4294967295){var o=new Uint8Array(4);return(t=new DataView(o.buffer)).setUint32(0,n),o}var s=n/4294967296,c=4294967295&n;return o=new Uint8Array(8),(t=new DataView(o.buffer)).setUint32(0,r<<2|3&s),t.setUint32(4,c),o}return o=new Uint8Array(12),(t=new DataView(o.buffer)).setUint32(0,r),(0,i._j)(t,4,n),o}((r=1e6*((t=e.getTime())-1e3*(n=Math.floor(t/1e3))),{sec:n+(o=Math.floor(r/1e9)),nsec:r-1e9*o})):null},decode:function(e){var t=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:4294967296*(3&n)+t.getUint32(4),nsec:n>>>2};case 12:return{sec:(0,i.eN)(t,4),nsec:t.getUint32(0)};default:throw new o.X("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(e.length))}}(e);return new Date(1e3*t.sec+t.nsec/1e6)}},c=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(s)}return e.prototype.register=function(e){var t=e.type,n=e.encode,r=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=r;else{var o=1+t;this.builtInEncoders[o]=n,this.builtInDecoders[o]=r}},e.prototype.tryToEncode=function(e,t){for(var n=0;n<this.builtInEncoders.length;n++)if(null!=(o=this.builtInEncoders[n])&&null!=(i=o(e,t)))return new r(-1-n,i);for(n=0;n<this.encoders.length;n++){var o,i;if(null!=(o=this.encoders[n])&&null!=(i=o(e,t)))return new r(n,i)}return e instanceof r?e:null},e.prototype.decode=function(e,t,n){var o=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return o?o(e,t,n):new r(t,e)},e.defaultCodec=new e,e}()},290:(e,t,n)=>{function r(e){return"".concat(e<0?"-":"","0x").concat(Math.abs(e).toString(16).padStart(2,"0"))}n.d(t,{D4:()=>v,UN:()=>b});var o=n(656),i=n(989),s=n(579),c=n(876),a=function(){function e(e,t){void 0===e&&(e=16),void 0===t&&(t=16),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var n=0;n<this.maxKeyLength;n++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,n){e:for(var r=0,o=this.caches[n-1];r<o.length;r++){for(var i=o[r],s=i.bytes,c=0;c<n;c++)if(s[c]!==e[t+c])continue e;return i.str}return null},e.prototype.store=function(e,t){var n=this.caches[e.length-1],r={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=r:n.push(r)},e.prototype.decode=function(e,t,n){var r=this.find(e,t,n);if(null!=r)return this.hit++,r;this.miss++;var o=(0,s.Zf)(e,t,n),i=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(i,o),o},e}(),_=n(448),l=function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},h=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,o){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,o,(t=e[n](t)).done,t.value)}))}}},d=function(e){return this instanceof d?(this.v=e,this):new d(e)},u=new DataView(new ArrayBuffer(0)),p=new Uint8Array(u.buffer),f=function(){try{u.getInt8(0)}catch(e){return e.constructor}throw new Error("never reached")}(),y=new f("Insufficient data"),m=new a,g=function(){function e(e,t,n,r,s,c,a,_){void 0===e&&(e=o.g.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=i.f7),void 0===r&&(r=i.f7),void 0===s&&(s=i.f7),void 0===c&&(c=i.f7),void 0===a&&(a=i.f7),void 0===_&&(_=m),this.extensionCodec=e,this.context=t,this.maxStrLength=n,this.maxBinLength=r,this.maxArrayLength=s,this.maxMapLength=c,this.maxExtLength=a,this.keyDecoder=_,this.totalPos=0,this.pos=0,this.view=u,this.bytes=p,this.headByte=-1,this.stack=[]}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=(0,c.C)(e),this.view=(0,c.o)(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=(0,c.C)(e),r=new Uint8Array(t.length+n.length);r.set(t),r.set(n,t.length),this.setBuffer(r)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,n=this.pos;return new RangeError("Extra ".concat(t.byteLength-n," of ").concat(t.byteLength," byte(s) found at buffer[").concat(e,"]"))},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return l(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,n,o,i,s,c,a,_;return s=this,c=void 0,_=function(){var s,c,a,_,d,u,p,y;return l(this,(function(l){switch(l.label){case 0:s=!1,l.label=1;case 1:l.trys.push([1,6,7,12]),t=h(e),l.label=2;case 2:return[4,t.next()];case 3:if((n=l.sent()).done)return[3,5];if(a=n.value,s)throw this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{c=this.doDecodeSync(),s=!0}catch(e){if(!(e instanceof f))throw e}this.totalPos+=this.pos,l.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return _=l.sent(),o={error:_},[3,12];case 7:return l.trys.push([7,,10,11]),n&&!n.done&&(i=t.return)?[4,i.call(t)]:[3,9];case 8:l.sent(),l.label=9;case 9:return[3,11];case 10:if(o)throw o.error;return[7];case 11:return[7];case 12:if(s){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,c]}throw u=(d=this).headByte,p=d.pos,y=d.totalPos,new RangeError("Insufficient data in parsing ".concat(r(u)," at ").concat(y," (").concat(p," in the current buffer)"))}}))},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{o(_.next(e))}catch(e){t(e)}}function r(e){try{o(_.throw(e))}catch(e){t(e)}}function o(t){var o;t.done?e(t.value):(o=t.value,o instanceof a?o:new a((function(e){e(o)}))).then(n,r)}o((_=_.apply(s,c||[])).next())}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,o=n.apply(e,t||[]),i=[];return r={},s("next"),s("throw"),s("return"),r[Symbol.asyncIterator]=function(){return this},r;function s(e){o[e]&&(r[e]=function(t){return new Promise((function(n,r){i.push([e,t,n,r])>1||c(e,t)}))})}function c(e,t){try{(n=o[e](t)).value instanceof d?Promise.resolve(n.value.v).then(a,_):l(i[0][2],n)}catch(e){l(i[0][3],e)}var n}function a(e){c("next",e)}function _(e){c("throw",e)}function l(e,t){e(t),i.shift(),i.length&&c(i[0][0],i[0][1])}}(this,arguments,(function(){var n,r,o,i,s,c,a,_,u;return l(this,(function(l){switch(l.label){case 0:n=t,r=-1,l.label=1;case 1:l.trys.push([1,13,14,19]),o=h(e),l.label=2;case 2:return[4,d(o.next())];case 3:if((i=l.sent()).done)return[3,12];if(s=i.value,t&&0===r)throw this.createExtraByteError(this.totalPos);this.appendBuffer(s),n&&(r=this.readArraySize(),n=!1,this.complete()),l.label=4;case 4:l.trys.push([4,9,,10]),l.label=5;case 5:return[4,d(this.doDecodeSync())];case 6:return[4,l.sent()];case 7:return l.sent(),0==--r?[3,8]:[3,5];case 8:return[3,10];case 9:if(!((c=l.sent())instanceof f))throw c;return[3,10];case 10:this.totalPos+=this.pos,l.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return a=l.sent(),_={error:a},[3,19];case 14:return l.trys.push([14,,17,18]),i&&!i.done&&(u=o.return)?[4,d(u.call(o))]:[3,16];case 15:l.sent(),l.label=16;case 16:return[3,18];case 17:if(_)throw _.error;return[7];case 18:return[7];case 19:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!=(o=e-128)){this.pushMapState(o),this.complete();continue e}t={}}else if(e<160){if(0!=(o=e-144)){this.pushArrayState(o),this.complete();continue e}t=[]}else{var n=e-160;t=this.decodeUtf8String(n,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.readI64();else if(217===e)n=this.lookU8(),t=this.decodeUtf8String(n,1);else if(218===e)n=this.lookU16(),t=this.decodeUtf8String(n,2);else if(219===e)n=this.lookU32(),t=this.decodeUtf8String(n,4);else if(220===e){if(0!==(o=this.readU16())){this.pushArrayState(o),this.complete();continue e}t=[]}else if(221===e){if(0!==(o=this.readU32())){this.pushArrayState(o),this.complete();continue e}t=[]}else if(222===e){if(0!==(o=this.readU16())){this.pushMapState(o),this.complete();continue e}t={}}else if(223===e){if(0!==(o=this.readU32())){this.pushMapState(o),this.complete();continue e}t={}}else if(196===e){var o=this.lookU8();t=this.decodeBinary(o,1)}else if(197===e)o=this.lookU16(),t=this.decodeBinary(o,2);else if(198===e)o=this.lookU32(),t=this.decodeBinary(o,4);else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e)o=this.lookU8(),t=this.decodeExtension(o,1);else if(200===e)o=this.lookU16(),t=this.decodeExtension(o,2);else{if(201!==e)throw new _.X("Unrecognized type byte: ".concat(r(e)));o=this.lookU32(),t=this.decodeExtension(o,4)}this.complete();for(var i=this.stack;i.length>0;){var s=i[i.length-1];if(0===s.type){if(s.array[s.position]=t,s.position++,s.position!==s.size)continue e;i.pop(),t=s.array}else{if(1===s.type){if(void 0,"string"!=(c=typeof t)&&"number"!==c)throw new _.X("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new _.X("The key __proto__ is not allowed");s.key=t,s.type=2;continue e}if(s.map[s.key]=t,s.readCount++,s.readCount!==s.size){s.key=null,s.type=1;continue e}i.pop(),t=s.map}}return t}var c},e.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=-1},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new _.X("Unrecognized array type byte: ".concat(r(e)))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new _.X("Max length exceeded: map length (".concat(e,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.push({type:1,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new _.X("Max length exceeded: array length (".concat(e,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.push({type:0,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var n;if(e>this.maxStrLength)throw new _.X("Max length exceeded: UTF-8 byte length (".concat(e,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+t+e)throw y;var r,o=this.pos+t;return r=this.stateIsMapKey()&&(null===(n=this.keyDecoder)||void 0===n?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,o,e):e>s.F6?(0,s.Q$)(this.bytes,o,e):(0,s.Zf)(this.bytes,o,e),this.pos+=t+e,r},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&1===this.stack[this.stack.length-1].type},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new _.X("Max length exceeded: bin length (".concat(e,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(e+t))throw y;var n=this.pos+t,r=this.bytes.subarray(n,n+e);return this.pos+=t+e,r},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new _.X("Max length exceeded: ext length (".concat(e,") > maxExtLength (").concat(this.maxExtLength,")"));var n=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,n,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e=(0,i.Hn)(this.view,this.pos);return this.pos+=8,e},e.prototype.readI64=function(){var e=(0,i.eN)(this.view,this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}(),w={};function v(e,t){return void 0===t&&(t=w),new g(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decode(e)}function b(e,t){return void 0===t&&(t=w),new g(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeMulti(e)}},915:(e,t,n)=>{n.d(t,{l:()=>_});var r=n(579),o=n(656),i=n(989),s=n(876),c=function(){function e(e,t,n,r,i,s,c,a){void 0===e&&(e=o.g.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=100),void 0===r&&(r=2048),void 0===i&&(i=!1),void 0===s&&(s=!1),void 0===c&&(c=!1),void 0===a&&(a=!1),this.extensionCodec=e,this.context=t,this.maxDepth=n,this.initialBufferSize=r,this.sortKeys=i,this.forceFloat32=s,this.ignoreUndefined=c,this.forceIntegerToFloat=a,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encodeSharedRef=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth ".concat(t));null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),r=new DataView(t);n.set(this.bytes),this.view=r,this.bytes=n},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: ".concat(e," bytes in UTF-8"));this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){if(e.length>r.TF){var t=(0,r.dS)(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),(0,r.jW)(e,this.bytes,this.pos),this.pos+=t}else t=(0,r.dS)(e),this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),(0,r.Hc)(e,this.bytes,this.pos),this.pos+=t},e.prototype.encodeObject=function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(e)));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: ".concat(t));this.writeU8(198),this.writeU32(t)}var n=(0,s.C)(e);this.writeU8a(n)},e.prototype.encodeArray=function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large array: ".concat(n));this.writeU8(221),this.writeU32(n)}for(var r=0,o=e;r<o.length;r++){var i=o[r];this.doEncode(i,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var n=0,r=0,o=t;r<o.length;r++)void 0!==e[o[r]]&&n++;return n},e.prototype.encodeMap=function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large map object: ".concat(r));this.writeU8(223),this.writeU32(r)}for(var o=0,i=n;o<i.length;o++){var s=i[o],c=e[s];this.ignoreUndefined&&void 0===c||(this.encodeString(s),this.doEncode(c,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: ".concat(t));this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),(0,i.X3)(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),(0,i._j)(this.view,this.pos,e),this.pos+=8},e}(),a={};function _(e,t){return void 0===t&&(t=a),new c(t.extensionCodec,t.context,t.maxDepth,t.initialBufferSize,t.sortKeys,t.forceFloat32,t.ignoreUndefined,t.forceIntegerToFloat).encodeSharedRef(e)}},989:(e,t,n)=>{n.d(t,{Hn:()=>c,X3:()=>o,_j:()=>i,eN:()=>s,f7:()=>r});var r=4294967295;function o(e,t,n){var r=n/4294967296,o=n;e.setUint32(t,r),e.setUint32(t+4,o)}function i(e,t,n){var r=Math.floor(n/4294967296),o=n;e.setUint32(t,r),e.setUint32(t+4,o)}function s(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}function c(e,t){return 4294967296*e.getUint32(t)+e.getUint32(t+4)}},876:(e,t,n)=>{function r(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function o(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=r(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}n.d(t,{C:()=>r,o:()=>o})},579:(e,t,n)=>{n.d(t,{F6:()=>y,Hc:()=>_,Q$:()=>m,TF:()=>h,Zf:()=>p,dS:()=>a,jW:()=>d});var r,o,i,s=n(989),c=("undefined"==typeof process||"never"!==(null===(r=null===process||void 0===process?void 0:process.env)||void 0===r?void 0:r.TEXT_ENCODING))&&"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder;function a(e){for(var t=e.length,n=0,r=0;r<t;){var o=e.charCodeAt(r++);if(4294967168&o)if(4294965248&o){if(o>=55296&&o<=56319&&r<t){var i=e.charCodeAt(r);56320==(64512&i)&&(++r,o=((1023&o)<<10)+(1023&i)+65536)}n+=4294901760&o?4:3}else n+=2;else n++}return n}function _(e,t,n){for(var r=e.length,o=n,i=0;i<r;){var s=e.charCodeAt(i++);if(4294967168&s){if(4294965248&s){if(s>=55296&&s<=56319&&i<r){var c=e.charCodeAt(i);56320==(64512&c)&&(++i,s=((1023&s)<<10)+(1023&c)+65536)}4294901760&s?(t[o++]=s>>18&7|240,t[o++]=s>>12&63|128,t[o++]=s>>6&63|128):(t[o++]=s>>12&15|224,t[o++]=s>>6&63|128)}else t[o++]=s>>6&31|192;t[o++]=63&s|128}else t[o++]=s}}var l=c?new TextEncoder:void 0,h=c?"undefined"!=typeof process&&"force"!==(null===(o=null===process||void 0===process?void 0:process.env)||void 0===o?void 0:o.TEXT_ENCODING)?200:0:s.f7,d=(null==l?void 0:l.encodeInto)?function(e,t,n){l.encodeInto(e,t.subarray(n))}:function(e,t,n){t.set(l.encode(e),n)},u=4096;function p(e,t,n){for(var r=t,o=r+n,i=[],s="";r<o;){var c=e[r++];if(128&c)if(192==(224&c)){var a=63&e[r++];i.push((31&c)<<6|a)}else if(224==(240&c)){a=63&e[r++];var _=63&e[r++];i.push((31&c)<<12|a<<6|_)}else if(240==(248&c)){var l=(7&c)<<18|(a=63&e[r++])<<12|(_=63&e[r++])<<6|63&e[r++];l>65535&&(l-=65536,i.push(l>>>10&1023|55296),l=56320|1023&l),i.push(l)}else i.push(c);else i.push(c);i.length>=u&&(s+=String.fromCharCode.apply(String,i),i.length=0)}return i.length>0&&(s+=String.fromCharCode.apply(String,i)),s}var f=c?new TextDecoder:null,y=c?"undefined"!=typeof process&&"force"!==(null===(i=null===process||void 0===process?void 0:process.env)||void 0===i?void 0:i.TEXT_DECODER)?200:0:s.f7;function m(e,t,n){var r=e.subarray(t,t+n);return f.decode(r)}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{API_VERSION:()=>_rpc_js__WEBPACK_IMPORTED_MODULE_0__.m,HTTPStreamingRPCConnection:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.oC,LocalWebSocket:()=>LocalWebSocket,RPC:()=>_rpc_js__WEBPACK_IMPORTED_MODULE_0__.y,connectToServer:()=>connectToServer,connectToServerHTTP:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.Xe,getRTCService:()=>_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.b,getRemoteService:()=>getRemoteService,getRemoteServiceHTTP:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.Ci,loadRequirements:()=>_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.V0,login:()=>login,logout:()=>logout,normalizeServerUrlHTTP:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.sb,registerRTCService:()=>_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.e,schemaFunction:()=>_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G,setupLocalClient:()=>setupLocalClient});var _rpc_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(887),_utils_index_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(878),_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(287),_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(831),_http_client_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(144);const MAX_RETRY=1e6;class WebsocketRPCConnection{constructor(e,t,n,r,o=null,i=60,s=null,c=7200,a=null){(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e&&t,"server_url and client_id are required"),this._server_url=e,this._client_id=t,this._workspace=n,this._token=r,this._reconnection_token=o,this._websocket=null,this._handle_message=null,this._handle_connected=null,this._handle_disconnected=null,this._timeout=i,this._WebSocketClass=s||WebSocket,this._closed=!1,this._legacy_auth=null,this.connection_info=null,this._enable_reconnect=!1,this._token_refresh_interval=c,this.manager_id=null,this._refresh_token_task=null,this._reconnect_timeouts=new Set,this._additional_headers=a,this._reconnecting=!1,this._disconnectedNotified=!1}_cleanup(){this._refresh_token_delay&&(clearTimeout(this._refresh_token_delay),this._refresh_token_delay=null),this._refresh_token_task&&(clearInterval(this._refresh_token_task),this._refresh_token_task=null);for(const e of this._reconnect_timeouts)clearTimeout(e);this._reconnect_timeouts.clear()}on_message(e){(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e,"handler is required"),this._handle_message=e}on_connected(e){this._handle_connected=e}on_disconnected(e){this._handle_disconnected=e}async _attempt_connection(e,t=!0){return new Promise(((n,r)=>{this._legacy_auth=!1;const o=new this._WebSocketClass(e);o.binaryType="arraybuffer",o.onopen=()=>{console.info("WebSocket connection established"),n(o)},o.onerror=e=>{console.error("WebSocket connection error:",e),r(new Error(`WebSocket connection error: ${e}`))},o.onclose=o=>{1003===o.code&&t?(console.info("Received 1003 error, attempting connection with query parameters."),this._legacy_auth=!0,this._attempt_connection_with_query_params(e).then(n).catch(r)):this._notifyDisconnected(o.reason)}}))}async _attempt_connection_with_query_params(e){const t=[];this._client_id&&t.push(`client_id=${encodeURIComponent(this._client_id)}`),this._workspace&&t.push(`workspace=${encodeURIComponent(this._workspace)}`),this._token&&t.push(`token=${encodeURIComponent(this._token)}`),this._reconnection_token&&t.push(`reconnection_token=${encodeURIComponent(this._reconnection_token)}`);const n=e+(t.length>0?`?${t.join("&")}`:"");return await this._attempt_connection(n,!1)}_establish_connection(){return new Promise(((e,t)=>{this._websocket.onmessage=n=>{const r=n.data,o=JSON.parse(r);if("connection_info"!=o.type){if("error"==o.type){const e="ConnectionAbortedError: "+o.message;return console.error("Failed to connect, "+e),void t(new Error(e))}return console.error("ConnectionAbortedError: Unexpected message received from the server:",r),void t(new Error("ConnectionAbortedError: Unexpected message received from the server"))}this.connection_info=o,this._workspace&&(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(this.connection_info.workspace===this._workspace,`Connected to the wrong workspace: ${this.connection_info.workspace}, expected: ${this._workspace}`),this.connection_info.reconnection_token&&(this._reconnection_token=this.connection_info.reconnection_token),this.connection_info.reconnection_token_life_time&&this._token_refresh_interval>this.connection_info.reconnection_token_life_time/1.5&&(console.warn(`Token refresh interval is too long (${this._token_refresh_interval}), setting it to 1.5 times of the token life time(${this.connection_info.reconnection_token_life_time}).`),this._token_refresh_interval=this.connection_info.reconnection_token_life_time/1.5),this.manager_id=this.connection_info.manager_id||null,console.log(`Successfully connected to the server, workspace: ${this.connection_info.workspace}, manager_id: ${this.manager_id}`),this.connection_info.announcement&&console.log(`${this.connection_info.announcement}`),e(this.connection_info)}}))}async open(){console.log("Creating a new websocket connection to",this._server_url.split("?")[0]);try{if(this._websocket=await this._attempt_connection(this._server_url),this._legacy_auth)throw new Error("NotImplementedError: Legacy authentication is not supported");const e=JSON.stringify({client_id:this._client_id,workspace:this._workspace,token:this._token,reconnection_token:this._reconnection_token});return this._websocket.send(e),await(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.fm)(this._establish_connection(),this._timeout,"Failed to receive the first message from the server"),this._token_refresh_interval>0&&(this._refresh_token_delay=setTimeout((()=>{this._refresh_token_delay=null,this._closed||(this._send_refresh_token(),this._refresh_token_task=setInterval((()=>{this._send_refresh_token()}),1e3*this._token_refresh_interval))}),2e3)),this._enable_reconnect=!0,this._closed=!1,this._disconnectedNotified=!1,this._websocket.onmessage=e=>{if("string"==typeof e.data){const t=JSON.parse(e.data);"reconnection_token"===t.type?this._reconnection_token=t.reconnection_token:console.log("Received message from the server:",t)}else this._handle_message(e.data)},this._websocket.onerror=e=>{console.error("WebSocket connection error:",e),this._cleanup()},this._websocket.onclose=this._handle_close.bind(this),this._handle_connected&&this._handle_connected(this.connection_info),this.connection_info}catch(e){throw this._cleanup(),console.error("Failed to connect to",this._server_url.split("?")[0],e),e}}_send_refresh_token(){if(this._websocket&&this._websocket.readyState===WebSocket.OPEN){const e=JSON.stringify({type:"refresh_token"});this._websocket.send(e)}}_notifyDisconnected(e){this._disconnectedNotified||(this._disconnectedNotified=!0,this._handle_disconnected&&this._handle_disconnected(e))}_handle_close(e){if(!this._closed&&this._websocket&&this._websocket.readyState===WebSocket.CLOSED){if(this._cleanup(),this._disconnectedNotified=!1,this._enable_reconnect){if([1e3,1001].includes(e.code)?console.warn(`Websocket connection closed gracefully by server (code: ${e.code}): ${e.reason} - attempting reconnect`):console.warn("Websocket connection closed unexpectedly (code: %s): %s",e.code,e.reason),this._notifyDisconnected(e.reason),this._reconnecting)return void console.debug("Reconnection already in progress, skipping");this._reconnecting=!0;let t=0;const n=1e3,r=6e4,o=.1,i=async()=>{if(this._closed)return console.info("Connection was closed, stopping reconnection"),void(this._reconnecting=!1);try{console.warn(`Reconnecting to ${this._server_url.split("?")[0]} (attempt #${t})`),await this.open(),await new Promise((e=>setTimeout(e,500))),console.warn(`Successfully reconnected to server ${this._server_url} (services re-registered)`),this._reconnecting=!1}catch(e){if(`${e}`.includes("ConnectionAbortedError:"))return console.warn("Server refused to reconnect:",e),this._closed=!0,this._reconnecting=!1,void this._notifyDisconnected(`Server refused reconnection: ${e}`);if(`${e}`.includes("NotImplementedError:"))return console.error(`${e}\nIt appears that you are trying to connect to a hypha server that is older than 0.20.0, please upgrade the hypha server or use the websocket client in imjoy-rpc(https://www.npmjs.com/package/imjoy-rpc) instead`),this._closed=!0,this._reconnecting=!1,void this._notifyDisconnected(`Server too old: ${e}`);"NetworkError"===e.name||e.message.includes("network")?console.error(`Network error during reconnection: ${e.message}`):"TimeoutError"===e.name||e.message.includes("timeout")?console.error(`Connection timeout during reconnection: ${e.message}`):console.error(`Unexpected error during reconnection: ${e.message}`);const s=Math.min(n*Math.pow(2,t),r),c=(2*Math.random()-1)*o*s,a=Math.max(100,s+c);console.debug(`Waiting ${(a/1e3).toFixed(2)}s before next reconnection attempt`);const _=setTimeout((async()=>(this._reconnect_timeouts.delete(_),this._websocket&&this._websocket.readyState===WebSocket.OPEN?(console.info("Connection restored externally"),void(this._reconnecting=!1)):this._closed?(console.info("Connection was closed, stopping reconnection"),void(this._reconnecting=!1)):(t+=1,void(t<MAX_RETRY?await i():(console.error(`Failed to reconnect after ${MAX_RETRY} attempts, giving up.`),this._closed=!0,this._reconnecting=!1,this._notifyDisconnected("Max reconnection attempts exceeded")))))),a);this._reconnect_timeouts.add(_)}};i()}}else this._cleanup(),this._notifyDisconnected(e.reason)}async emit_message(e){if(this._closed)throw new Error("Connection is closed");this._websocket&&this._websocket.readyState===WebSocket.OPEN||await this.open();try{this._websocket.send(e)}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}disconnect(e){this._closed=!0,this._reconnecting=!1,this._websocket&&this._websocket.readyState!==WebSocket.CLOSED&&this._websocket.readyState!==WebSocket.CLOSING&&this._websocket.close(1e3,e),this._cleanup(),console.info(`WebSocket connection disconnected (${e})`)}}function normalizeServerUrl(e){if(!e)throw new Error("server_url is required");return e.startsWith("http://")?e=e.replace("http://","ws://").replace(/\/$/,"")+"/ws":e.startsWith("https://")&&(e=e.replace("https://","wss://").replace(/\/$/,"")+"/ws"),e}async function login(e){const t=e.login_service_id||"public/hypha-login",n=e.workspace,r=e.expires_in,o=e.login_timeout||60,i=e.login_callback,s=e.profile,c=e.additional_headers,a=e.transport||"websocket",_=await connectToServer({name:"initial login client",server_url:e.server_url,additional_headers:c,transport:a});try{const e=await _.getService(t);let c;return(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e,`Failed to get the login service: ${t}`),c=n?await e.start({workspace:n,expires_in:r,_rkwargs:!0}):await e.start(),i?await i(c):console.log(`Please open your browser and login at ${c.login_url}`),await e.check(c.key,{timeout:o,profile:s,_rkwargs:!0})}catch(e){throw e}finally{await _.disconnect()}}async function logout(e){const t=e.login_service_id||"public/hypha-login",n=e.logout_callback,r=e.additional_headers,o=e.transport||"websocket",i=await connectToServer({name:"initial logout client",server_url:e.server_url,additional_headers:r,transport:o});try{const e=await i.getService(t);if((0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e,`Failed to get the login service: ${t}`),!e.logout)throw new Error("Logout is not supported by this server. Please upgrade the Hypha server to a version that supports logout.");const r=await e.logout({});return n?await n(r):console.log(`Please open your browser to logout at ${r.logout_url}`),r}catch(e){throw e}finally{await i.disconnect()}}async function webrtcGetService(e,t,n){const r=void 0!==(n=n||{}).webrtc?n.webrtc:"auto",o=n.webrtc_config;void 0!==n.webrtc&&delete n.webrtc,void 0!==n.webrtc_config&&delete n.webrtc_config,(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)([void 0,!0,!1,"auto"].includes(r),"webrtc must be true, false or 'auto'");const i=await e.getService(t,n);if(!0===r||"auto"===r){if(i.id.includes(":")&&i.id.includes("/"))try{const t=i.id.split(":")[0].split("/"),r=t[t.length-1],s=`${t.slice(0,-1).join("/")}/${r}-rtc`,c=await(0,_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.b)(e,s,o),a=await c.getService(i.id.split(":")[1],n);return a._webrtc=!0,a._peer=c,a._service=i,a}catch(e){console.warn("Failed to get webrtc service, using websocket connection",e)}if(!0===r)throw new Error("Failed to get the service via webrtc")}return i}async function connectToServer(e){if("http"===(e.transport||"websocket"))return await(0,_http_client_js__WEBPACK_IMPORTED_MODULE_4__.Xe)(e);e.server&&(e.server_url=e.server_url||e.server.url,e.WebSocketClass=e.WebSocketClass||e.server.WebSocketClass);let t=e.client_id;t||(t=(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.bq)(),e.client_id=t),0===Object.keys(e).length&&("undefined"!=typeof process&&process.env?(e.server_url=process.env.HYPHA_SERVER_URL,e.token=process.env.HYPHA_TOKEN,e.client_id=process.env.HYPHA_CLIENT_ID,e.workspace=process.env.HYPHA_WORKSPACE):"undefined"!=typeof self&&self.env?(e.server_url=self.env.HYPHA_SERVER_URL,e.token=self.env.HYPHA_TOKEN,e.client_id=self.env.HYPHA_CLIENT_ID,e.workspace=self.env.HYPHA_WORKSPACE):"undefined"!=typeof globalThis&&globalThis.env&&(e.server_url=globalThis.env.HYPHA_SERVER_URL,e.token=globalThis.env.HYPHA_TOKEN,e.client_id=globalThis.env.HYPHA_CLIENT_ID,e.workspace=globalThis.env.HYPHA_WORKSPACE));let n=normalizeServerUrl(e.server_url),r=new WebsocketRPCConnection(n,t,e.workspace,e.token,e.reconnection_token,e.method_timeout||60,e.WebSocketClass,e.token_refresh_interval,e.additional_headers);const o=await r.open();if((0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(o,"Failed to connect to the server, no connection info obtained. This issue is most likely due to an outdated Hypha server version. Please use `imjoy-rpc` for compatibility, or upgrade the Hypha server to the latest version."),await new Promise((e=>setTimeout(e,100))),!r.manager_id){console.warn("Manager ID not set immediately, waiting...");const e=5e3,t=100,n=Date.now();for(;!r.manager_id&&Date.now()-n<e;)await new Promise((e=>setTimeout(e,t)));if(!r.manager_id)throw console.error("Manager ID still not set after waiting"),new Error("Failed to get manager ID from server");console.info(`Manager ID set after waiting: ${r.manager_id}`)}if(e.workspace&&o.workspace!==e.workspace)throw new Error(`Connected to the wrong workspace: ${o.workspace}, expected: ${e.workspace}`);const i=o.workspace,s=new _rpc_js__WEBPACK_IMPORTED_MODULE_0__.y(r,{client_id:t,workspace:i,default_context:{connection_type:"websocket"},name:e.name,method_timeout:e.method_timeout,app_id:e.app_id,server_base_url:o.public_base_url,long_message_chunk_size:e.long_message_chunk_size});await s.waitFor("services_registered",e.method_timeout||120);const c=await s.get_manager_service({timeout:e.method_timeout,case_conversion:"camel",kwargs_expansion:e.kwargs_expansion||!1});if(c.rpc=s,o&&(c.config=Object.assign(c.config,o)),c.export=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(t){t.id="default",t.name=t.name||e.name||t.id,t.description=t.description||e.description,await s.register_service(t,{overwrite:!0})}),{name:"export",description:"Export the api.",parameters:{properties:{api:{description:"The api to export",type:"object"}},required:["api"],type:"object"}}),c.getApp=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(e){return e=e||"*",(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(!e.includes(":"),"clientId should not contain ':'"),e.includes("/")||(e=o.workspace+"/"+e),(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(2===e.split("/").length,"clientId should match pattern workspace/clientId"),await c.getService(`${e}:default`)}),{name:"getApp",description:"Get the app.",parameters:{properties:{clientId:{default:"*",description:"The clientId",type:"string"}},type:"object"}}),c.listApps=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(e){e=e||i,(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(!e.includes(":"),"workspace should not contain ':'"),(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(!e.includes("/"),"workspace should not contain '/'");const t={workspace:e,service_id:"default"};return await c.listServices(t)}),{name:"listApps",description:"List the apps.",parameters:{properties:{workspace:{default:i,description:"The workspace",type:"string"}},type:"object"}}),c.disconnect=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.disconnect.bind(s),{name:"disconnect",description:"Disconnect from the server.",parameters:{type:"object",properties:{},required:[]}}),c.registerCodec=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.register_codec.bind(s),{name:"registerCodec",description:"Register a codec for the webrtc connection",parameters:{type:"object",properties:{codec:{type:"object",description:"Codec to register",properties:{name:{type:"string"},type:{},encoder:{type:"function"},decoder:{type:"function"}}}}}}),c.emit=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.emit.bind(s),{name:"emit",description:"Emit a message.",parameters:{properties:{data:{description:"The data to emit",type:"object"}},required:["data"],type:"object"}}),c.on=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.on.bind(s),{name:"on",description:"Register a message handler.",parameters:{properties:{event:{description:"The event to listen to",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),c.off=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.off.bind(s),{name:"off",description:"Remove a message handler.",parameters:{properties:{event:{description:"The event to remove",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),c.once=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.once.bind(s),{name:"once",description:"Register a one-time message handler.",parameters:{properties:{event:{description:"The event to listen to",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),c.getServiceSchema=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.get_service_schema,{name:"getServiceSchema",description:"Get the service schema.",parameters:{properties:{service:{description:"The service to extract schema",type:"object"}},required:["service"],type:"object"}}),c.registerService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.register_service.bind(s),{name:"registerService",description:"Register a service.",parameters:{properties:{service:{description:"The service to register",type:"object"},force:{default:!1,description:"Force to register the service",type:"boolean"}},required:["service"],type:"object"}}),c.unregisterService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(s.unregister_service.bind(s),{name:"unregisterService",description:"Unregister a service.",parameters:{properties:{service:{description:"The service id to unregister",type:"string"},notify:{default:!0,description:"Notify the workspace manager",type:"boolean"}},required:["service"],type:"object"}}),r.manager_id&&s.on("force-exit",(async e=>{e.from==="*/"+r.manager_id&&(console.log("Disconnecting from server, reason:",e.reason),await s.disconnect())})),e.webrtc){await(0,_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.e)(c,`${t}-rtc`,e.webrtc_config);const n=Object.assign({},c),r=n.getService.__schema__.description,o=n.getService.__schema__.parameters;c.getService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(webrtcGetService.bind(null,n),{name:"getService",description:r,parameters:o}),c.getRTCService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.b.bind(null,c),{name:"getRTCService",description:"Get the webrtc connection, returns a peer connection.",parameters:{properties:{config:{description:"The config for the webrtc service",type:"object"}},required:["config"],type:"object"}})}else{const e=c.getService;c.getService=(t,n)=>e(t,n=n||{}),c.getService.__schema__=e.__schema__}return c.registerProbes=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(e){return e.id="probes",e.name="Probes",e.config={visibility:"public"},e.type="probes",e.description=`Probes Service, visit ${n}/${i}services/probes for the available probes.`,await c.registerService(e,{overwrite:!0})}),{name:"registerProbes",description:"Register probes service",parameters:{properties:{probes:{description:"The probes to register, e.g. {'liveness': {'type': 'function', 'description': 'Check the liveness of the service'}}",type:"object"}},required:["probes"],type:"object"}}),c}async function getRemoteService(e,t={}){const{serverUrl:n,workspace:r,clientId:o,serviceId:i,appId:s}=(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.iO)(e),c=`${r}/${o}:${i}@${s}`;if(t.serverUrl&&t.serverUrl!==n)throw new Error("server_url in config does not match the server_url in the url");t.serverUrl=n;const a=await connectToServer(t);return await a.getService(c)}class LocalWebSocket{constructor(e,t,n){this.url=e,this.onopen=()=>{},this.onmessage=()=>{},this.onclose=()=>{},this.onerror=()=>{},this.client_id=t,this.workspace=n;const r="undefined"!=typeof window?window:self,o="undefined"!=typeof window;if(this.postMessage=e=>{o?window.parent.postMessage(e,"*"):self.postMessage(e)},this.readyState=WebSocket.CONNECTING,this._context=r,this._messageListener=e=>{const{type:t,data:n,to:r}=e.data;if(r===this.client_id)switch(t){case"message":this.readyState===WebSocket.OPEN&&this.onmessage&&this.onmessage({data:n});break;case"connected":this.readyState=WebSocket.OPEN,this.onopen(e);break;case"closed":this.readyState=WebSocket.CLOSED,this.onclose(e)}},r.addEventListener("message",this._messageListener,!1),!this.client_id)throw new Error("client_id is required");if(!this.workspace)throw new Error("workspace is required");this.postMessage({type:"connect",url:this.url,from:this.client_id,workspace:this.workspace})}send(e){this.readyState===WebSocket.OPEN&&this.postMessage({type:"message",data:e,from:this.client_id,workspace:this.workspace})}close(){this.readyState=WebSocket.CLOSING,this.postMessage({type:"close",from:this.client_id,workspace:this.workspace}),this._context&&this._messageListener&&(this._context.removeEventListener("message",this._messageListener,!1),this._messageListener=null),this.onclose()}addEventListener(e,t){"message"===e&&(this.onmessage=t),"open"===e&&(this.onopen=t),"close"===e&&(this.onclose=t),"error"===e&&(this.onerror=t)}}function setupLocalClient({enable_execution=!1,on_ready=null}){return new Promise(((resolve,reject)=>{const context="undefined"!=typeof window?window:self,isWindow="undefined"!=typeof window;context.addEventListener("message",(event=>{const{type,server_url,workspace,client_id,token,method_timeout,name,config}=event.data;if("initializeHyphaClient"===type){if(!server_url||!workspace||!client_id)return void console.error("server_url, workspace, and client_id are required.");if(!server_url.startsWith("https://local-hypha-server:"))return void console.error("server_url should start with https://local-hypha-server:");class FixedLocalWebSocket extends LocalWebSocket{constructor(e){super(e,client_id,workspace)}}connectToServer({server_url,workspace,client_id,token,method_timeout,name,WebSocketClass:FixedLocalWebSocket}).then((async server=>{globalThis.api=server;try{if(isWindow&&enable_execution){function e(e){return new Promise(((t,n)=>{const r=document.createElement("script");r.innerHTML=e.content,r.lang=e.lang,r.onload=()=>t(),r.onerror=e=>n(e),document.head.appendChild(r)}))}if(config.styles&&config.styles.length>0)for(const t of config.styles){const n=document.createElement("style");n.innerHTML=t.content,n.lang=t.lang,document.head.appendChild(n)}if(config.links&&config.links.length>0)for(const r of config.links){const o=document.createElement("a");o.href=r.url,o.innerText=r.text,document.body.appendChild(o)}if(config.windows&&config.windows.length>0)for(const i of config.windows){document.body.innerHTML=i.content;break}if(config.scripts&&config.scripts.length>0)for(const s of config.scripts){if("javascript"!==s.lang)throw new Error("Only javascript scripts are supported");await e(s)}}else if(!isWindow&&enable_execution&&config.scripts&&config.scripts.length>0)for(const script of config.scripts){if("javascript"!==script.lang)throw new Error("Only javascript scripts are supported");eval(script.content)}on_ready&&await on_ready(server,config),resolve(server)}catch(c){reject(c)}}))}}),!1),isWindow?window.parent.postMessage({type:"hyphaClientReady"},"*"):self.postMessage({type:"hyphaClientReady"})}))}return __webpack_exports__})()));
//# sourceMappingURL=hypha-rpc-websocket.min.js.map