!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("hyphaWebsocketClient",[],t):"object"==typeof exports?exports.hyphaWebsocketClient=t():e.hyphaWebsocketClient=t()}(this,(()=>(()=>{"use strict";var __webpack_modules__={144:(e,t,n)=>{n.d(t,{Ci:()=>h,Xe:()=>l,oC:()=>a,sb:()=>_});var r=n(887),s=n(878),o=n(287),i=n(290),c=n(915);class a{constructor(e,t,n=null,r=null,o=null,i=60,c=7200,a="json"){(0,s.vA)(e&&t,"server_url and client_id are required"),this._server_url=e.replace(/\/$/,""),this._client_id=t,this._workspace=n,this._token=r,this._reconnection_token=o,this._timeout=i,this._token_refresh_interval=c,this._format=a,this._handle_message=null,this._handle_disconnected=null,this._handle_connected=null,this._closed=!1,this._enable_reconnect=!1,this.connection_info=null,this.manager_id=null,this._stream_reader=null,this._stream_controller=null}on_message(e){(0,s.vA)(e,"handler is required"),this._handle_message=e}on_disconnected(e){this._handle_disconnected=e}on_connected(e){this._handle_connected=e}_get_headers(e=!1){const t={"Content-Type":"application/msgpack"};return e&&("msgpack"===this._format?t.Accept="application/x-msgpack-stream":t.Accept="application/x-ndjson"),this._token&&(t.Authorization=`Bearer ${this._token}`),t}async open(){console.info(`Opening HTTP streaming connection to ${this._server_url} (format=${this._format})`);let e=`${this._server_url}/rpc?client_id=${this._client_id}`;this._workspace&&(e+=`&workspace=${this._workspace}`),"msgpack"===this._format&&(e+="&format=msgpack"),this._startStreamLoop(e);const t=Date.now();for(;null===this.connection_info;){if(await new Promise((e=>setTimeout(e,100))),Date.now()-t>1e3*this._timeout)throw new Error("Timeout waiting for connection info");if(this._closed)throw new Error("Connection closed during setup")}if(this.manager_id=this.connection_info.manager_id,this._workspace){const e=this.connection_info.workspace;if(e!==this._workspace)throw new Error(`Connected to wrong workspace: ${e}, expected: ${this._workspace}`)}return this._workspace=this.connection_info.workspace,this._handle_connected&&await this._handle_connected(),this.connection_info}async _startStreamLoop(e){let t=0;for(;!this._closed&&t<1e6;){try{const n=await fetch(e,{method:"GET",headers:this._get_headers(!0),keepalive:!0});if(!n.ok){const e=await n.text();throw new Error(`Stream failed with status ${n.status}: ${e}`)}t=0,"msgpack"===this._format?await this._processMsgpackStream(n):await this._processNdjsonStream(n)}catch(e){if(this._closed)break;if(console.error(`Connection error: ${e.message}`),!this._enable_reconnect)break}if(this._closed||!this._enable_reconnect)break;{t+=1;const e=Math.min(.1*Math.pow(2,t),30);console.info(`Reconnecting in ${e.toFixed(1)}s (attempt ${t})`),await new Promise((t=>setTimeout(t,1e3*e)))}}!this._closed&&this._handle_disconnected&&this._handle_disconnected("Stream ended")}async _processNdjsonStream(e){const t=e.body.getReader(),n=new TextDecoder;let r="";for(;!this._closed;){const{done:e,value:s}=await t.read();if(e)break;r+=n.decode(s,{stream:!0});const o=r.split("\n");r=o.pop()||"";for(const e of o)if(e.trim())try{const t=JSON.parse(e);await this._handleStreamMessage(t)}catch(e){console.warn(`Failed to parse JSON message: ${e.message}`)}}}_tryDecodeControlMessage(e){if(e.length>1e4)return null;try{const t=(0,i.D4)(e);return"object"==typeof t&&null!==t&&t.type&&["connection_info","ping","pong","reconnection_token","error"].includes(t.type)?t:null}catch{return null}}async _processMsgpackStream(e){const t=e.body.getReader();let n=new Uint8Array(0);for(;!this._closed;){const{done:e,value:r}=await t.read();if(e)break;const s=new Uint8Array(n.length+r.length);for(s.set(n),s.set(r,n.length),n=s;n.length>=4;){const e=n[0]<<24|n[1]<<16|n[2]<<8|n[3];if(n.length<4+e)break;const t=n.slice(4,4+e);n=n.slice(4+e);const r=this._tryDecodeControlMessage(t);if(r){const e=r.type;if("connection_info"===e){this.connection_info=r;continue}if("ping"===e||"pong"===e)continue;if("reconnection_token"===e){this._reconnection_token=r.reconnection_token;continue}if("error"===e){console.error(`Server error: ${r.message}`);continue}}if(this._handle_message)try{await this._handle_message(t)}catch(e){console.error(`Error in message handler: ${e.message}`)}}}}async _handleStreamMessage(e){if("connection_info"!==e.type){if("ping"!==e.type)if("reconnection_token"!==e.type)if("error"!==e.type){if(this._handle_message){const t=(0,c.l)(e);await this._handle_message(t)}}else console.error(`Server error: ${e.message}`);else this._reconnection_token=e.reconnection_token}else this.connection_info=e}async emit_message(e){if(this._closed)throw new Error("Connection is closed");let t=`${this._server_url}/rpc?client_id=${this._client_id}`;this._workspace&&(t+=`&workspace=${this._workspace}`);const n=e instanceof Uint8Array?e:new Uint8Array(e),r=await fetch(t,{method:"POST",headers:this._get_headers(!1),body:n,keepalive:!0});if(!r.ok){const e=await r.text();throw new Error(`POST failed with status ${r.status}: ${e}`)}return!0}set_reconnection(e){this._enable_reconnect=e}async disconnect(e="client disconnect"){this._closed||(this._closed=!0,this._handle_disconnected&&this._handle_disconnected(e))}}function _(e){if(!e)throw new Error("server_url is required");return e.startsWith("ws://")?e=e.replace("ws://","http://"):e.startsWith("wss://")&&(e=e.replace("wss://","https://")),e.endsWith("/ws")&&(e=e.slice(0,-3)),e.replace(/\/$/,"")}async function l(e={}){return await async function(e){let t=e.clientId||e.client_id;t||(t=(0,s.bq)());const n=_(e.serverUrl||e.server_url),i=new a(n,t,e.workspace,e.token,e.reconnection_token,e.method_timeout||30,e.token_refresh_interval||7200,e.format||"msgpack"),c=await i.open();(0,s.vA)(c,"Failed to connect to server"),await new Promise((e=>setTimeout(e,100)));const l=c.workspace,h=new r.y(i,{client_id:t,workspace:l,default_context:{connection_type:"http_streaming"},name:e.name,method_timeout:e.method_timeout,app_id:e.app_id,server_base_url:c.public_base_url});await h.waitFor("services_registered",e.method_timeout||120);const d=await h.get_manager_service({timeout:e.method_timeout||30,case_conversion:"camel"});d.rpc=h,d.disconnect=(0,o.G)(h.disconnect.bind(h),{name:"disconnect",description:"Disconnect from server",parameters:{properties:{},type:"object"}}),d.registerService=(0,o.G)(h.register_service.bind(h),{name:"registerService",description:"Register a service",parameters:{properties:{service:{description:"Service to register",type:"object"}},required:["service"],type:"object"}});const p=d.getService;return d.getService=async(e,t={})=>await p(e,t),p.__schema__&&(d.getService.__schema__=p.__schema__),d.serve=(0,o.G)((async function(){await new Promise((()=>{}))}),{name:"serve",description:"Run event loop forever",parameters:{type:"object",properties:{}}}),c&&(d.config=Object.assign(d.config||{},c)),i.manager_id&&h.on("force-exit",(async e=>{e.from==="*/"+i.manager_id&&(console.info(`Disconnecting from server: ${e.reason}`),await h.disconnect())})),d}(e)}async function h(e,t={}){const{serverUrl:n,workspace:r,clientId:o,serviceId:i,appId:c}=(0,s.iO)(e),a=`${r}/${o}:${i}@${c}`;if(t.serverUrl&&t.serverUrl!==n)throw new Error("server_url mismatch");t.serverUrl=n;const _=await l(t);return await _.getService(a)}},887:(e,t,n)=>{n.d(t,{m:()=>c,y:()=>f});var r=n(878),s=n(287),o=n(290),i=n(915);const c=3,a=Object.getPrototypeOf(Object.getPrototypeOf(new Uint8Array)).constructor;function _(e,t){const n=new Uint8Array(e.byteLength+t.byteLength);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),n.buffer}function l(e,t,n="Operation timed out"){return new Promise(((r,s)=>{const o=setTimeout((()=>{s(new Error(`TimeoutError: ${n}`))}),t);e.then((e=>{clearTimeout(o),r(e)})).catch((e=>{clearTimeout(o),s(e)}))}))}function h(e,t){if(!t)throw new Error("undefined index");return"string"==typeof t?h(e,t.split(".")):0===t.length?e:h(e[t[0]],t.slice(1))}function d(e,t=null,n=!1){if(Array.isArray(e))return e.map(((e,t)=>d(e,null,n)));if("object"==typeof e&&null!==e){let t={};for(let r in e)t[r]=d(e[r],r,n);return t}if("function"==typeof e){if(e.__schema__){const r=JSON.parse(JSON.stringify(e.__schema__));if(t&&(r.name=t,e.__schema__.name=t),n&&(r.parameters&&r.parameters.properties&&delete r.parameters.properties.context,r.parameters&&r.parameters.required)){const e=r.parameters.required.indexOf("context");e>-1&&r.parameters.required.splice(e,1)}return{type:"function",function:r}}return{type:"function",function:{name:t||e.name||"function"}}}return"number"==typeof e?{type:"number"}:"string"==typeof e?{type:"string"}:"boolean"==typeof e?{type:"boolean"}:null===e?{type:"null"}:{}}class p{constructor(e,t,n,r){this._timeout=e,this._callback=t,this._args=n,this._label=r||"timer",this._task=null,this.started=!1}start(){this.started?this.reset():(this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0)}clear(){this._task&&this.started?(clearTimeout(this._task),this._task=null,this.started=!1):console.warn(`Clearing a timer (${this._label}) which is not started`)}reset(){this._task&&clearTimeout(this._task),this._task=setTimeout((()=>{this._callback.apply(this,this._args)}),1e3*this._timeout),this.started=!0}}class u extends Object{}class f extends r.sw{constructor(e,{client_id:t=null,default_context:n=null,name:s=null,codecs:o=null,method_timeout:i=null,max_message_buffer_size:a=0,debug:_=!1,workspace:h=null,silent:d=!1,app_id:p=null,server_base_url:u=null,long_message_chunk_size:f=null}){super(_),this._codecs=o||{},(0,r.vA)(t&&"string"==typeof t),(0,r.vA)(t,"client_id is required"),this._client_id=t,this._name=s,this._app_id=p||"*",this._local_workspace=h,this._silent=d,this.default_context=n||{},this._method_annotations=new WeakMap,this._max_message_buffer_size=a,this._chunk_store={},this._method_timeout=i||30,this._server_base_url=u,this._long_message_chunk_size=f||262144,this._services={},this._object_store={services:this._services},this._background_tasks=new Set;const m=e=>{const t=e.reason;if(t&&"object"==typeof t){const n=t.toString();if(n.includes("Method not found")||n.includes("Session not found")||n.includes("Method expired")||n.includes("Session not found"))return console.debug("Ignoring expected method/session not found error:",t),void e.preventDefault()}console.warn("Unhandled RPC promise rejection:",t)};if("undefined"==typeof window||window._hypha_rejection_handler_set?"undefined"==typeof process||process._hypha_rejection_handler_set||(process.on("unhandledRejection",((e,t)=>{m({reason:e,promise:t,preventDefault:()=>{}})})),process._hypha_rejection_handler_set=!0):(window.addEventListener("unhandledrejection",m),window._hypha_rejection_handler_set=!0),e){this.add_service({id:"built-in",type:"built-in",name:`Built-in services for ${this._local_workspace}/${this._client_id}`,config:{require_context:!0,visibility:"public",api_version:c},ping:this._ping.bind(this),get_service:this.get_local_service.bind(this),message_cache:{create:this._create_message.bind(this),append:this._append_message.bind(this),set:this._set_message.bind(this),process:this._process_message.bind(this),remove:this._remove_message.bind(this)}}),this.on("method",this._handle_method.bind(this)),this.on("error",console.error),(0,r.vA)(e.emit_message&&e.on_message),(0,r.vA)(void 0!==e.manager_id,"Connection must have manager_id"),this._emit_message=e.emit_message.bind(e),e.on_message(this._on_message.bind(this)),this._connection=e;const t=async e=>{if(!this._silent&&this._connection.manager_id){console.debug("Connection established, reporting services...");try{const e=await this._get_manager_with_retry(),t=Object.values(this._services),n=t.length;let r=0;const s=[],o=this._method_timeout||3e4;for(let n of t)try{const t=this._extract_service_info(n);await l(e.registerService(t),o,`Timeout registering service ${n.id||"unknown"}`),r++,console.debug(`Successfully registered service: ${n.id||"unknown"}`)}catch(e){s.push(n.id||"unknown"),e.message&&e.message.includes("TimeoutError")?console.error(`Timeout registering service ${n.id||"unknown"}`):console.error(`Failed to register service ${n.id||"unknown"}: ${e}`)}r===n?console.info(`Successfully registered all ${r} services with the server`):console.warn(`Only registered ${r} out of ${n} services with the server. Failed services: ${s.join(", ")}`),this._fire("services_registered",{total:n,registered:r,failed:s});try{if(e.subscribe&&"function"==typeof e.subscribe){console.debug("Subscribing to client_disconnected events");const t=async e=>{const t=e.data?.id||e.client,n=e.data?.workspace;if(t&&n){const e=`${n}/${t}`;console.debug(`Client ${e} disconnected, cleaning up sessions`),await this._handleClientDisconnected(e)}else t&&(console.debug(`Client ${t} disconnected, cleaning up sessions`),await this._handleClientDisconnected(t))};this._clientDisconnectedSubscription=await l(e.subscribe(["client_disconnected"]),o,"Timeout subscribing to client_disconnected events"),this.on("client_disconnected",t),console.debug("Successfully subscribed to client_disconnected events")}else console.debug("Manager does not support subscribe method, skipping client_disconnected handling"),this._clientDisconnectedSubscription=null}catch(e){console.warn(`Failed to subscribe to client_disconnected events: ${e}`),this._clientDisconnectedSubscription=null}}catch(e){console.error(`Failed to get manager service for registering services: ${e}`),this._fire("services_registration_failed",{error:e.toString(),total_services:Object.keys(this._services).length})}}e&&(e.public_base_url&&(this._server_base_url=e.public_base_url),this._fire("connected",e))};e.on_connected(t),t()}else this._emit_message=function(){console.log("No connection to emit message")}}register_codec(e){if(!e.name||!e.encoder&&!e.decoder)throw new Error("Invalid codec format, please make sure you provide a name, type, encoder and decoder.");if(e.type)for(let t of Object.keys(this._codecs))this._codecs[t].type!==e.type&&t!==e.name||(delete this._codecs[t],console.warn("Remove duplicated codec: "+t));this._codecs[e.name]=e}async _ping(e,t){return(0,r.vA)("ping"==e),"pong"}async ping(e,t){let n=this._generate_remote_method({_rserver:this._server_base_url,_rtarget:e,_rmethod:"services.built-in.ping",_rpromise:!0,_rdoc:"Ping a remote client"});(0,r.vA)("pong"==await n("ping",t))}_create_message(e,t,n,r){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}if(this._object_store.message_cache||(this._object_store.message_cache={}),!n&&this._object_store.message_cache[e])throw new Error(`Message with the same key (${e}) already exists in the cache store, please use overwrite=true or remove it first.`);this._object_store.message_cache[e]=[]}_append_message(e,t,n,s){if(n){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const o=this._object_store.message_cache;if(!o[e])throw new Error(`Message with key ${e} does not exists.`);(0,r.vA)(t instanceof a),o[e].push(t)}_set_message(e,t,n,s,o){if(s){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const i=this._object_store.message_cache;if(!i[e])throw new Error(`Message with key ${e} does not exists.`);(0,r.vA)(n instanceof a),i[e][t]=n}_remove_message(e,t){const n=this._object_store.message_cache;if(!n[e])throw new Error(`Message with key ${e} does not exists.`);delete n[e]}_process_message(e,t,n){if(t){if(!this._object_store[e])throw new Error(`session does not exist anymore: ${e}`);this._object_store[e].timer.reset()}const s=this._object_store.message_cache;if((0,r.vA)(!!n,"Context is required"),!s[e])throw new Error(`Message with key ${e} does not exists.`);var i,c,a,_;s[e]=(a=(c=(i=s[e]).map((function(e){return e.byteLength}))).reduce((function(e,t){return e+t}),0),_=new Uint8Array(a),c.reduce((function(e,t,n){return _.set(new Uint8Array(i[n]),e),e+t}),0),_.buffer);let l=(0,o.UN)(s[e]);const{done:h,value:d}=l.next(),p=d;if(Object.assign(p,{from:n.from,to:n.to,ws:n.ws,user:n.user}),p.ctx=JSON.parse(JSON.stringify(p)),Object.assign(p.ctx,this.default_context),!h){let e=l.next();Object.assign(p,e.value)}this._fire(p.type,p),delete s[e]}_on_message(e){if("string"==typeof e){const t=JSON.parse(e);t.ctx=JSON.parse(JSON.stringify(t)),Object.assign(t.ctx,this.default_context),this._fire(t.type,t)}else if(e instanceof ArrayBuffer||ArrayBuffer.isView(e)){let t=(0,o.UN)(e);const{done:n,value:r}=t.next(),s=r;if(s.ctx=JSON.parse(JSON.stringify(s)),Object.assign(s.ctx,this.default_context),!n){let e=t.next();Object.assign(s,e.value)}this._fire(s.type,s)}else{if("object"!=typeof e)throw new Error("Invalid message format");e.ctx=JSON.parse(JSON.stringify(e)),Object.assign(e.ctx,this.default_context),this._fire(e.type,e)}}reset(){this._event_handlers={},this._services={}}close(){this._cleanupOnDisconnect();for(const e in this._object_store)if(this._object_store.hasOwnProperty(e)){const t=this._object_store[e];t&&t.heartbeat_task&&clearInterval(t.heartbeat_task),t&&t.timer&&t.timer.clear()}if(this._clientDisconnectedSubscription)try{this._connection&&this._connection.manager_id&&this.get_remote_service("*/"+this._connection.manager_id).then((e=>{if(e.unsubscribe&&"function"==typeof e.unsubscribe)return e.unsubscribe("client_disconnected")})).catch((e=>{console.debug(`Error unsubscribing from client_disconnected: ${e}`)})),this.off("client_disconnected")}catch(e){console.debug(`Error unsubscribing from client_disconnected: ${e}`)}try{for(const e of this._background_tasks)if(e&&"function"==typeof e.cancel)try{e.cancel()}catch(e){console.debug(`Error canceling background task: ${e}`)}this._background_tasks.clear()}catch(e){console.debug(`Error cleaning up background tasks: ${e}`)}try{this._connection=null,this._emit_message=function(){return console.debug("RPC connection closed, ignoring message"),Promise.reject(new Error("Connection is closed"))}}catch(e){console.debug(`Error during connection cleanup: ${e}`)}this._fire("disconnected")}async _handleClientDisconnected(e){try{console.debug(`Handling disconnection for client: ${e}`);const t=this._cleanupSessionsForClient(e);t>0&&console.debug(`Cleaned up ${t} sessions for disconnected client: ${e}`),this._fire("remote_client_disconnected",{client_id:e,sessions_cleaned:t})}catch(t){console.error(`Error handling client disconnection for ${e}: ${t}`)}}_cleanupSessionsForClient(e){let t=0;for(const n of Object.keys(this._object_store)){if("services"===n||"message_cache"===n)continue;const r=this._object_store[n];if(r&&"object"==typeof r&&r.target_id===e){if(r.reject&&"function"==typeof r.reject){console.debug(`Rejecting session ${n}`);try{r.reject(new Error(`Client disconnected: ${e}`))}catch(e){console.warn(`Error rejecting session ${n}: ${e}`)}}if(r.resolve&&"function"==typeof r.resolve){console.debug(`Resolving session ${n} with error`);try{r.resolve(new Error(`Client disconnected: ${e}`))}catch(e){console.warn(`Error resolving session ${n}: ${e}`)}}if(r.timer&&"function"==typeof r.timer.clear)try{r.timer.clear()}catch(e){console.warn(`Error clearing timer for ${n}: ${e}`)}if(r.heartbeat_task)try{clearInterval(r.heartbeat_task)}catch(e){console.warn(`Error clearing heartbeat for ${n}: ${e}`)}delete this._object_store[n],t++,console.debug(`Cleaned up session: ${n}`)}}return t}_cleanupOnDisconnect(){try{console.debug("Cleaning up all sessions due to local RPC disconnection");const e=[];for(const t of Object.keys(this._object_store)){if("services"===t)continue;const n=this._object_store[t];if("object"==typeof n&&null!==n){if(n.reject&&"function"==typeof n.reject)try{n.reject(new Error("RPC connection closed"))}catch(e){console.debug(`Error rejecting promise during cleanup: ${e}`)}if(n.heartbeat_task&&clearInterval(n.heartbeat_task),n.timer&&"function"==typeof n.timer.clear)try{n.timer.clear()}catch(e){console.debug(`Error clearing timer: ${e}`)}}e.push(t)}for(const t of e)delete this._object_store[t]}catch(e){console.error(`Error during cleanup on disconnect: ${e}`)}}async disconnect(){const e=this._connection;if(this.close(),e)try{await e.disconnect()}catch(e){console.debug(`Error disconnecting underlying connection: ${e}`)}}async _get_manager_with_retry(e=20){let t=null;for(let n=0;n<e;n++)try{return await this.get_remote_service(`*/${this._connection.manager_id}:default`,{timeout:20,case_conversion:"camel"})}catch(r){if(t=r,console.warn(`Failed to get manager service (attempt ${n+1}/${e}): ${r.message}`),n<e-1){const e=Math.min(500*Math.pow(2,n),1e4);await new Promise((t=>setTimeout(t,e)))}}throw t}async get_manager_service(e){e=e||{};for(let t=0;t<20;t++){if(!this._connection.manager_id){if(t<19){console.warn(`Manager ID not set, retrying in 500ms (attempt ${t+1}/20)`),await new Promise((e=>setTimeout(e,500)));continue}throw new Error("Manager ID not set after maximum retries")}try{return await this.get_remote_service(`*/${this._connection.manager_id}:default`,e)}catch(e){if(!(t<19))throw e;console.warn(`Failed to get manager service, retrying in 500ms: ${e.message}`),await new Promise((e=>setTimeout(e,500)))}}}get_all_local_services(){return this._services}get_local_service(e,t){(0,r.vA)(e),(0,r.vA)(t,"Context is required");const[n,s]=t.to.split("/");(0,r.vA)(s===this._client_id,"Services can only be accessed locally");const o=this._services[e];if(!o)throw new Error("Service not found: "+e);if("public"==o.config.visibility||"unlisted"==o.config.visibility)return o;if(t.ws===n)return o;const i=o.config.authorized_workspaces;if(i&&i.includes(t.ws))return o;throw new Error(`Permission denied for getting protected service: ${e}, workspace mismatch: ${n} != ${t.ws}`)}async get_remote_service(e,t){let{timeout:n,case_conversion:s,kwargs_expansion:o}=t||{};n=void 0===n?this._method_timeout:n,!e&&this._connection.manager_id?e="*/"+this._connection.manager_id:e.includes(":")||(e=this._client_id+":"+e);const i=e.split(":")[0];let c=e.split(":")[1];if(c.includes("@")){c=c.split("@")[0];const t=e.split("@")[1];this._app_id&&"*"!==this._app_id&&(0,r.vA)(t===this._app_id,`Invalid app id: ${t} != ${this._app_id}`)}(0,r.vA)(i,`Invalid service uri: ${e}`);try{const t=this._generate_remote_method({_rserver:this._server_base_url,_rtarget:i,_rmethod:"services.built-in.get_service",_rpromise:!0,_rdoc:"Get a remote service"});let a=await(0,r.fm)(t(c),n,"Timeout Error: Failed to get remote service: "+e);return a.id=`${i}:${c}`,o&&(a=(0,r.uX)(a)),s?Object.assign(new u,(0,r.gX)(a,s)):Object.assign(new u,a)}catch(t){throw console.warn("Failed to get remote service: "+e,t),t}}_annotate_service_methods(e,t,n,r,s,o){if("function"==typeof e){let i=t.split(".")[1];this._method_annotations.set(e,{require_context:Array.isArray(n)?n.includes(i):!!n,run_in_executor:r,method_id:"services."+t,visibility:s,authorized_workspaces:o})}else if(e instanceof Array||e instanceof Object)for(let i of Object.keys(e)){let c=e[i];if("function"==typeof c&&c.__rpc_object__){let t=c.__rpc_object__._rtarget;if(t.includes("/")&&(t=t.split("/")[1]),this._client_id!==t)throw new Error(`Local method not found: ${c.__rpc_object__._rmethod}, client id mismatch ${this._client_id} != ${t}`);e instanceof Array&&(e=e.slice()),e[i]=h(this._object_store,c.__rpc_object__._rmethod),c=e[i]}this._annotate_service_methods(c,t+"."+i,n,r,s,o)}}add_service(e,t){if(!e||Array.isArray(e))throw new Error("Invalid service object");if(e.constructor===Object)e=Object.assign({},e);else{const t={},n=Object.getOwnPropertyNames(e).concat(Object.getOwnPropertyNames(Object.getPrototypeOf(e)));for(let r of n)"constructor"!==r&&("function"==typeof e[r]?t[r]=e[r].bind(e):t[r]=e[r]);e.id=e.id||"default",e=t}(0,r.vA)(e.id&&"string"==typeof e.id,`Service id not found: ${e}`),e.name||(e.name=e.id),e.config||(e.config={}),e.type||(e.type="generic");let n=!1,s=!1;e.config.require_context&&(n=e.config.require_context),e.config.run_in_executor&&(s=!0);const o=e.config.visibility||"protected";(0,r.vA)(["protected","public","unlisted"].includes(o));const i=e.config.authorized_workspaces;if(void 0!==i){if("protected"!==o)throw new Error(`authorized_workspaces can only be set when visibility is 'protected', got visibility='${o}'`);if(!Array.isArray(i))throw new Error("authorized_workspaces must be an array of workspace ids");for(const e of i)if("string"!=typeof e)throw new Error("Each workspace id in authorized_workspaces must be a string, got "+typeof e)}if(this._annotate_service_methods(e,e.id,n,s,o,i),this._services[e.id]){if(!t)throw new Error(`Service already exists: ${e.id}, please specify a different id (not ${e.id}) or overwrite=true`);delete this._services[e.id]}return this._services[e.id]=e,e}_extract_service_info(e){const t=e.config||{};if(t.workspace=t.workspace||this._local_workspace||this._connection.workspace,!t.workspace)throw new Error("Workspace is not set. Please ensure the connection has a workspace or set local_workspace.");const n=t.require_context,r=["id","config","name","description","type","docs","app_id","service_schema"],s={};for(const t of Object.keys(e))r.includes(t)||(s[t]=e[t]);const o=d(s,null,n);return{config:t,id:`${t.workspace}/${this._client_id}:${e.id}`,name:e.name||e.id,description:e.description||"",type:e.type||"generic",docs:e.docs||null,app_id:this._app_id,service_schema:o}}async get_service_schema(e){return d(e,null,e.config.require_context)}async register_service(e,t){let n,{check_type:r,notify:o,overwrite:i}=t||{};if(o=void 0===o||o,r&&e.type)try{n=await this.get_manager_service({timeout:10,case_conversion:"camel"}),e=function(e,t){function n(e,t,n="root"){for(let r in t)if(!e.hasOwnProperty(r))throw new Error(`Missing key '${r}' in service at path '${n}'`);for(let r in e)if("type"!==r&&!t.hasOwnProperty(r))throw new Error(`Unexpected key '${r}' in service at path '${n}'`)}return n(e,t.definition),function e(t,r,o="root"){if("object"!=typeof t||Array.isArray(t)){if(Array.isArray(t)){if(t.length!==r.length)throw new Error(`Length mismatch at path '${o}'`);t.forEach(((n,i)=>{let c=`${o}[${i}]`;if("object"!=typeof n||Array.isArray(n)){if("function"==typeof n){if(!r.hasOwnProperty(i))throw new Error(`Missing schema for function at index ${i} in path '${c}'`);t[i]=(0,s.G)(n,{name:r[i].name,description:r[i].description||"",parameters:r[i].parameters})}}else e(n,r[i],c)}))}}else{n(t,r,o);for(let n in t){let i=t[n],c=`${o}.${n}`;if("object"!=typeof i||Array.isArray(i)){if("function"==typeof i){if(!r.hasOwnProperty(n))throw new Error(`Missing schema for function '${n}' at path '${c}'`);t[n]=(0,s.G)(i,{name:r[n].name,description:r[n].description||"",parameters:r[n].parameters})}}else e(i,r[n],c)}}}(e,t.definition),e}(e,await n.get_service_type(e.type))}catch(t){throw new Error(`Failed to get service type ${e.type}, error: ${t}`)}const c=this.add_service(e,i),a=this._extract_service_info(c);if(o)try{n=n||await this.get_manager_service({timeout:10,case_conversion:"camel"}),await n.registerService(a)}catch(e){throw new Error(`Failed to notify workspace manager: ${e}`)}return a}async unregister_service(e,t){let n;if(t=void 0===t||t,n="string"==typeof e?e:e.id,(0,r.vA)(n&&"string"==typeof n,`Invalid service id: ${n}`),n.includes(":")&&(n=n.split(":")[1]),n.includes("@")&&(n=n.split("@")[0]),!this._services[n])throw new Error(`Service not found: ${n}`);if(t){const e=await this.get_manager_service({timeout:10,case_conversion:"camel"});await e.unregisterService(n)}delete this._services[n]}_ndarray(e,t,n){const s=(0,r.D4)(e);if(n&&n!==s)throw"dtype doesn't match the type of the array: "+s+" != "+n;return t=t||[e.length],{_rtype:"ndarray",_rvalue:e.buffer,_rshape:t,_rdtype:s}}_encode_callback(e,t,n,r,s,o,i){let c=`${n}.${e}`,a={_rtype:"method",_rtarget:o?`${o}/${this._client_id}`:this._client_id,_rmethod:c,_rpromise:!1};const _=this;let l=function(){try{t.apply(null,Array.prototype.slice.call(arguments))}catch(e){console.error(`Error in callback(${c}, ${i}): ${e}`)}finally{s&&s.started&&s.clear(),r&&_._object_store[n]&&("resolve"===e||"reject"===e?delete _._object_store[n]:_._cleanup_session_if_needed(n,e))}};return l.__name__=`callback(${c})`,[a,l]}_cleanup_session_if_needed(e,t){if(e)try{const n=this._get_session_store(e,!1);if(!n)return void console.debug(`Session ${e} not found for cleanup`);let r=!1;if(n._promise_manager)try{const s=n._promise_manager;s.should_cleanup_on_callback&&s.should_cleanup_on_callback(t)&&(s.settle&&s.settle(),r=!0,console.debug(`Promise session ${e} settled and marked for cleanup`))}catch(t){console.warn(`Error in promise manager cleanup for session ${e}:`,t)}else("resolve"===t||"reject"===t)&&n._callbacks&&Object.keys(n._callbacks).includes(t)&&(r=!0,console.debug(`Regular session ${e} marked for cleanup after ${t}`));r&&this._cleanup_session_completely(e)}catch(t){console.warn(`Error during session cleanup for ${e}:`,t)}else console.debug("Cannot cleanup session: session_id is empty")}_cleanup_session_completely(e){try{const t=this._get_session_store(e,!1);if(!t)return void console.debug(`Session ${e} already cleaned up`);if(t.timer&&"function"==typeof t.timer.clear)try{t.timer.clear()}catch(t){console.warn(`Error clearing timer for session ${e}:`,t)}if(t.heartbeat_task&&"function"==typeof t.heartbeat_task.cancel)try{t.heartbeat_task.cancel()}catch(t){console.warn(`Error canceling heartbeat for session ${e}:`,t)}const n=e.split(".");let r=this._object_store;for(let t=0;t<n.length-1;t++){const s=n[t];if(!r[s])return void console.debug(`Session path ${e} not found at level ${s}`);r=r[s]}const s=n[n.length-1];r[s]&&(delete r[s],console.debug(`Cleaned up session ${e}`),this._cleanup_empty_containers(n.slice(0,-1)))}catch(t){console.warn(`Error in complete session cleanup for ${e}:`,t)}}_cleanup_empty_containers(e){try{for(let t=e.length-1;t>=0;t--){let n=this._object_store;for(let r=0;r<t;r++)if(n=n[e[r]],!n)return;const r=e[t],s=n[r];if(!s||"object"!=typeof s||0!==Object.keys(s).length)break;delete n[r],console.debug(`Cleaned up empty container at depth ${t}: ${e.slice(0,t+1).join(".")}`)}}catch(e){console.warn("Error cleaning up empty containers:",e)}}get_session_stats(){const e={total_sessions:0,promise_sessions:0,regular_sessions:0,sessions_with_timers:0,sessions_with_heartbeat:0,system_stores:{},session_ids:[],memory_usage:0};if(!this._object_store)return e;for(const t in this._object_store){const n=this._object_store[t];["services","message_cache"].includes(t)?e.system_stores[t]={size:"object"==typeof n&&n?Object.keys(n).length:0}:n&&"object"==typeof n&&Object.keys(n).length>0&&(e.total_sessions++,e.session_ids.push(t),n._promise_manager?e.promise_sessions++:e.regular_sessions++,(n._timer||n.timer)&&e.sessions_with_timers++,(n._heartbeat||n.heartbeat)&&e.sessions_with_heartbeat++,e.memory_usage+=JSON.stringify(n).length)}return e}_force_cleanup_all_sessions(){if(!this._object_store)return void console.debug("Force cleaning up 0 sessions");let e=0;const t=[];for(const n in this._object_store)if(!["services","message_cache"].includes(n)){const r=this._object_store[n];r&&"object"==typeof r&&Object.keys(r).length>0&&(t.push(n),e++)}for(const e of t)delete this._object_store[e];console.debug(`Force cleaning up ${e} sessions`)}_is_promise_method_call(e){const t=e.split(".")[0],n=this._get_session_store(t,!1);return n&&n._promise_manager}_create_promise_manager(){return{should_cleanup_on_callback:e=>["resolve","reject"].includes(e),settle:()=>{console.debug("Promise settled")}}}async _encode_promise(e,t,n,r,s,o,i){let c=this._get_session_store(n,!0);c||(console.warn(`Failed to create session store ${n}, session management may be impaired`),c={}),c._promise_manager=this._create_promise_manager();let a={};return s&&t&&this._method_timeout?([a.heartbeat,c.heartbeat]=this._encode_callback("heartbeat",s.reset.bind(s),n,!1,null,o),c.timer=s,a.interval=this._method_timeout/2):s=null,[a.resolve,c.resolve]=this._encode_callback("resolve",e,n,r,s,o,`resolve (${i})`),[a.reject,c.reject]=this._encode_callback("reject",t,n,r,s,o,`reject (${i})`),a}async _send_chunks(e,t,n){const s=await this.get_remote_service(`${t}:built-in`);if(!s.message_cache)throw new Error("Remote client does not support message caching for large messages.");const o=s.message_cache,i=n||(0,r.bq)(),c=e.length,a=Date.now(),_=Math.ceil(c/this._long_message_chunk_size);if(s.config.api_version>=3){await o.create(i,!!n);const t=new r.jf(30),s=[];for(let r=0;r<_;r++){const c=r*this._long_message_chunk_size,a=e.slice(c,c+this._long_message_chunk_size),_=async()=>{await o.set(i,r,a,!!n)};s.push(t.run(_))}try{await Promise.all(s)}catch(e){try{await o.remove(i)}catch(e){console.error(`Failed to clean up message cache after error: ${e}`)}throw e}}else{await o.create(i,!!n);for(let t=0;t<_;t++){const r=t*this._long_message_chunk_size,s=e.slice(r,r+this._long_message_chunk_size);await o.append(i,s,!!n)}}await o.process(i,!!n),((Date.now()-a)/1e3).toFixed(2)}emit(e,t){if((0,r.vA)("object"==typeof e&&e.type,"Invalid message, must be an object with a `type` fields."),!e.to)return void this._fire(e.type,e);let n=(0,i.l)(e);if(t){const e=(0,i.l)(t);n=new Uint8Array([...n,...e])}const s=n.length;return s>this._long_message_chunk_size+1024&&console.warn(`Sending large message (size=${s})`),this._emit_message(n)}_generate_remote_method(e,t,n,s,o){let c=e._rtarget;s&&!c.includes("/")&&(c.startsWith("*/")||(s!==c&&(c=s+"/"+c),e._rtarget=c));let a=e._rmethod,_=e._rpromise||!1;const l=`method: ${a}, docs: ${e._rdoc}`,h=this;function d(){return new Promise((async(e,s)=>{let u=(0,r.bq)();n&&(u=n+"."+u);let f=h._get_session_store(u,!0);if(!f)return void s(new Error(`Runtime Error: Failed to get session store ${u} (context: ${l})`));f.target_id=c;const m=await h._encode(Array.prototype.slice.call(arguments),u,o),y=m.length,g=y>0&&"object"==typeof m[y-1]&&null!==m[y-1]&&m[y-1]._rkwargs;let w;g&&delete m[y-1]._rkwargs,w=h._local_workspace?h._local_workspace+"/"+h._client_id:h._client_id;let v={type:"method",from:w,to:c,method:a},b={};m&&(b.args=m),g&&(b.with_kwargs=g),t&&(v.parent=t);let k=null;if(_){v.session=u;let S=`${c}:${a}`;const j=function(e){s(e),h._object_store[u]&&(delete h._object_store[u],console.debug(`Cleaned up session ${u} after timeout`))};function A(e){return!(!e||"object"!=typeof e)&&(!0===e._rintf||(Array.isArray(e)?e.some((e=>A(e))):e.constructor===Object&&Object.values(e).some((e=>A(e)))))}k=new p(h._method_timeout,j,[`Method call timed out: ${S}, context: ${l}`],S);let x=!A(m);const $=await h._encode_promise(e,s,u,x,k,o,l);if(!0===_)b.promise=$;else{if("*"!==_)throw new Error(`Unsupported promise type: ${_}`);b.promise="*",b.t=h._method_timeout/2}}let E=(0,i.l)(v);if(b){const U=(0,i.l)(b);E=new Uint8Array([...E,...U])}E.length<=h._long_message_chunk_size+1024||d.__no_chunk__?h._emit_message(E).then((function(){k&&k.start()})).catch((function(e){const t=`Failed to send the request when calling method (${c}:${a}), error: ${e}`;s?s(new Error(t)):console.warn("Unhandled RPC method call error:",t),k&&k.clear()})):h._send_chunks(E,c,t).then((function(){k&&k.start()})).catch((function(e){const t=`Failed to send the request when calling method (${c}:${a}), error: ${e}`;s?s(new Error(t)):console.warn("Unhandled RPC method call error:",t),k&&k.clear()}))}))}d.__rpc_object__=e;const u=a.split(".");return d.__name__=e._rname||u[u.length-1],d.__name__.includes("#")&&(d.__name__=d.__name__.split("#")[1]),d.__doc__=e._rdoc||`Remote method: ${a}`,d.__schema__=e._rschema,d.__no_chunk__="services.built-in.message_cache.append"===e._rmethod,d}get_client_info(){const e=[];for(let t of Object.values(this._services))e.push(this._extract_service_info(t));return{id:this._client_id,services:e}}async _handle_method(e){let t=null;try{(0,r.vA)(e.method&&e.ctx&&e.from);const n=e.from+":"+e.method,s=e.from.split("/")[0],o=e.from.split("/")[1];let i;e.to=e.to.includes("/")?e.to:s+"/"+e.to,e.ctx.to=e.to,this._local_workspace?(this._local_workspace&&"*"!==this._local_workspace&&(0,r.vA)(e.to.split("/")[0]===this._local_workspace,"Workspace mismatch: "+e.to.split("/")[0]+" != "+this._local_workspace),i=this._local_workspace):i=e.to.split("/")[0];const c=e.parent;let a,_,l,d;if(e.promise){const p=await this._decode("*"===e.promise?this._expand_promise(e):e.promise,e.session,c,s,i);if(a=p.resolve,_=p.reject,p.heartbeat&&p.interval){async function u(){try{await p.heartbeat()}catch(e){console.error(e)}}if(t=setInterval(u,1e3*p.interval),e.session){const f=this._get_session_store(e.session,!1);f&&(f.heartbeat_task=t)}}}try{l=h(this._object_store,e.method)}catch(m){if(this._is_promise_method_call(e.method))return void console.debug(`Promise method ${e.method} not available (detected by session type), ignoring: ${n}`);const y=e.method.split(".");if(y.length>1){const w=y[0];return w in this._object_store?(console.debug(`Session ${w} exists but method ${e.method} not found, likely expired callback: ${n}`),void("function"==typeof _&&_(new Error(`Method expired or not found: ${n}`)))):(console.debug(`Session ${w} not found for method ${e.method}, likely cleaned up: ${n}`),void("function"==typeof _&&_(new Error(`Session not found: ${n}`))))}console.debug(`Failed to find method ${n} at ${this._client_id}`);const g=new Error(`Method not found: ${n} at ${this._client_id}`);return void("function"==typeof _?_(g):console.warn("Method not found and no reject callback:",g.message))}if((0,r.vA)(l&&"function"==typeof l,"Invalid method: "+n),this._method_annotations.has(l)){if("protected"===this._method_annotations.get(l).visibility)if(i===s);else if(this._method_annotations.get(l).authorized_workspaces&&this._method_annotations.get(l).authorized_workspaces.includes(s));else if("*"!==s||o!==this._connection.manager_id)throw new Error("Permission denied for invoking protected method "+n+", workspace mismatch: "+i+" != "+s)}else{let v=this._object_store[e.method.split(".")[0]].target_id;if(i===s&&v&&-1===v.indexOf("/")&&(v=i+"/"+v),v!==e.from)throw new Error("Access denied for method call ("+n+") from "+e.from+" to target "+v)}if(c&&(0,r.vA)(null!==this._get_session_store(c,!0),"Parent session was closed: "+c),d=e.args?await this._decode(e.args,e.session,null,s,null):[],this._method_annotations.has(l)&&this._method_annotations.get(l).require_context){if(d.length+1<l.length)for(let b=d.length;b<l.length-1;b++)d.push(void 0);d.push(e.ctx)}if(e.promise){const k=l.apply(null,d);k instanceof Promise?k.then((e=>{a(e),clearInterval(t)})).catch((e=>{_(e),clearInterval(t)})):(a(k),clearInterval(t))}else l.apply(null,d),clearInterval(t)}catch(E){console.error("Error during calling method: ",E),clearInterval(t)}}encode(e,t){return this._encode(e,t)}_get_session_store(e,t){if(!e)return null;let n=this._object_store;const r=e.split(".");if(t){const e=r.length-1;for(let t of r.slice(0,e))n[t]||(n[t]={}),n=n[t];return n[r[e]]||(n[r[e]]={}),n[r[e]]}for(let e of r){if(!n[e])return null;n=n[e]}return n}async _encode(e,t,n){const s=typeof e;if("number"===s||"string"===s||"boolean"===s||null==e||e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return{_rtype:"memoryview",_rvalue:new Uint8Array(e)};if(e.__rpc_object__&&(e.__rpc_object__._rserver||this._server_base_url)===this._server_base_url)return e.__rpc_object__;let o;if(e.constructor instanceof Object&&e._rtype){const c=e._rtype;return delete e._rtype,o=await this._encode(e,t,n),o._rtype=c,o}if((0,r.WH)(e)||(0,r.aU)(e)){(0,r.vA)(t&&"string"==typeof t,"Session ID is required for generator encoding");const _=(0,r.bq)(),l=this._get_session_store(t,!0);(0,r.vA)(null!==l,`Failed to create session store ${t} due to invalid parent`);const h=(0,r.aU)(e),d=async()=>{if(h){const t=e,n=await t.next();return n.done?(delete l[_],{_rtype:"stop_iteration"}):n.value}{const t=e.next();return t.done?(delete l[_],{_rtype:"stop_iteration"}):t.value}};return l[_]=d,o={_rtype:"generator",_rserver:this._server_base_url,_rtarget:this._client_id,_rmethod:`${t}.${_}`,_rpromise:"*",_rdoc:"Remote generator"},o}if("function"==typeof e){if(this._method_annotations.has(e)){let p=this._method_annotations.get(e);o={_rtype:"method",_rserver:this._server_base_url,_rtarget:this._client_id,_rmethod:p.method_id,_rpromise:"*",_rname:e.name}}else{let f;(0,r.vA)("string"==typeof t),f=e.__name__?`${(0,r.bq)()}#${e.__name__}`:(0,r.bq)(),o={_rtype:"method",_rserver:this._server_base_url,_rtarget:this._client_id,_rmethod:`${t}.${f}`,_rpromise:"*",_rname:e.name};let m=this._get_session_store(t,!0);(0,r.vA)(null!==m,`Failed to create session store ${t} due to invalid parent`),m[f]=e}if(o._rdoc=e.__doc__,!o._rdoc)try{const y=function(e){const t=e.toString(),n=t.match(/function\s*(\w*)/),r=n&&n[1]||"",s=t.match(/\(([^)]*)\)/);let o="";s&&(o=s[1].split(",").map((e=>e.replace(/\/\*.*?\*\//g,"").replace(/\/\/.*$/g,""))).filter((e=>e.trim().length>0)).map((e=>e.trim())).join(", "));let i=t.match(/\)\s*\{\s*\/\*([\s\S]*?)\*\//);const c=i&&i[1].trim()||"";i=t.match(/\)\s*\{\s*(\/\/[\s\S]*?)\n\s*[^\s\/]/);const a=i&&i[1].split("\n").map((e=>e.replace(/^\/\/\s*/,"").trim())).join("\n")||"",_=c||a;return r&&o.length>0&&{name:r,sig:o,doc:_}}(e);y&&!o._rdoc&&(o._rdoc=`${y.doc}`)}catch(g){console.error("Failed to extract function docstring:",e)}return o._rschema=e.__schema__,o}const i=Array.isArray(e);for(let w of Object.keys(this._codecs)){const v=this._codecs[w];if(v.encoder&&e instanceof v.type){let b=await Promise.resolve(v.encoder(e));if(b&&!b._rtype&&(b._rtype=v.name),"object"==typeof b){const k=b._rtype;delete b._rtype,b=await this._encode(b,t,n),b._rtype=k}return o=b,o}}if("undefined"!=typeof tf&&tf.Tensor&&e instanceof tf.Tensor){const E=e.dataSync();o={_rtype:"ndarray",_rvalue:new Uint8Array(E.buffer),_rshape:e.shape,_rdtype:e.dtype}}else if("undefined"!=typeof nj&&nj.NdArray&&e instanceof nj.NdArray){if(!e.selection||!e.selection.data)throw new Error("Invalid NumJS array: missing selection or data");const S=(0,r.D4)(e.selection.data);o={_rtype:"ndarray",_rvalue:new Uint8Array(e.selection.data.buffer),_rshape:e.shape,_rdtype:S}}else if(e instanceof Error)console.error(e),o={_rtype:"error",_rvalue:e.toString(),_rtrace:e.stack};else if(e!==Object(e)||e instanceof Boolean||e instanceof String||e instanceof Date||e instanceof RegExp||"undefined"!=typeof ImageData&&e instanceof ImageData||"undefined"!=typeof FileList&&e instanceof FileList||"undefined"!=typeof FileSystemDirectoryHandle&&e instanceof FileSystemDirectoryHandle||"undefined"!=typeof FileSystemFileHandle&&e instanceof FileSystemFileHandle||"undefined"!=typeof FileSystemHandle&&e instanceof FileSystemHandle||"undefined"!=typeof FileSystemWritableFileStream&&e instanceof FileSystemWritableFileStream)o=e;else if(e instanceof Blob){let j=0;async function A(t){let n;n=t?e.slice(j,j+t):e.slice(j);const r=new Uint8Array(await n.arrayBuffer());return j+=r.byteLength,r}function x(e){j=e}o={_rtype:"iostream",_rnative:"js:blob",type:e.type,name:e.name,size:e.size,path:e._path||e.webkitRelativePath,read:await this._encode(A,t,n),seek:await this._encode(x,t,n)}}else if(e instanceof a){const $=(0,r.D4)(e);o={_rtype:"typedarray",_rvalue:new Uint8Array(e.buffer),_rdtype:$}}else if(e instanceof DataView)o={_rtype:"memoryview",_rvalue:new Uint8Array(e.buffer)};else if(e instanceof Set)o={_rtype:"set",_rvalue:await this._encode(Array.from(e),t,n)};else if(e instanceof Map)o={_rtype:"orderedmap",_rvalue:await this._encode(Array.from(e),t,n)};else{if(!(e.constructor===Object||Array.isArray(e)||e instanceof u))throw`hypha-rpc: Unsupported data type: ${e}, you can register a custom codec to encode/decode the object.`;{o=i?[]:{};const U=Object.keys(e);for(let O of U)o[O]=await this._encode(e[O],t,n)}}if(!o)throw new Error("Failed to encode object");return o}async decode(e){return await this._decode(e)}async _decode(e,t,n,s,o){if(!e)return e;let i;if(e._rtype)if(this._codecs[e._rtype]&&this._codecs[e._rtype].decoder){const c=e._rtype;delete e._rtype,(e=await this._decode(e,t,n,s,o))._rtype=c,i=await Promise.resolve(this._codecs[e._rtype].decoder(e))}else if("method"===e._rtype)i=this._generate_remote_method(e,t,n,s,o);else if("generator"===e._rtype){const a=this._generate_remote_method(e,t,n,s,o);async function*l(){for(;;)try{const e=await a();if(e&&"stop_iteration"===e._rtype)break;yield e}catch(e){throw console.error("Error in generator:",e),e}}i=l()}else if("ndarray"===e._rtype)if("undefined"!=typeof nj&&nj.array)Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(_)),i=nj.array(new Uint8(e._rvalue),e._rdtype).reshape(e._rshape);else if("undefined"!=typeof tf&&tf.Tensor){Array.isArray(e._rvalue)&&(e._rvalue=e._rvalue.reduce(_));const h=r.RR[e._rdtype];i=tf.tensor(new h(e._rvalue),e._rshape,e._rdtype)}else i=e;else if("error"===e._rtype)i=new Error("RemoteError: "+e._rvalue+"\n"+(e._rtrace||""));else if("typedarray"===e._rtype){const d=r.RR[e._rdtype];if(!d)throw new Error("unsupported dtype: "+e._rdtype);i=new d(e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength))}else if("memoryview"===e._rtype)i=e._rvalue.buffer.slice(e._rvalue.byteOffset,e._rvalue.byteOffset+e._rvalue.byteLength);else if("iostream"===e._rtype){if("js:blob"===e._rnative){const p=await this._generate_remote_method(e.read,t,n,s,o),u=await p();i=new Blob([u],{type:e.type,name:e.name})}else{i={};for(let f of Object.keys(e))f.startsWith("_")||(i[f]=await this._decode(e[f],t,n,s,o))}i.__rpc_object__=e}else if("orderedmap"===e._rtype)i=new Map(await this._decode(e._rvalue,t,n,s,o));else if("set"===e._rtype)i=new Set(await this._decode(e._rvalue,t,n,s,o));else{const m=e._rtype;delete e._rtype,i=await this._decode(e,t,n,s,o),i._rtype=m}else if(e.constructor===Object||Array.isArray(e)){const y=Array.isArray(e);i=y?[]:{};for(let g of Object.keys(e))if(y||e.hasOwnProperty(g)){const w=e[g];i[g]=await this._decode(w,t,n,s,o)}}else i=e;if(void 0===i)throw new Error("Failed to decode object");return i}_expand_promise(e){return{heartbeat:{_rtype:"method",_rtarget:e.from.split("/")[1],_rmethod:e.session+".heartbeat",_rdoc:`heartbeat callback for method: ${e.method}`},resolve:{_rtype:"method",_rtarget:e.from.split("/")[1],_rmethod:e.session+".resolve",_rdoc:`resolve callback for method: ${e.method}`},reject:{_rtype:"method",_rtarget:e.from.split("/")[1],_rmethod:e.session+".reject",_rdoc:`reject callback for method: ${e.method}`},interval:e.t}}}},878:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{function randId(){return Math.random().toString(36).substr(2,10)+(new Date).getTime()}function toCamelCase(e){return e.includes("_")?e.replace(/_./g,(e=>e[1].toUpperCase())):e}function toSnakeCase(e){return e.replace(/([A-Z])/g,"_$1").toLowerCase()}function expandKwargs(e){if("object"!=typeof e||null===e)return e;const t=Array.isArray(e)?[]:{};for(const n in e)if(e.hasOwnProperty(n)){const r=e[n];"function"==typeof r?(t[n]=(...e)=>{if(0===e.length)throw new Error(`Function "${n}" expects at least one argument.`);const t=e[e.length-1];let s={};return"object"!=typeof t||null===t||Array.isArray(t)||(s={...t,_rkwarg:!0},e=e.slice(0,-1)),r(...e,s)},t[n].__name__=n,r.__schema__&&(t[n].__schema__={...r.__schema__},t[n].__schema__.name=n)):t[n]=expandKwargs(r)}return t}function convertCase(e,t){if("object"!=typeof e||null===e||!t)return e;const n=Array.isArray(e)?[]:{};for(const r in e)if(e.hasOwnProperty(r)){const s=e[r],o=toCamelCase(r),i=toSnakeCase(r);"camel"===t?(n[o]=convertCase(s,t),"function"==typeof s&&(n[o].__name__=o,s.__schema__&&(n[o].__schema__={...s.__schema__},n[o].__schema__.name=o))):"snake"===t?(n[i]=convertCase(s,t),"function"==typeof s&&(n[i].__name__=i,s.__schema__&&(n[i].__schema__={...s.__schema__},n[i].__schema__.name=i))):(t.includes("camel")&&(n[o]=convertCase(s,"camel")),t.includes("snake")&&(n[i]=convertCase(s,"snake")))}return n}function parseServiceUrl(e){e=e.replace(/\/$/,"");const t=new RegExp("^(https?:\\/\\/[^/]+)\\/([a-z0-9_-]+)\\/services\\/(?:(?<clientId>[a-zA-Z0-9_-]+):)?(?<serviceId>[a-zA-Z0-9_-]+)(?:@(?<appId>[a-zA-Z0-9_-]+))?"),n=e.match(t);if(!n)throw new Error("URL does not match the expected pattern");const r=n[1],s=n[2],o=n.groups?.clientId||"*",i=n.groups?.serviceId;return{serverUrl:r,workspace:s,clientId:o,serviceId:i,appId:n.groups?.appId||"*"}}__webpack_require__.d(__webpack_exports__,{D4:()=>typedArrayToDtype,RR:()=>dtypeToTypedArray,V0:()=>loadRequirements,WH:()=>isGenerator,aU:()=>isAsyncGenerator,bq:()=>randId,fm:()=>waitFor,gX:()=>convertCase,iO:()=>parseServiceUrl,jf:()=>Semaphore,sw:()=>MessageEmitter,uX:()=>expandKwargs,vA:()=>assert});const dtypeToTypedArray={int8:Int8Array,int16:Int16Array,int32:Int32Array,uint8:Uint8Array,uint16:Uint16Array,uint32:Uint32Array,float32:Float32Array,float64:Float64Array,array:Array};async function loadRequirementsInWindow(e){function t(e){return new Promise(((t,n)=>{var r=document.createElement("script");r.src=e,r.type="text/javascript",r.onload=t,r.onreadystatechange=function(){"loaded"!==this.readyState&&"complete"!==this.readyState||t()},r.onerror=n,document.head.appendChild(r)}))}async function n(){for(var e=Array.prototype.slice.call(arguments),n=e.length,r=0;r<n;r++)await t(e[r])}if(e&&(Array.isArray(e)||"string"==typeof e))try{var r;if(e="string"==typeof e?[e]:e,!Array.isArray(e))throw"unsupported requirements definition";for(var s=0;s<e.length;s++)e[s].toLowerCase().endsWith(".css")||e[s].startsWith("css:")?(e[s].startsWith("css:")&&(e[s]=e[s].slice(4)),(r=document.createElement("link")).rel="stylesheet",r.href=e[s],document.head.appendChild(r)):e[s].toLowerCase().endsWith(".mjs")||e[s].startsWith("mjs:")?(e[s].startsWith("mjs:")&&(e[s]=e[s].slice(4)),await import(e[s])):e[s].toLowerCase().endsWith(".js")||e[s].startsWith("js:")?(e[s].startsWith("js:")&&(e[s]=e[s].slice(3)),await n(e[s])):e[s].startsWith("http")?await n(e[s]):e[s].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[s])}catch(t){throw"failed to import required scripts: "+e.toString()}}async function loadRequirementsInWebworker(e){if(e&&(Array.isArray(e)||"string"==typeof e))try{Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;t++){if(e[t].toLowerCase().endsWith(".css")||e[t].startsWith("css:"))throw"unable to import css in a webworker";e[t].toLowerCase().endsWith(".js")||e[t].startsWith("js:")?(e[t].startsWith("js:")&&(e[t]=e[t].slice(3)),importScripts(e[t])):e[t].startsWith("http")?importScripts(e[t]):e[t].startsWith("cache:")||console.log("Unprocessed requirements url: "+e[t])}}catch(t){throw"failed to import required scripts: "+e.toString()}}function loadRequirements(e){return"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?loadRequirementsInWebworker(e):loadRequirementsInWindow(e)}function normalizeConfig(e){return e.version=e.version||"0.1.0",e.description=e.description||`[TODO: add description for ${e.name} ]`,e.type=e.type||"rpc-window",e.id=e.id||randId(),e.target_origin=e.target_origin||"*",e.allow_execution=e.allow_execution||!1,e=Object.keys(e).reduce(((t,n)=>("function"!=typeof e[n]&&(t[n]=e[n]),t)),{})}const typedArrayToDtypeMapping={Int8Array:"int8",Int16Array:"int16",Int32Array:"int32",Uint8Array:"uint8",Uint16Array:"uint16",Uint32Array:"uint32",Float32Array:"float32",Float64Array:"float64",Array:"array"},typedArrayToDtypeKeys=[];for(const arrType of Object.keys(typedArrayToDtypeMapping))typedArrayToDtypeKeys.push(eval(arrType));function typedArrayToDtype(e){let t=typedArrayToDtypeMapping[e.constructor.name];if(!t){const n=Object.getPrototypeOf(e);for(const e of typedArrayToDtypeKeys)if(n instanceof e){t=typedArrayToDtypeMapping[e.name];break}}return t}function cacheUrlInServiceWorker(e){return new Promise((function(t,n){const r={command:"add",url:e};if(!navigator.serviceWorker||!navigator.serviceWorker.register)return void n("Service worker is not supported.");const s=new MessageChannel;s.port1.onmessage=function(e){e.data&&e.data.error?n(e.data.error):t(e.data&&e.data.result)},navigator.serviceWorker&&navigator.serviceWorker.controller?navigator.serviceWorker.controller.postMessage(r,[s.port2]):n("Service worker controller is not available")}))}async function cacheRequirements(e){e=e||[],Array.isArray(e)||(e=[e]);for(let t of e)t.startsWith("js:")&&(t=t.slice(3)),t.startsWith("css:")&&(t=t.slice(4)),t.startsWith("cache:")&&(t=t.slice(6)),t.startsWith("http")&&await cacheUrlInServiceWorker(t).catch((e=>{console.error(e)}))}function assert(e,t){if(!e)throw new Error(t||"Assertion failed")}function urlJoin(...e){return e.join("/").replace(/[\/]+/g,"/").replace(/^(.+):\//,"$1://").replace(/^file:/,"file:/").replace(/\/(\?|&|#[^!])/g,"$1").replace(/\?/g,"&").replace("&","?")}function waitFor(e,t,n){let r;return Promise.race([e,new Promise(((e,s)=>r=setTimeout((()=>{s(n||"Timeout Error")}),1e3*t)))]).finally((()=>clearTimeout(r)))}class MessageEmitter{constructor(e){this._event_handlers={},this._once_handlers={},this._debug=e}emit(){throw new Error("emit is not implemented")}on(e,t){this._event_handlers[e]||(this._event_handlers[e]=[]),this._event_handlers[e].push(t)}once(e,t){t.___event_run_once=!0,this.on(e,t)}off(e,t){if(e||t){if(e&&!t)this._event_handlers[e]&&(this._event_handlers[e]=[]);else if(this._event_handlers[e]){const n=this._event_handlers[e].indexOf(t);n>=0&&this._event_handlers[e].splice(n,1)}}else this._event_handlers={}}_fire(e,t){if(this._event_handlers[e])for(var n=this._event_handlers[e].length;n--;){const r=this._event_handlers[e][n];try{r(t)}catch(e){console.error(e)}finally{r.___event_run_once&&this._event_handlers[e].splice(n,1)}}else this._debug&&console.warn("unhandled event",e,t)}waitFor(e,t){return new Promise(((n,r)=>{const s=e=>{clearTimeout(o),n(e)};this.once(e,s);const o=setTimeout((()=>{this.off(e,s),r(new Error("Timeout"))}),1e3*t)}))}}class Semaphore{constructor(e){this.max=e,this.queue=[],this.current=0}async run(e){this.current>=this.max&&await new Promise((e=>this.queue.push(e))),this.current++;try{return await e()}finally{this.current--,this.queue.length>0&&this.queue.shift()()}}}function isGenerator(e){return!!e&&"object"==typeof e&&"function"==typeof e.next&&"function"==typeof e.throw&&"function"==typeof e.return}function isAsyncGenerator(e){return!!e&&"object"==typeof e&&"function"==typeof e.next&&"function"==typeof e.throw&&"function"==typeof e.return&&Symbol.asyncIterator in Object(e)&&"AsyncGenerator"===e[Symbol.toStringTag]}},287:(e,t,n)=>{n.d(t,{G:()=>o});var r=n(878);const s={object:e=>({type:"object",properties:e,required:Object.keys(e).filter((t=>!e[t]._optional))}),string:()=>({type:"string",_optional:!1}),number:()=>({type:"number",_optional:!1}),integer:()=>({type:"integer",_optional:!1}),boolean:()=>({type:"boolean",_optional:!1}),array:e=>({type:"array",items:e,_optional:!1}),optional:e=>({...e,_optional:!0})};function o(e,{schema_type:t="auto",name:n=null,description:s=null,parameters:o=null}){if(!e||"function"!=typeof e)throw Error("func should be a function");(0,r.vA)("auto"===t,"schema_type should be auto");const i=n||e.name;(0,r.vA)(i,"name should not be null");let c=o;if(o&&"object"==typeof o&&"object"===o.type){c={type:"object",properties:o.properties||{},required:o.required||[]};for(const[e,t]of Object.entries(c.properties))void 0!==t._optional&&delete t._optional}return(0,r.vA)(c&&"object"===c.type,"parameters should be an object schema"),e.__schema__={name:i,description:s||"",parameters:c},e}["string","number","integer","boolean","array"].forEach((e=>{s[e]=()=>{const t={type:"integer"===e?"integer":e,_optional:!1,describe:e=>({...t,description:e})};return t}}))},831:(e,t,n)=>{n.d(t,{b:()=>a,e:()=>_});var r=n(887),s=n(878),o=n(287);class i{constructor(e){this._data_channel=e,this._handle_message=null,this._reconnection_token=null,this._handle_disconnected=null,this._handle_connected=()=>{},this.manager_id=null,this._last_message=null,this._data_channel.onopen=async()=>{this._last_message&&(console.info("Resending last message after connection established"),this._data_channel.send(this._last_message),this._last_message=null),this._handle_connected&&this._handle_connected({channel:this._data_channel})},this._data_channel.onmessage=async e=>{let t=e.data;t instanceof Blob&&(t=await t.arrayBuffer()),this._handle_message(t)};const t=this;this._data_channel.onclose=function(){this._handle_disconnected&&this._handle_disconnected("closed"),console.log("websocket closed"),t._data_channel=null}}on_disconnected(e){this._handle_disconnected=e}on_connected(e){this._handle_connected=e}on_message(e){(0,s.vA)(e,"handler is required"),this._handle_message=e}async emit_message(e){(0,s.vA)(this._handle_message,"No handler for message");try{this._last_message=e,this._data_channel.send(e),this._last_message=null}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}async disconnect(e){this._last_message=null,this._data_channel=null,console.info(`data channel connection disconnected (${e})`)}}async function c(e){(0,s.vA)(e.channel,"No channel provided"),(0,s.vA)(e.workspace,"No workspace provided");const t=e.channel,n=e.client_id||(0,s.bq)(),o=new i(t);return e.context=e.context||{},e.context.connection_type="webrtc",e.context.ws=e.workspace,new r.y(o,{client_id:n,default_context:e.context,name:e.name,method_timeout:e.method_timeout||10,workspace:e.workspace,app_id:e.app_id,long_message_chunk_size:e.long_message_chunk_size})}async function a(e,t,n){(n=n||{}).peer_id=n.peer_id||(0,s.bq)();const r=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});return new Promise((async(i,a)=>{let _=!1;const l=setTimeout((()=>{_||(_=!0,r.close(),a(new Error("WebRTC Connection timeout")))}),3e4);try{r.addEventListener("connectionstatechange",(()=>{console.log("WebRTC Connection state: ",r.connectionState),"failed"===r.connectionState?_||(_=!0,clearTimeout(l),r.close(),a(new Error("WebRTC Connection failed"))):"closed"===r.connectionState?_||(_=!0,clearTimeout(l),a(new Error("WebRTC Connection closed"))):"connected"===r.connectionState&&console.log("WebRTC Connection established successfully")}),!1),r.addEventListener("iceconnectionstatechange",(()=>{console.log("ICE Connection state: ",r.iceConnectionState),"failed"===r.iceConnectionState&&(_||(_=!0,clearTimeout(l),r.close(),a(new Error("ICE Connection failed"))))})),n.on_init&&(await n.on_init(r),delete n.on_init);let h=r.createDataChannel(n.peer_id,{ordered:!0});h.binaryType="arraybuffer";const d=await r.createOffer();await r.setLocalDescription(d),await new Promise((e=>{"complete"===r.iceGatheringState?e():(r.addEventListener("icegatheringstatechange",(()=>{"complete"===r.iceGatheringState&&e()})),setTimeout(e,5e3))}));const p=await e.getService(t),u=await p.offer({sdp:r.localDescription.sdp,type:r.localDescription.type});h.onopen=()=>{n.channel=h,n.workspace=u.workspace,setTimeout((async()=>{if(!_)try{const e=await c(n);async function t(t,...r){return(0,s.vA)(!t.includes(":"),"WebRTC service name should not contain ':'"),(0,s.vA)(!t.includes("/"),"WebRTC service name should not contain '/'"),await e.get_remote_service(n.workspace+"/"+n.peer_id+":"+t,...r)}async function h(){await e.disconnect(),r.close()}r.rpc=e,r.getService=(0,o.G)(t,{name:"getService",description:"Get a remote service via webrtc",parameters:{type:"object",properties:{service_id:{type:"string",description:"Service ID. This should be a service id in the format: 'workspace/service_id', 'workspace/client_id:service_id' or 'workspace/client_id:service_id@app_id'"},config:{type:"object",description:"Options for the service"}},required:["id"]}}),r.disconnect=(0,o.G)(h,{name:"disconnect",description:"Disconnect from the webrtc connection via webrtc",parameters:{type:"object",properties:{}}}),r.registerCodec=(0,o.G)(e.register_codec,{name:"registerCodec",description:"Register a codec for the webrtc connection",parameters:{type:"object",properties:{codec:{type:"object",description:"Codec to register",properties:{name:{type:"string"},type:{},encoder:{type:"function"},decoder:{type:"function"}}}}}}),_=!0,clearTimeout(l),i(r)}catch(d){_||(_=!0,clearTimeout(l),a(d))}}),1e3)},h.onclose=()=>{_||(_=!0,clearTimeout(l),a(new Error("Data channel closed")))},h.onerror=e=>{_||(_=!0,clearTimeout(l),a(new Error(`Data channel error: ${e}`)))},await r.setRemoteDescription(new RTCSessionDescription({sdp:u.sdp,type:u.type}))}catch(e){_||(_=!0,clearTimeout(l),a(e))}}))}async function _(e,t,n){const r=(n=n||{visibility:"protected",require_context:!0}).on_init;return delete n.on_init,await e.registerService({id:t,config:n,offer:(t,s)=>async function(e,t,n,r,s){n=n||{};let o=new RTCSessionDescription({sdp:e.sdp,type:e.type}),i=new RTCPeerConnection({iceServers:n.ice_servers||[{urls:["stun:stun.l.google.com:19302"]}],sdpSemantics:"unified-plan"});t&&i.addEventListener("datachannel",(async e=>{const n=e.channel;let r=null;s&&s.user&&(r={user:s.user,ws:s.ws}),(await c({channel:n,client_id:n.label,workspace:t.config.workspace,context:r}))._services=t.rpc._services})),r&&await r(i),await i.setRemoteDescription(o);let a=await i.createAnswer();return await i.setLocalDescription(a),await new Promise((e=>{"complete"===i.iceGatheringState?e():(i.addEventListener("icegatheringstatechange",(()=>{"complete"===i.iceGatheringState&&e()})),setTimeout(e,5e3))})),{sdp:i.localDescription.sdp,type:i.localDescription.type,workspace:t.config.workspace}}(t,e,n,r,s)})}},448:(e,t,n)=>{n.d(t,{X:()=>o});var r,s=(r=function(e,t){return r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},r(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),o=function(e){function t(n){var r=e.call(this,n)||this,s=Object.create(t.prototype);return Object.setPrototypeOf(r,s),Object.defineProperty(r,"name",{configurable:!0,enumerable:!1,value:t.name}),r}return s(t,e),t}(Error)},656:(e,t,n)=>{n.d(t,{g:()=>c});var r=function(e,t){this.type=e,this.data=t},s=n(448),o=n(989),i={type:-1,encode:function(e){var t,n,r,s;return e instanceof Date?function(e){var t,n=e.sec,r=e.nsec;if(n>=0&&r>=0&&n<=17179869183){if(0===r&&n<=4294967295){var s=new Uint8Array(4);return(t=new DataView(s.buffer)).setUint32(0,n),s}var i=n/4294967296,c=4294967295&n;return s=new Uint8Array(8),(t=new DataView(s.buffer)).setUint32(0,r<<2|3&i),t.setUint32(4,c),s}return s=new Uint8Array(12),(t=new DataView(s.buffer)).setUint32(0,r),(0,o._j)(t,4,n),s}((r=1e6*((t=e.getTime())-1e3*(n=Math.floor(t/1e3))),{sec:n+(s=Math.floor(r/1e9)),nsec:r-1e9*s})):null},decode:function(e){var t=function(e){var t=new DataView(e.buffer,e.byteOffset,e.byteLength);switch(e.byteLength){case 4:return{sec:t.getUint32(0),nsec:0};case 8:var n=t.getUint32(0);return{sec:4294967296*(3&n)+t.getUint32(4),nsec:n>>>2};case 12:return{sec:(0,o.eN)(t,4),nsec:t.getUint32(0)};default:throw new s.X("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(e.length))}}(e);return new Date(1e3*t.sec+t.nsec/1e6)}},c=function(){function e(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(i)}return e.prototype.register=function(e){var t=e.type,n=e.encode,r=e.decode;if(t>=0)this.encoders[t]=n,this.decoders[t]=r;else{var s=1+t;this.builtInEncoders[s]=n,this.builtInDecoders[s]=r}},e.prototype.tryToEncode=function(e,t){for(var n=0;n<this.builtInEncoders.length;n++)if(null!=(s=this.builtInEncoders[n])&&null!=(o=s(e,t)))return new r(-1-n,o);for(n=0;n<this.encoders.length;n++){var s,o;if(null!=(s=this.encoders[n])&&null!=(o=s(e,t)))return new r(n,o)}return e instanceof r?e:null},e.prototype.decode=function(e,t,n){var s=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return s?s(e,t,n):new r(t,e)},e.defaultCodec=new e,e}()},290:(e,t,n)=>{function r(e){return"".concat(e<0?"-":"","0x").concat(Math.abs(e).toString(16).padStart(2,"0"))}n.d(t,{D4:()=>v,UN:()=>b});var s=n(656),o=n(989),i=n(579),c=n(876),a=function(){function e(e,t){void 0===e&&(e=16),void 0===t&&(t=16),this.maxKeyLength=e,this.maxLengthPerKey=t,this.hit=0,this.miss=0,this.caches=[];for(var n=0;n<this.maxKeyLength;n++)this.caches.push([])}return e.prototype.canBeCached=function(e){return e>0&&e<=this.maxKeyLength},e.prototype.find=function(e,t,n){e:for(var r=0,s=this.caches[n-1];r<s.length;r++){for(var o=s[r],i=o.bytes,c=0;c<n;c++)if(i[c]!==e[t+c])continue e;return o.str}return null},e.prototype.store=function(e,t){var n=this.caches[e.length-1],r={bytes:e,str:t};n.length>=this.maxLengthPerKey?n[Math.random()*n.length|0]=r:n.push(r)},e.prototype.decode=function(e,t,n){var r=this.find(e,t,n);if(null!=r)return this.hit++,r;this.miss++;var s=(0,i.Zf)(e,t,n),o=Uint8Array.prototype.slice.call(e,t,t+n);return this.store(o,s),s},e}(),_=n(448),l=function(e,t){var n,r,s,o,i={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;i;)try{if(n=1,r&&(s=2&o[0]?r.return:o[0]?r.throw||((s=r.return)&&s.call(r),0):r.next)&&!(s=s.call(r,o[1])).done)return s;switch(r=0,s&&(o=[2&o[0],s.value]),o[0]){case 0:case 1:s=o;break;case 4:return i.label++,{value:o[1],done:!1};case 5:i.label++,r=o[1],o=[0];continue;case 7:o=i.ops.pop(),i.trys.pop();continue;default:if(!((s=(s=i.trys).length>0&&s[s.length-1])||6!==o[0]&&2!==o[0])){i=0;continue}if(3===o[0]&&(!s||o[1]>s[0]&&o[1]<s[3])){i.label=o[1];break}if(6===o[0]&&i.label<s[1]){i.label=s[1],s=o;break}if(s&&i.label<s[2]){i.label=s[2],i.ops.push(o);break}s[2]&&i.ops.pop(),i.trys.pop();continue}o=t.call(e,i)}catch(e){o=[6,e],r=0}finally{n=s=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}},h=function(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,n=e[Symbol.asyncIterator];return n?n.call(e):(e="function"==typeof __values?__values(e):e[Symbol.iterator](),t={},r("next"),r("throw"),r("return"),t[Symbol.asyncIterator]=function(){return this},t);function r(n){t[n]=e[n]&&function(t){return new Promise((function(r,s){!function(e,t,n,r){Promise.resolve(r).then((function(t){e({value:t,done:n})}),t)}(r,s,(t=e[n](t)).done,t.value)}))}}},d=function(e){return this instanceof d?(this.v=e,this):new d(e)},p=new DataView(new ArrayBuffer(0)),u=new Uint8Array(p.buffer),f=function(){try{p.getInt8(0)}catch(e){return e.constructor}throw new Error("never reached")}(),m=new f("Insufficient data"),y=new a,g=function(){function e(e,t,n,r,i,c,a,_){void 0===e&&(e=s.g.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=o.f7),void 0===r&&(r=o.f7),void 0===i&&(i=o.f7),void 0===c&&(c=o.f7),void 0===a&&(a=o.f7),void 0===_&&(_=y),this.extensionCodec=e,this.context=t,this.maxStrLength=n,this.maxBinLength=r,this.maxArrayLength=i,this.maxMapLength=c,this.maxExtLength=a,this.keyDecoder=_,this.totalPos=0,this.pos=0,this.view=p,this.bytes=u,this.headByte=-1,this.stack=[]}return e.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},e.prototype.setBuffer=function(e){this.bytes=(0,c.C)(e),this.view=(0,c.o)(this.bytes),this.pos=0},e.prototype.appendBuffer=function(e){if(-1!==this.headByte||this.hasRemaining(1)){var t=this.bytes.subarray(this.pos),n=(0,c.C)(e),r=new Uint8Array(t.length+n.length);r.set(t),r.set(n,t.length),this.setBuffer(r)}else this.setBuffer(e)},e.prototype.hasRemaining=function(e){return this.view.byteLength-this.pos>=e},e.prototype.createExtraByteError=function(e){var t=this.view,n=this.pos;return new RangeError("Extra ".concat(t.byteLength-n," of ").concat(t.byteLength," byte(s) found at buffer[").concat(e,"]"))},e.prototype.decode=function(e){this.reinitializeState(),this.setBuffer(e);var t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t},e.prototype.decodeMulti=function(e){return l(this,(function(t){switch(t.label){case 0:this.reinitializeState(),this.setBuffer(e),t.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return t.sent(),[3,1];case 3:return[2]}}))},e.prototype.decodeAsync=function(e){var t,n,s,o,i,c,a,_;return i=this,c=void 0,_=function(){var i,c,a,_,d,p,u,m;return l(this,(function(l){switch(l.label){case 0:i=!1,l.label=1;case 1:l.trys.push([1,6,7,12]),t=h(e),l.label=2;case 2:return[4,t.next()];case 3:if((n=l.sent()).done)return[3,5];if(a=n.value,i)throw this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{c=this.doDecodeSync(),i=!0}catch(e){if(!(e instanceof f))throw e}this.totalPos+=this.pos,l.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return _=l.sent(),s={error:_},[3,12];case 7:return l.trys.push([7,,10,11]),n&&!n.done&&(o=t.return)?[4,o.call(t)]:[3,9];case 8:l.sent(),l.label=9;case 9:return[3,11];case 10:if(s)throw s.error;return[7];case 11:return[7];case 12:if(i){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,c]}throw p=(d=this).headByte,u=d.pos,m=d.totalPos,new RangeError("Insufficient data in parsing ".concat(r(p)," at ").concat(m," (").concat(u," in the current buffer)"))}}))},new((a=void 0)||(a=Promise))((function(e,t){function n(e){try{s(_.next(e))}catch(e){t(e)}}function r(e){try{s(_.throw(e))}catch(e){t(e)}}function s(t){var s;t.done?e(t.value):(s=t.value,s instanceof a?s:new a((function(e){e(s)}))).then(n,r)}s((_=_.apply(i,c||[])).next())}))},e.prototype.decodeArrayStream=function(e){return this.decodeMultiAsync(e,!0)},e.prototype.decodeStream=function(e){return this.decodeMultiAsync(e,!1)},e.prototype.decodeMultiAsync=function(e,t){return function(e,t,n){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var r,s=n.apply(e,t||[]),o=[];return r={},i("next"),i("throw"),i("return"),r[Symbol.asyncIterator]=function(){return this},r;function i(e){s[e]&&(r[e]=function(t){return new Promise((function(n,r){o.push([e,t,n,r])>1||c(e,t)}))})}function c(e,t){try{(n=s[e](t)).value instanceof d?Promise.resolve(n.value.v).then(a,_):l(o[0][2],n)}catch(e){l(o[0][3],e)}var n}function a(e){c("next",e)}function _(e){c("throw",e)}function l(e,t){e(t),o.shift(),o.length&&c(o[0][0],o[0][1])}}(this,arguments,(function(){var n,r,s,o,i,c,a,_,p;return l(this,(function(l){switch(l.label){case 0:n=t,r=-1,l.label=1;case 1:l.trys.push([1,13,14,19]),s=h(e),l.label=2;case 2:return[4,d(s.next())];case 3:if((o=l.sent()).done)return[3,12];if(i=o.value,t&&0===r)throw this.createExtraByteError(this.totalPos);this.appendBuffer(i),n&&(r=this.readArraySize(),n=!1,this.complete()),l.label=4;case 4:l.trys.push([4,9,,10]),l.label=5;case 5:return[4,d(this.doDecodeSync())];case 6:return[4,l.sent()];case 7:return l.sent(),0==--r?[3,8]:[3,5];case 8:return[3,10];case 9:if(!((c=l.sent())instanceof f))throw c;return[3,10];case 10:this.totalPos+=this.pos,l.label=11;case 11:return[3,2];case 12:return[3,19];case 13:return a=l.sent(),_={error:a},[3,19];case 14:return l.trys.push([14,,17,18]),o&&!o.done&&(p=s.return)?[4,d(p.call(s))]:[3,16];case 15:l.sent(),l.label=16;case 16:return[3,18];case 17:if(_)throw _.error;return[7];case 18:return[7];case 19:return[2]}}))}))},e.prototype.doDecodeSync=function(){e:for(;;){var e=this.readHeadByte(),t=void 0;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){if(0!=(s=e-128)){this.pushMapState(s),this.complete();continue e}t={}}else if(e<160){if(0!=(s=e-144)){this.pushArrayState(s),this.complete();continue e}t=[]}else{var n=e-160;t=this.decodeUtf8String(n,0)}else if(192===e)t=null;else if(194===e)t=!1;else if(195===e)t=!0;else if(202===e)t=this.readF32();else if(203===e)t=this.readF64();else if(204===e)t=this.readU8();else if(205===e)t=this.readU16();else if(206===e)t=this.readU32();else if(207===e)t=this.readU64();else if(208===e)t=this.readI8();else if(209===e)t=this.readI16();else if(210===e)t=this.readI32();else if(211===e)t=this.readI64();else if(217===e)n=this.lookU8(),t=this.decodeUtf8String(n,1);else if(218===e)n=this.lookU16(),t=this.decodeUtf8String(n,2);else if(219===e)n=this.lookU32(),t=this.decodeUtf8String(n,4);else if(220===e){if(0!==(s=this.readU16())){this.pushArrayState(s),this.complete();continue e}t=[]}else if(221===e){if(0!==(s=this.readU32())){this.pushArrayState(s),this.complete();continue e}t=[]}else if(222===e){if(0!==(s=this.readU16())){this.pushMapState(s),this.complete();continue e}t={}}else if(223===e){if(0!==(s=this.readU32())){this.pushMapState(s),this.complete();continue e}t={}}else if(196===e){var s=this.lookU8();t=this.decodeBinary(s,1)}else if(197===e)s=this.lookU16(),t=this.decodeBinary(s,2);else if(198===e)s=this.lookU32(),t=this.decodeBinary(s,4);else if(212===e)t=this.decodeExtension(1,0);else if(213===e)t=this.decodeExtension(2,0);else if(214===e)t=this.decodeExtension(4,0);else if(215===e)t=this.decodeExtension(8,0);else if(216===e)t=this.decodeExtension(16,0);else if(199===e)s=this.lookU8(),t=this.decodeExtension(s,1);else if(200===e)s=this.lookU16(),t=this.decodeExtension(s,2);else{if(201!==e)throw new _.X("Unrecognized type byte: ".concat(r(e)));s=this.lookU32(),t=this.decodeExtension(s,4)}this.complete();for(var o=this.stack;o.length>0;){var i=o[o.length-1];if(0===i.type){if(i.array[i.position]=t,i.position++,i.position!==i.size)continue e;o.pop(),t=i.array}else{if(1===i.type){if(void 0,"string"!=(c=typeof t)&&"number"!==c)throw new _.X("The type of key must be string or number but "+typeof t);if("__proto__"===t)throw new _.X("The key __proto__ is not allowed");i.key=t,i.type=2;continue e}if(i.map[i.key]=t,i.readCount++,i.readCount!==i.size){i.key=null,i.type=1;continue e}o.pop(),t=i.map}}return t}var c},e.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},e.prototype.complete=function(){this.headByte=-1},e.prototype.readArraySize=function(){var e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:if(e<160)return e-144;throw new _.X("Unrecognized array type byte: ".concat(r(e)))}},e.prototype.pushMapState=function(e){if(e>this.maxMapLength)throw new _.X("Max length exceeded: map length (".concat(e,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.push({type:1,size:e,key:null,readCount:0,map:{}})},e.prototype.pushArrayState=function(e){if(e>this.maxArrayLength)throw new _.X("Max length exceeded: array length (".concat(e,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.push({type:0,size:e,array:new Array(e),position:0})},e.prototype.decodeUtf8String=function(e,t){var n;if(e>this.maxStrLength)throw new _.X("Max length exceeded: UTF-8 byte length (".concat(e,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+t+e)throw m;var r,s=this.pos+t;return r=this.stateIsMapKey()&&(null===(n=this.keyDecoder)||void 0===n?void 0:n.canBeCached(e))?this.keyDecoder.decode(this.bytes,s,e):e>i.F6?(0,i.Q$)(this.bytes,s,e):(0,i.Zf)(this.bytes,s,e),this.pos+=t+e,r},e.prototype.stateIsMapKey=function(){return this.stack.length>0&&1===this.stack[this.stack.length-1].type},e.prototype.decodeBinary=function(e,t){if(e>this.maxBinLength)throw new _.X("Max length exceeded: bin length (".concat(e,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(e+t))throw m;var n=this.pos+t,r=this.bytes.subarray(n,n+e);return this.pos+=t+e,r},e.prototype.decodeExtension=function(e,t){if(e>this.maxExtLength)throw new _.X("Max length exceeded: ext length (".concat(e,") > maxExtLength (").concat(this.maxExtLength,")"));var n=this.view.getInt8(this.pos+t),r=this.decodeBinary(e,t+1);return this.extensionCodec.decode(r,n,this.context)},e.prototype.lookU8=function(){return this.view.getUint8(this.pos)},e.prototype.lookU16=function(){return this.view.getUint16(this.pos)},e.prototype.lookU32=function(){return this.view.getUint32(this.pos)},e.prototype.readU8=function(){var e=this.view.getUint8(this.pos);return this.pos++,e},e.prototype.readI8=function(){var e=this.view.getInt8(this.pos);return this.pos++,e},e.prototype.readU16=function(){var e=this.view.getUint16(this.pos);return this.pos+=2,e},e.prototype.readI16=function(){var e=this.view.getInt16(this.pos);return this.pos+=2,e},e.prototype.readU32=function(){var e=this.view.getUint32(this.pos);return this.pos+=4,e},e.prototype.readI32=function(){var e=this.view.getInt32(this.pos);return this.pos+=4,e},e.prototype.readU64=function(){var e=(0,o.Hn)(this.view,this.pos);return this.pos+=8,e},e.prototype.readI64=function(){var e=(0,o.eN)(this.view,this.pos);return this.pos+=8,e},e.prototype.readF32=function(){var e=this.view.getFloat32(this.pos);return this.pos+=4,e},e.prototype.readF64=function(){var e=this.view.getFloat64(this.pos);return this.pos+=8,e},e}(),w={};function v(e,t){return void 0===t&&(t=w),new g(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decode(e)}function b(e,t){return void 0===t&&(t=w),new g(t.extensionCodec,t.context,t.maxStrLength,t.maxBinLength,t.maxArrayLength,t.maxMapLength,t.maxExtLength).decodeMulti(e)}},915:(e,t,n)=>{n.d(t,{l:()=>_});var r=n(579),s=n(656),o=n(989),i=n(876),c=function(){function e(e,t,n,r,o,i,c,a){void 0===e&&(e=s.g.defaultCodec),void 0===t&&(t=void 0),void 0===n&&(n=100),void 0===r&&(r=2048),void 0===o&&(o=!1),void 0===i&&(i=!1),void 0===c&&(c=!1),void 0===a&&(a=!1),this.extensionCodec=e,this.context=t,this.maxDepth=n,this.initialBufferSize=r,this.sortKeys=o,this.forceFloat32=i,this.ignoreUndefined=c,this.forceIntegerToFloat=a,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return e.prototype.reinitializeState=function(){this.pos=0},e.prototype.encodeSharedRef=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)},e.prototype.encode=function(e){return this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)},e.prototype.doEncode=function(e,t){if(t>this.maxDepth)throw new Error("Too deep objects in depth ".concat(t));null==e?this.encodeNil():"boolean"==typeof e?this.encodeBoolean(e):"number"==typeof e?this.encodeNumber(e):"string"==typeof e?this.encodeString(e):this.encodeObject(e,t)},e.prototype.ensureBufferSizeToWrite=function(e){var t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(2*t)},e.prototype.resizeBuffer=function(e){var t=new ArrayBuffer(e),n=new Uint8Array(t),r=new DataView(t);n.set(this.bytes),this.view=r,this.bytes=n},e.prototype.encodeNil=function(){this.writeU8(192)},e.prototype.encodeBoolean=function(e){!1===e?this.writeU8(194):this.writeU8(195)},e.prototype.encodeNumber=function(e){Number.isSafeInteger(e)&&!this.forceIntegerToFloat?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):(this.writeU8(211),this.writeI64(e)):this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))},e.prototype.writeStringHeader=function(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too long string: ".concat(e," bytes in UTF-8"));this.writeU8(219),this.writeU32(e)}},e.prototype.encodeString=function(e){if(e.length>r.TF){var t=(0,r.dS)(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),(0,r.jW)(e,this.bytes,this.pos),this.pos+=t}else t=(0,r.dS)(e),this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),(0,r.Hc)(e,this.bytes,this.pos),this.pos+=t},e.prototype.encodeObject=function(e,t){var n=this.extensionCodec.tryToEncode(e,this.context);if(null!=n)this.encodeExtension(n);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else{if("object"!=typeof e)throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(e)));this.encodeMap(e,t)}},e.prototype.encodeBinary=function(e){var t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large binary: ".concat(t));this.writeU8(198),this.writeU32(t)}var n=(0,i.C)(e);this.writeU8a(n)},e.prototype.encodeArray=function(e,t){var n=e.length;if(n<16)this.writeU8(144+n);else if(n<65536)this.writeU8(220),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large array: ".concat(n));this.writeU8(221),this.writeU32(n)}for(var r=0,s=e;r<s.length;r++){var o=s[r];this.doEncode(o,t+1)}},e.prototype.countWithoutUndefined=function(e,t){for(var n=0,r=0,s=t;r<s.length;r++)void 0!==e[s[r]]&&n++;return n},e.prototype.encodeMap=function(e,t){var n=Object.keys(e);this.sortKeys&&n.sort();var r=this.ignoreUndefined?this.countWithoutUndefined(e,n):n.length;if(r<16)this.writeU8(128+r);else if(r<65536)this.writeU8(222),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large map object: ".concat(r));this.writeU8(223),this.writeU32(r)}for(var s=0,o=n;s<o.length;s++){var i=o[s],c=e[i];this.ignoreUndefined&&void 0===c||(this.encodeString(i),this.doEncode(c,t+1))}},e.prototype.encodeExtension=function(e){var t=e.data.length;if(1===t)this.writeU8(212);else if(2===t)this.writeU8(213);else if(4===t)this.writeU8(214);else if(8===t)this.writeU8(215);else if(16===t)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too large extension object: ".concat(t));this.writeU8(201),this.writeU32(t)}this.writeI8(e.type),this.writeU8a(e.data)},e.prototype.writeU8=function(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++},e.prototype.writeU8a=function(e){var t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t},e.prototype.writeI8=function(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++},e.prototype.writeU16=function(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2},e.prototype.writeI16=function(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2},e.prototype.writeU32=function(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4},e.prototype.writeI32=function(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4},e.prototype.writeF32=function(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4},e.prototype.writeF64=function(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8},e.prototype.writeU64=function(e){this.ensureBufferSizeToWrite(8),(0,o.X3)(this.view,this.pos,e),this.pos+=8},e.prototype.writeI64=function(e){this.ensureBufferSizeToWrite(8),(0,o._j)(this.view,this.pos,e),this.pos+=8},e}(),a={};function _(e,t){return void 0===t&&(t=a),new c(t.extensionCodec,t.context,t.maxDepth,t.initialBufferSize,t.sortKeys,t.forceFloat32,t.ignoreUndefined,t.forceIntegerToFloat).encodeSharedRef(e)}},989:(e,t,n)=>{n.d(t,{Hn:()=>c,X3:()=>s,_j:()=>o,eN:()=>i,f7:()=>r});var r=4294967295;function s(e,t,n){var r=n/4294967296,s=n;e.setUint32(t,r),e.setUint32(t+4,s)}function o(e,t,n){var r=Math.floor(n/4294967296),s=n;e.setUint32(t,r),e.setUint32(t+4,s)}function i(e,t){return 4294967296*e.getInt32(t)+e.getUint32(t+4)}function c(e,t){return 4294967296*e.getUint32(t)+e.getUint32(t+4)}},876:(e,t,n)=>{function r(e){return e instanceof Uint8Array?e:ArrayBuffer.isView(e)?new Uint8Array(e.buffer,e.byteOffset,e.byteLength):e instanceof ArrayBuffer?new Uint8Array(e):Uint8Array.from(e)}function s(e){if(e instanceof ArrayBuffer)return new DataView(e);var t=r(e);return new DataView(t.buffer,t.byteOffset,t.byteLength)}n.d(t,{C:()=>r,o:()=>s})},579:(e,t,n)=>{n.d(t,{F6:()=>m,Hc:()=>_,Q$:()=>y,TF:()=>h,Zf:()=>u,dS:()=>a,jW:()=>d});var r,s,o,i=n(989),c=("undefined"==typeof process||"never"!==(null===(r=null===process||void 0===process?void 0:process.env)||void 0===r?void 0:r.TEXT_ENCODING))&&"undefined"!=typeof TextEncoder&&"undefined"!=typeof TextDecoder;function a(e){for(var t=e.length,n=0,r=0;r<t;){var s=e.charCodeAt(r++);if(4294967168&s)if(4294965248&s){if(s>=55296&&s<=56319&&r<t){var o=e.charCodeAt(r);56320==(64512&o)&&(++r,s=((1023&s)<<10)+(1023&o)+65536)}n+=4294901760&s?4:3}else n+=2;else n++}return n}function _(e,t,n){for(var r=e.length,s=n,o=0;o<r;){var i=e.charCodeAt(o++);if(4294967168&i){if(4294965248&i){if(i>=55296&&i<=56319&&o<r){var c=e.charCodeAt(o);56320==(64512&c)&&(++o,i=((1023&i)<<10)+(1023&c)+65536)}4294901760&i?(t[s++]=i>>18&7|240,t[s++]=i>>12&63|128,t[s++]=i>>6&63|128):(t[s++]=i>>12&15|224,t[s++]=i>>6&63|128)}else t[s++]=i>>6&31|192;t[s++]=63&i|128}else t[s++]=i}}var l=c?new TextEncoder:void 0,h=c?"undefined"!=typeof process&&"force"!==(null===(s=null===process||void 0===process?void 0:process.env)||void 0===s?void 0:s.TEXT_ENCODING)?200:0:i.f7,d=(null==l?void 0:l.encodeInto)?function(e,t,n){l.encodeInto(e,t.subarray(n))}:function(e,t,n){t.set(l.encode(e),n)},p=4096;function u(e,t,n){for(var r=t,s=r+n,o=[],i="";r<s;){var c=e[r++];if(128&c)if(192==(224&c)){var a=63&e[r++];o.push((31&c)<<6|a)}else if(224==(240&c)){a=63&e[r++];var _=63&e[r++];o.push((31&c)<<12|a<<6|_)}else if(240==(248&c)){var l=(7&c)<<18|(a=63&e[r++])<<12|(_=63&e[r++])<<6|63&e[r++];l>65535&&(l-=65536,o.push(l>>>10&1023|55296),l=56320|1023&l),o.push(l)}else o.push(c);else o.push(c);o.length>=p&&(i+=String.fromCharCode.apply(String,o),o.length=0)}return o.length>0&&(i+=String.fromCharCode.apply(String,o)),i}var f=c?new TextDecoder:null,m=c?"undefined"!=typeof process&&"force"!==(null===(o=null===process||void 0===process?void 0:process.env)||void 0===o?void 0:o.TEXT_DECODER)?200:0:i.f7;function y(e,t,n){var r=e.subarray(t,t+n);return f.decode(r)}}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e](n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=(e,t)=>{for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),__webpack_require__.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{API_VERSION:()=>_rpc_js__WEBPACK_IMPORTED_MODULE_0__.m,HTTPStreamingRPCConnection:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.oC,LocalWebSocket:()=>LocalWebSocket,RPC:()=>_rpc_js__WEBPACK_IMPORTED_MODULE_0__.y,connectToServer:()=>connectToServer,connectToServerHTTP:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.Xe,getRTCService:()=>_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.b,getRemoteService:()=>getRemoteService,getRemoteServiceHTTP:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.Ci,loadRequirements:()=>_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.V0,login:()=>login,logout:()=>logout,normalizeServerUrlHTTP:()=>_http_client_js__WEBPACK_IMPORTED_MODULE_4__.sb,registerRTCService:()=>_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.e,schemaFunction:()=>_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G,setupLocalClient:()=>setupLocalClient});var _rpc_js__WEBPACK_IMPORTED_MODULE_0__=__webpack_require__(887),_utils_index_js__WEBPACK_IMPORTED_MODULE_1__=__webpack_require__(878),_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__=__webpack_require__(287),_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__=__webpack_require__(831),_http_client_js__WEBPACK_IMPORTED_MODULE_4__=__webpack_require__(144);const MAX_RETRY=1e6;class WebsocketRPCConnection{constructor(e,t,n,r,s=null,o=60,i=null,c=7200,a=null){(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e&&t,"server_url and client_id are required"),this._server_url=e,this._client_id=t,this._workspace=n,this._token=r,this._reconnection_token=s,this._websocket=null,this._handle_message=null,this._handle_connected=null,this._handle_disconnected=null,this._timeout=o,this._WebSocketClass=i||WebSocket,this._closed=!1,this._legacy_auth=null,this.connection_info=null,this._enable_reconnect=!1,this._token_refresh_interval=c,this.manager_id=null,this._refresh_token_task=null,this._last_message=null,this._reconnect_timeouts=new Set,this._additional_headers=a}_cleanup(){this._refresh_token_task&&(clearInterval(this._refresh_token_task),this._refresh_token_task=null);for(const e of this._reconnect_timeouts)clearTimeout(e);this._reconnect_timeouts.clear()}on_message(e){(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e,"handler is required"),this._handle_message=e}on_connected(e){this._handle_connected=e}on_disconnected(e){this._handle_disconnected=e}async _attempt_connection(e,t=!0){return new Promise(((n,r)=>{this._legacy_auth=!1;const s=new this._WebSocketClass(e);s.binaryType="arraybuffer",s.onopen=()=>{console.info("WebSocket connection established"),n(s)},s.onerror=e=>{console.error("WebSocket connection error:",e),r(new Error(`WebSocket connection error: ${e}`))},s.onclose=s=>{1003===s.code&&t?(console.info("Received 1003 error, attempting connection with query parameters."),this._legacy_auth=!0,this._attempt_connection_with_query_params(e).then(n).catch(r)):this._handle_disconnected&&this._handle_disconnected(s.reason)}}))}async _attempt_connection_with_query_params(e){const t=[];this._client_id&&t.push(`client_id=${encodeURIComponent(this._client_id)}`),this._workspace&&t.push(`workspace=${encodeURIComponent(this._workspace)}`),this._token&&t.push(`token=${encodeURIComponent(this._token)}`),this._reconnection_token&&t.push(`reconnection_token=${encodeURIComponent(this._reconnection_token)}`);const n=e+(t.length>0?`?${t.join("&")}`:"");return await this._attempt_connection(n,!1)}_establish_connection(){return new Promise(((e,t)=>{this._websocket.onmessage=n=>{const r=n.data,s=JSON.parse(r);if("connection_info"!=s.type){if("error"==s.type){const e="ConnectionAbortedError: "+s.message;return console.error("Failed to connect, "+e),void t(new Error(e))}return console.error("ConnectionAbortedError: Unexpected message received from the server:",r),void t(new Error("ConnectionAbortedError: Unexpected message received from the server"))}this.connection_info=s,this._workspace&&(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(this.connection_info.workspace===this._workspace,`Connected to the wrong workspace: ${this.connection_info.workspace}, expected: ${this._workspace}`),this.connection_info.reconnection_token&&(this._reconnection_token=this.connection_info.reconnection_token),this.connection_info.reconnection_token_life_time&&this.token_refresh_interval>this.connection_info.reconnection_token_life_time/1.5&&(console.warn(`Token refresh interval is too long (${this.token_refresh_interval}), setting it to 1.5 times of the token life time(${this.connection_info.reconnection_token_life_time}).`),this.token_refresh_interval=this.connection_info.reconnection_token_life_time/1.5),this.manager_id=this.connection_info.manager_id||null,console.log(`Successfully connected to the server, workspace: ${this.connection_info.workspace}, manager_id: ${this.manager_id}`),this.connection_info.announcement&&console.log(`${this.connection_info.announcement}`),e(this.connection_info)}}))}async open(){console.log("Creating a new websocket connection to",this._server_url.split("?")[0]);try{if(this._websocket=await this._attempt_connection(this._server_url),this._legacy_auth)throw new Error("NotImplementedError: Legacy authentication is not supported");const e=JSON.stringify({client_id:this._client_id,workspace:this._workspace,token:this._token,reconnection_token:this._reconnection_token});return this._websocket.send(e),await(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.fm)(this._establish_connection(),this._timeout,"Failed to receive the first message from the server"),this._token_refresh_interval>0&&setTimeout((()=>{this._send_refresh_token(),this._refresh_token_task=setInterval((()=>{this._send_refresh_token()}),1e3*this._token_refresh_interval)}),2e3),this._enable_reconnect=!0,this._closed=!1,this._websocket.onmessage=e=>{if("string"==typeof e.data){const t=JSON.parse(e.data);"reconnection_token"===t.type?this._reconnection_token=t.reconnection_token:console.log("Received message from the server:",t)}else this._handle_message(e.data)},this._websocket.onerror=e=>{console.error("WebSocket connection error:",e),this._cleanup()},this._websocket.onclose=this._handle_close.bind(this),this._handle_connected&&this._handle_connected(this.connection_info),this.connection_info}catch(e){throw this._cleanup(),console.error("Failed to connect to",this._server_url.split("?")[0],e),e}}_send_refresh_token(){if(this._websocket&&this._websocket.readyState===WebSocket.OPEN){const e=JSON.stringify({type:"refresh_token"});this._websocket.send(e)}}_handle_close(e){if(!this._closed&&this._websocket&&this._websocket.readyState===WebSocket.CLOSED){if(this._cleanup(),this._enable_reconnect){[1e3,1001].includes(e.code)?console.warn(`Websocket connection closed gracefully by server (code: ${e.code}): ${e.reason} - attempting reconnect`):console.warn("Websocket connection closed unexpectedly (code: %s): %s",e.code,e.reason);let t=0;const n=1e3,r=6e4,s=.1,o=async()=>{if(this._closed)console.info("Connection was closed, stopping reconnection");else try{console.warn(`Reconnecting to ${this._server_url.split("?")[0]} (attempt #${t})`),await this.open(),await new Promise((e=>setTimeout(e,500))),this._last_message&&(console.info("Resending last message after reconnection"),this._websocket.send(this._last_message),this._last_message=null),console.warn(`Successfully reconnected to server ${this._server_url} (services re-registered)`),this._handle_connected&&this._handle_connected(this.connection_info)}catch(e){if(`${e}`.includes("ConnectionAbortedError:"))return console.warn("Server refused to reconnect:",e),this._closed=!0,void(this._handle_disconnected&&this._handle_disconnected(`Server refused reconnection: ${e}`));if(`${e}`.includes("NotImplementedError:"))return console.error(`${e}\nIt appears that you are trying to connect to a hypha server that is older than 0.20.0, please upgrade the hypha server or use the websocket client in imjoy-rpc(https://www.npmjs.com/package/imjoy-rpc) instead`),this._closed=!0,void(this._handle_disconnected&&this._handle_disconnected(`Server too old: ${e}`));"NetworkError"===e.name||e.message.includes("network")?console.error(`Network error during reconnection: ${e.message}`):"TimeoutError"===e.name||e.message.includes("timeout")?console.error(`Connection timeout during reconnection: ${e.message}`):console.error(`Unexpected error during reconnection: ${e.message}`);const i=Math.min(n*Math.pow(2,t),r),c=(2*Math.random()-1)*s*i,a=Math.max(100,i+c);console.debug(`Waiting ${(a/1e3).toFixed(2)}s before next reconnection attempt`);const _=setTimeout((async()=>{this._reconnect_timeouts.delete(_),this._websocket&&this._websocket.readyState===WebSocket.OPEN?console.info("Connection restored externally"):this._closed?console.info("Connection was closed, stopping reconnection"):(t+=1,t<MAX_RETRY?await o():(console.error(`Failed to reconnect after ${MAX_RETRY} attempts, giving up.`),this._closed=!0,this._handle_disconnected&&this._handle_disconnected("Max reconnection attempts exceeded")))}),a);this._reconnect_timeouts.add(_)}};o()}}else this._cleanup(),this._handle_disconnected&&this._handle_disconnected(e.reason)}async emit_message(e){if(this._closed)throw new Error("Connection is closed");this._websocket&&this._websocket.readyState===WebSocket.OPEN||await this.open();try{this._last_message=e,this._websocket.send(e),this._last_message=null}catch(e){throw console.error(`Failed to send data, error: ${e}`),e}}disconnect(e){this._closed=!0,this._last_message=null,this._websocket&&this._websocket.readyState!==WebSocket.CLOSED&&this._websocket.readyState!==WebSocket.CLOSING&&this._websocket.close(1e3,e),this._cleanup(),console.info(`WebSocket connection disconnected (${e})`)}}function normalizeServerUrl(e){if(!e)throw new Error("server_url is required");return e.startsWith("http://")?e=e.replace("http://","ws://").replace(/\/$/,"")+"/ws":e.startsWith("https://")&&(e=e.replace("https://","wss://").replace(/\/$/,"")+"/ws"),e}async function login(e){const t=e.login_service_id||"public/hypha-login",n=e.workspace,r=e.expires_in,s=e.login_timeout||60,o=e.login_callback,i=e.profile,c=e.additional_headers,a=e.transport||"websocket",_=await connectToServer({name:"initial login client",server_url:e.server_url,additional_headers:c,transport:a});try{const e=await _.getService(t);let c;return(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e,`Failed to get the login service: ${t}`),c=n?await e.start({workspace:n,expires_in:r,_rkwargs:!0}):await e.start(),o?await o(c):console.log(`Please open your browser and login at ${c.login_url}`),await e.check(c.key,{timeout:s,profile:i,_rkwargs:!0})}catch(e){throw e}finally{await _.disconnect()}}async function logout(e){const t=e.login_service_id||"public/hypha-login",n=e.logout_callback,r=e.additional_headers,s=e.transport||"websocket",o=await connectToServer({name:"initial logout client",server_url:e.server_url,additional_headers:r,transport:s});try{const e=await o.getService(t);if((0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(e,`Failed to get the login service: ${t}`),!e.logout)throw new Error("Logout is not supported by this server. Please upgrade the Hypha server to a version that supports logout.");const r=await e.logout({});return n?await n(r):console.log(`Please open your browser to logout at ${r.logout_url}`),r}catch(e){throw e}finally{await o.disconnect()}}async function webrtcGetService(e,t,n,r){const s=(r=r||{}).webrtc,o=r.webrtc_config;void 0!==r.webrtc&&delete r.webrtc,void 0!==r.webrtc_config&&delete r.webrtc_config,(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)([void 0,!0,!1,"auto"].includes(s),"webrtc must be true, false or 'auto'");const i=await e.getService(n,r);if(!0===s||"auto"===s){if(i.id.includes(":")&&i.id.includes("/"))try{const n=await(0,_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.b)(e,t,o),s=await n.getService(i.id.split(":")[1],r);return s._webrtc=!0,s._peer=n,s._service=i,s}catch(e){console.warn("Failed to get webrtc service, using websocket connection",e)}if(!0===s)throw new Error("Failed to get the service via webrtc")}return i}async function connectToServer(e){if("http"===(e.transport||"websocket"))return await(0,_http_client_js__WEBPACK_IMPORTED_MODULE_4__.Xe)(e);e.server&&(e.server_url=e.server_url||e.server.url,e.WebSocketClass=e.WebSocketClass||e.server.WebSocketClass);let t=e.client_id;t||(t=(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.bq)(),e.client_id=t),0===Object.keys(e).length&&("undefined"!=typeof process&&process.env?(e.server_url=process.env.HYPHA_SERVER_URL,e.token=process.env.HYPHA_TOKEN,e.client_id=process.env.HYPHA_CLIENT_ID,e.workspace=process.env.HYPHA_WORKSPACE):"undefined"!=typeof self&&self.env?(e.server_url=self.env.HYPHA_SERVER_URL,e.token=self.env.HYPHA_TOKEN,e.client_id=self.env.HYPHA_CLIENT_ID,e.workspace=self.env.HYPHA_WORKSPACE):"undefined"!=typeof globalThis&&globalThis.env&&(e.server_url=globalThis.env.HYPHA_SERVER_URL,e.token=globalThis.env.HYPHA_TOKEN,e.client_id=globalThis.env.HYPHA_CLIENT_ID,e.workspace=globalThis.env.HYPHA_WORKSPACE));let n=normalizeServerUrl(e.server_url),r=new WebsocketRPCConnection(n,t,e.workspace,e.token,e.reconnection_token,e.method_timeout||60,e.WebSocketClass,e.token_refresh_interval,e.additional_headers);const s=await r.open();if((0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(s,"Failed to connect to the server, no connection info obtained. This issue is most likely due to an outdated Hypha server version. Please use `imjoy-rpc` for compatibility, or upgrade the Hypha server to the latest version."),await new Promise((e=>setTimeout(e,100))),!r.manager_id){console.warn("Manager ID not set immediately, waiting...");const e=5e3,t=100,n=Date.now();for(;!r.manager_id&&Date.now()-n<e;)await new Promise((e=>setTimeout(e,t)));if(!r.manager_id)throw console.error("Manager ID still not set after waiting"),new Error("Failed to get manager ID from server");console.info(`Manager ID set after waiting: ${r.manager_id}`)}if(e.workspace&&s.workspace!==e.workspace)throw new Error(`Connected to the wrong workspace: ${s.workspace}, expected: ${e.workspace}`);const o=s.workspace,i=new _rpc_js__WEBPACK_IMPORTED_MODULE_0__.y(r,{client_id:t,workspace:o,default_context:{connection_type:"websocket"},name:e.name,method_timeout:e.method_timeout,app_id:e.app_id,server_base_url:s.public_base_url,long_message_chunk_size:e.long_message_chunk_size});await i.waitFor("services_registered",e.method_timeout||120);const c=await i.get_manager_service({timeout:e.method_timeout,case_conversion:"camel",kwargs_expansion:e.kwargs_expansion||!1});if(c.rpc=i,s&&(c.config=Object.assign(c.config,s)),c.export=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(t){t.id="default",t.name=t.name||e.name||t.id,t.description=t.description||e.description,await i.register_service(t,{overwrite:!0})}),{name:"export",description:"Export the api.",parameters:{properties:{api:{description:"The api to export",type:"object"}},required:["api"],type:"object"}}),c.getApp=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(e){return e=e||"*",(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(!e.includes(":"),"clientId should not contain ':'"),e.includes("/")||(e=s.workspace+"/"+e),(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(2===e.split("/").length,"clientId should match pattern workspace/clientId"),await c.getService(`${e}:default`)}),{name:"getApp",description:"Get the app.",parameters:{properties:{clientId:{default:"*",description:"The clientId",type:"string"}},type:"object"}}),c.listApps=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(e){e=e||o,(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(!e.includes(":"),"workspace should not contain ':'"),(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.vA)(!e.includes("/"),"workspace should not contain '/'");const t={workspace:e,service_id:"default"};return await c.listServices(t)}),{name:"listApps",description:"List the apps.",parameters:{properties:{workspace:{default:o,description:"The workspace",type:"string"}},type:"object"}}),c.disconnect=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.disconnect.bind(i),{name:"disconnect",description:"Disconnect from the server.",parameters:{type:"object",properties:{},required:[]}}),c.registerCodec=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.register_codec.bind(i),{name:"registerCodec",description:"Register a codec for the webrtc connection",parameters:{type:"object",properties:{codec:{type:"object",description:"Codec to register",properties:{name:{type:"string"},type:{},encoder:{type:"function"},decoder:{type:"function"}}}}}}),c.emit=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.emit.bind(i),{name:"emit",description:"Emit a message.",parameters:{properties:{data:{description:"The data to emit",type:"object"}},required:["data"],type:"object"}}),c.on=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.on.bind(i),{name:"on",description:"Register a message handler.",parameters:{properties:{event:{description:"The event to listen to",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),c.off=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.off.bind(i),{name:"off",description:"Remove a message handler.",parameters:{properties:{event:{description:"The event to remove",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),c.once=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.once.bind(i),{name:"once",description:"Register a one-time message handler.",parameters:{properties:{event:{description:"The event to listen to",type:"string"},handler:{description:"The handler function",type:"function"}},required:["event","handler"],type:"object"}}),c.getServiceSchema=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.get_service_schema,{name:"getServiceSchema",description:"Get the service schema.",parameters:{properties:{service:{description:"The service to extract schema",type:"object"}},required:["service"],type:"object"}}),c.registerService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.register_service.bind(i),{name:"registerService",description:"Register a service.",parameters:{properties:{service:{description:"The service to register",type:"object"},force:{default:!1,description:"Force to register the service",type:"boolean"}},required:["service"],type:"object"}}),c.unregisterService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(i.unregister_service.bind(i),{name:"unregisterService",description:"Unregister a service.",parameters:{properties:{service:{description:"The service id to unregister",type:"string"},notify:{default:!0,description:"Notify the workspace manager",type:"boolean"}},required:["service"],type:"object"}}),r.manager_id&&i.on("force-exit",(async e=>{e.from==="*/"+r.manager_id&&(console.log("Disconnecting from server, reason:",e.reason),await i.disconnect())})),e.webrtc){await(0,_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.e)(c,`${t}-rtc`,e.webrtc_config);const n=Object.assign({},c),r=n.getService.__schema__.description,s=n.getService.__schema__.parameters;c.getService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(webrtcGetService.bind(null,n,`${o}/${t}-rtc`),{name:"getService",description:r,parameters:s}),c.getRTCService=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)(_webrtc_client_js__WEBPACK_IMPORTED_MODULE_3__.b.bind(null,c),{name:"getRTCService",description:"Get the webrtc connection, returns a peer connection.",parameters:{properties:{config:{description:"The config for the webrtc service",type:"object"}},required:["config"],type:"object"}})}else{const e=c.getService;c.getService=(t,n)=>e(t,n=n||{}),c.getService.__schema__=e.__schema__}return c.registerProbes=(0,_utils_schema_js__WEBPACK_IMPORTED_MODULE_2__.G)((async function(e){return e.id="probes",e.name="Probes",e.config={visibility:"public"},e.type="probes",e.description=`Probes Service, visit ${n}/${o}services/probes for the available probes.`,await c.registerService(e,{overwrite:!0})}),{name:"registerProbes",description:"Register probes service",parameters:{properties:{probes:{description:"The probes to register, e.g. {'liveness': {'type': 'function', 'description': 'Check the liveness of the service'}}",type:"object"}},required:["probes"],type:"object"}}),c}async function getRemoteService(e,t={}){const{serverUrl:n,workspace:r,clientId:s,serviceId:o,appId:i}=(0,_utils_index_js__WEBPACK_IMPORTED_MODULE_1__.iO)(e),c=`${r}/${s}:${o}@${i}`;if(t.serverUrl&&t.serverUrl!==n)throw new Error("server_url in config does not match the server_url in the url");t.serverUrl=n;const a=await connectToServer(t);return await a.getService(c)}class LocalWebSocket{constructor(e,t,n){this.url=e,this.onopen=()=>{},this.onmessage=()=>{},this.onclose=()=>{},this.onerror=()=>{},this.client_id=t,this.workspace=n;const r="undefined"!=typeof window?window:self,s="undefined"!=typeof window;if(this.postMessage=e=>{s?window.parent.postMessage(e,"*"):self.postMessage(e)},this.readyState=WebSocket.CONNECTING,r.addEventListener("message",(e=>{const{type:t,data:n,to:r}=e.data;if(r===this.client_id)switch(t){case"message":this.readyState===WebSocket.OPEN&&this.onmessage&&this.onmessage({data:n});break;case"connected":this.readyState=WebSocket.OPEN,this.onopen(e);break;case"closed":this.readyState=WebSocket.CLOSED,this.onclose(e)}}),!1),!this.client_id)throw new Error("client_id is required");if(!this.workspace)throw new Error("workspace is required");this.postMessage({type:"connect",url:this.url,from:this.client_id,workspace:this.workspace})}send(e){this.readyState===WebSocket.OPEN&&this.postMessage({type:"message",data:e,from:this.client_id,workspace:this.workspace})}close(){this.readyState=WebSocket.CLOSING,this.postMessage({type:"close",from:this.client_id,workspace:this.workspace}),this.onclose()}addEventListener(e,t){"message"===e&&(this.onmessage=t),"open"===e&&(this.onopen=t),"close"===e&&(this.onclose=t),"error"===e&&(this.onerror=t)}}function setupLocalClient({enable_execution=!1,on_ready=null}){return new Promise(((resolve,reject)=>{const context="undefined"!=typeof window?window:self,isWindow="undefined"!=typeof window;context.addEventListener("message",(event=>{const{type,server_url,workspace,client_id,token,method_timeout,name,config}=event.data;if("initializeHyphaClient"===type){if(!server_url||!workspace||!client_id)return void console.error("server_url, workspace, and client_id are required.");if(!server_url.startsWith("https://local-hypha-server:"))return void console.error("server_url should start with https://local-hypha-server:");class FixedLocalWebSocket extends LocalWebSocket{constructor(e){super(e,client_id,workspace)}}connectToServer({server_url,workspace,client_id,token,method_timeout,name,WebSocketClass:FixedLocalWebSocket}).then((async server=>{globalThis.api=server;try{if(isWindow&&enable_execution){function e(e){return new Promise(((t,n)=>{const r=document.createElement("script");r.innerHTML=e.content,r.lang=e.lang,r.onload=()=>t(),r.onerror=e=>n(e),document.head.appendChild(r)}))}if(config.styles&&config.styles.length>0)for(const t of config.styles){const n=document.createElement("style");n.innerHTML=t.content,n.lang=t.lang,document.head.appendChild(n)}if(config.links&&config.links.length>0)for(const r of config.links){const s=document.createElement("a");s.href=r.url,s.innerText=r.text,document.body.appendChild(s)}if(config.windows&&config.windows.length>0)for(const o of config.windows){document.body.innerHTML=o.content;break}if(config.scripts&&config.scripts.length>0)for(const i of config.scripts){if("javascript"!==i.lang)throw new Error("Only javascript scripts are supported");await e(i)}}else if(!isWindow&&enable_execution&&config.scripts&&config.scripts.length>0)for(const script of config.scripts){if("javascript"!==script.lang)throw new Error("Only javascript scripts are supported");eval(script.content)}on_ready&&await on_ready(server,config),resolve(server)}catch(c){reject(c)}}))}}),!1),isWindow?window.parent.postMessage({type:"hyphaClientReady"},"*"):self.postMessage({type:"hyphaClientReady"})}))}return __webpack_exports__})()));
//# sourceMappingURL=hypha-rpc-websocket.min.js.map