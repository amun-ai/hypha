<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ artifact.manifest.name or 'Collection' }} - Application Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <style>
        .app-card {
            transition: all 0.3s ease;
        }
        .app-card:hover {
            transform: translateY(-5px);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- Header -->
        <header class="mb-10 text-center">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">
                <i class="fas fa-store text-blue-500 mr-3"></i>
                {{ artifact.manifest.name or 'Application Marketplace' }}
            </h1>
            <p class="text-xl text-gray-600 max-w-3xl mx-auto">
                {{ artifact.manifest.description or 'Browse and install applications for your workspace' }}
            </p>
            <div class="mt-4 flex justify-center gap-4">
                <span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-sm">
                    <i class="fas fa-cube mr-1"></i> <span id="appCount">0</span> Apps Available
                </span>
                <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm">
                    <i class="fas fa-server mr-1"></i> Workspace: {{ workspace }}
                </span>
            </div>
        </header>
        
        <!-- Search Bar -->
        <div class="mb-8 max-w-2xl mx-auto">
            <div class="relative">
                <input type="text" id="searchInput" 
                       placeholder="Search applications by name or description..." 
                       class="w-full px-6 py-3 pl-12 border-2 border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent shadow-sm">
                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>

        <!-- Filter Tags -->
        <div class="mb-6 flex justify-center flex-wrap gap-2" id="filterTags">
            <button onclick="filterByType('all')" class="filter-tag px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-blue-500 hover:text-white transition-colors active">
                All Types
            </button>
            <!-- Dynamic type filters will be added here -->
        </div>
        
        <!-- Apps Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-6" id="appsGrid">
            <!-- Apps will be loaded dynamically -->
            <div class="col-span-full text-center py-8" id="loadingState">
                <i class="fas fa-spinner fa-spin text-2xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">Loading applications...</p>
            </div>
        </div>
    </div>
    
    <!-- Artifact Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold text-gray-800">Artifact Details</h2>
                <button onclick="closeDetails()" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="detailsContent" class="p-6">
                <!-- Details will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Install Modal (Hidden - Installation not supported) -->
    <div id="installModal" style="display: none !important;" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl max-w-md w-full">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800">Install Application</h2>
                    <button onclick="closeInstallModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div class="mb-6">
                    <p class="text-gray-600 mb-2">Installing: <span id="installAppId" class="font-mono bg-gray-100 px-2 py-1 rounded"></span></p>
                    <p class="text-gray-600 mb-4">Enter or select a workspace to install this application:</p>
                    
                    <!-- Workspace Input with Dropdown -->
                    <div class="relative">
                        <input 
                            id="workspaceInput" 
                            type="text" 
                            placeholder="Type workspace name or select from dropdown"
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 pr-10"
                        />
                        <div class="absolute inset-y-0 right-0 flex items-center">
                            <button 
                                id="workspaceDropdownBtn"
                                type="button" 
                                onclick="toggleWorkspaceDropdown()"
                                class="px-3 py-2 text-gray-400 hover:text-gray-600 focus:outline-none"
                            >
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        
                        <!-- Dropdown Menu -->
                        <div id="workspaceDropdown" class="hidden absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            <div class="py-1">
                                <!-- Options will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    
                    <p class="text-gray-500 text-xs mt-2">
                        You can type a new workspace name or select from existing workspaces
                    </p>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeInstallModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">
                        Cancel
                    </button>
                    <button onclick="performInstall()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-download mr-2"></i> Install
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // App data will be fetched from server
        let appsData = [];
        
        // Fetch collection children
        async function fetchApps() {
            try {
                const response = await fetch(`{{artifact_base_url}}/children`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                appsData = await response.json();
                renderApps();
                initializeFilters();
                document.getElementById('appCount').textContent = appsData.length;
            } catch (error) {
                console.error('Failed to fetch apps:', error);
                document.getElementById('appsGrid').innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <i class="fas fa-exclamation-triangle text-6xl text-red-300 mb-4"></i>
                        <p class="text-xl text-red-500">Failed to load applications</p>
                        <p class="text-red-400 mt-2">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // Render apps grid
        function renderApps() {
            const grid = document.getElementById('appsGrid');
            grid.innerHTML = '';
            
            if (appsData.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full text-center py-16">
                        <i class="fas fa-inbox text-6xl text-gray-300 mb-4"></i>
                        <p class="text-xl text-gray-500">No applications available in this marketplace yet.</p>
                        <p class="text-gray-400 mt-2">Check back later or publish your own applications!</p>
                    </div>
                `;
                return;
            }
            
            appsData.forEach(app => {
                const appCard = createAppCard(app);
                grid.appendChild(appCard);
            });
        }
        
        // Create app card element
        function createAppCard(app) {
            const div = document.createElement('div');
            div.className = 'bg-white rounded-xl shadow-lg hover:shadow-xl app-card';
            div.dataset.type = app.manifest?.type || 'unknown';
            
            div.innerHTML = `
                <div class="p-6">
                    <!-- App Header -->
                    <div class="flex items-start justify-between mb-4">
                        <div class="p-3 bg-gradient-to-br from-blue-400 to-blue-600 rounded-lg shadow-md">
                            <i class="fas fa-cube text-2xl text-white"></i>
                        </div>
                        ${app.manifest?.daemon ? `
                        <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">
                            <i class="fas fa-server mr-1"></i> Daemon
                        </span>
                        ` : ''}
                    </div>
                    
                    <!-- App Info -->
                    <h3 class="text-lg font-bold text-gray-800 mb-2 app-name truncate" title="${app.manifest?.name || app.id}">
                        ${app.manifest?.name || app.id}
                    </h3>
                    
                    <!-- Artifact ID Chip -->
                    <div class="flex items-center gap-2 mb-3">
                        <span class="px-2 py-1 bg-gray-200 text-gray-700 rounded text-xs font-mono">
                            ID: ${app.id}
                        </span>
                        <button onclick="copyArtifactId('${app.id}', this)" 
                                class="px-2 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded text-xs transition-colors duration-200 flex items-center"
                                title="Copy artifact ID">
                            <i class="fas fa-copy text-xs"></i>
                        </button>
                    </div>
                    
                    <p class="text-gray-600 text-sm mb-4 app-description line-clamp-3" style="display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;">
                        ${app.manifest?.description || 'No description available'}
                    </p>
                    
                    <!-- Tags -->
                    <div class="flex flex-wrap gap-1 mb-4">
                        <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs font-medium">
                            ${app.manifest?.type || 'Unknown'}
                        </span>
                        <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                            v${app.manifest?.version || '1.0.0'}
                        </span>
                        ${app.manifest?.singleton ? `
                        <span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs">
                            Singleton
                        </span>
                        ` : ''}
                    </div>
                    
                    <!-- Stats -->
                    <div class="flex justify-between text-xs text-gray-500 mb-4">
                        <span><i class="fas fa-download mr-1"></i> ${Math.floor(app.download_count || 0)} downloads</span>
                        <span><i class="fas fa-eye mr-1"></i> ${Math.floor(app.view_count || 0)} views</span>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-2">
                        <button onclick="viewArtifact('${app.id}')" 
                                class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors duration-200 py-2 px-4">
                            <i class="fas fa-external-link-alt mr-2"></i> View Artifact
                        </button>
                        <button onclick="viewDetails('${app.id}')" 
                                class="px-3 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors duration-200">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return div;
        }
        
        // Initialize type filters
        function initializeFilters() {
            const types = new Set();
            appsData.forEach(app => {
                if (app.manifest && app.type) {
                    types.add(app.type);
                }
            });
            
            const filterContainer = document.getElementById('filterTags');
            const existingFilters = filterContainer.querySelectorAll('.filter-tag:not([onclick*="all"])');
            existingFilters.forEach(filter => filter.remove());
            
            types.forEach(type => {
                const button = document.createElement('button');
                button.onclick = () => filterByType(type);
                button.className = 'filter-tag px-4 py-2 bg-gray-200 text-gray-700 rounded-full text-sm hover:bg-blue-500 hover:text-white transition-colors';
                button.textContent = type;
                filterContainer.appendChild(button);
            });
        }
        
        // Filter by type
        function filterByType(type) {
            const cards = document.querySelectorAll('.app-card');
            const tags = document.querySelectorAll('.filter-tag');
            
            // Update active tag
            tags.forEach(tag => {
                if (type === 'all' && tag.textContent === 'All Types') {
                    tag.classList.add('bg-blue-500', 'text-white');
                    tag.classList.remove('bg-gray-200', 'text-gray-700');
                } else if (tag.textContent === type) {
                    tag.classList.add('bg-blue-500', 'text-white');
                    tag.classList.remove('bg-gray-200', 'text-gray-700');
                } else {
                    tag.classList.remove('bg-blue-500', 'text-white');
                    tag.classList.add('bg-gray-200', 'text-gray-700');
                }
            });
            
            // Filter cards
            cards.forEach(card => {
                if (type === 'all' || card.dataset.type === type) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        // Copy artifact ID to clipboard
        function copyArtifactId(artifactId, buttonElement) {
            navigator.clipboard.writeText(artifactId).then(() => {
                // Show feedback
                const originalIcon = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-check text-xs"></i>';
                buttonElement.classList.remove('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                buttonElement.classList.add('bg-green-100', 'text-green-700');
                
                setTimeout(() => {
                    buttonElement.innerHTML = originalIcon;
                    buttonElement.classList.remove('bg-green-100', 'text-green-700');
                    buttonElement.classList.add('bg-blue-100', 'hover:bg-blue-200', 'text-blue-700');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy artifact ID:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = artifactId;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
            });
        }
        
        // View artifact
        function viewArtifact(artifactId) {
            // Navigate to the artifact's view page
            const [ws, id] = artifactId.split("/")
            window.location.href = `{{public_base_url}}/${ws}/view/${id}`;
        }
        
        // Show install modal with workspace selection
        function showInstallModal(artifactId) {
            const modal = document.getElementById('installModal');
            const appIdSpan = document.getElementById('installAppId');
            appIdSpan.textContent = artifactId.split("/")[1];
            modal.classList.remove('hidden');
        }
        
        // Close install modal
        function closeInstallModal() {
            document.getElementById('installModal').classList.add('hidden');
        }
        
        // Toggle workspace dropdown
        function toggleWorkspaceDropdown() {
            const dropdown = document.getElementById('workspaceDropdown');
            const btn = document.getElementById('workspaceDropdownBtn');
            const icon = btn.querySelector('i');
            
            if (dropdown.classList.contains('hidden')) {
                dropdown.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
            } else {
                dropdown.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
            }
        }
        
        // Select workspace from dropdown
        function selectWorkspace(workspaceName) {
            document.getElementById('workspaceInput').value = workspaceName;
            document.getElementById('workspaceDropdown').classList.add('hidden');
            const btn = document.getElementById('workspaceDropdownBtn');
            const icon = btn.querySelector('i');
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
        
        // Perform installation
        async function performInstall() {
            const artifactId = document.getElementById('installAppId').textContent;
            const selectedWorkspace = document.getElementById('workspaceInput').value.trim();
            
            if (!selectedWorkspace) {
                alert('Please enter or select a workspace');
                return;
            }
            
            // Redirect to workspace dashboard with install instruction
            const installUrl = `/${selectedWorkspace}/#install:${artifactId}`;
            window.location.href = installUrl;
        }
        
        // View app details
        function viewDetails(appId) {
            const app = appsData.find(a => a.id === appId);
            if (!app) return;
            
            const modal = document.getElementById('detailsModal');
            const content = document.getElementById('detailsContent');
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-800 mb-2">${app.manifest.name || app.id}</h3>
                        <p class="text-gray-600">${app.manifest.description || 'No description available'}</p>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Type</p>
                            <p class="font-medium">${app.type || 'Unknown'}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Version</p>
                            <p class="font-medium">${app.manifest.version || '1.0.0'}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Downloads</p>
                            <p class="font-medium">${Math.floor(app.download_count || 0)}</p>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg">
                            <p class="text-sm text-gray-500 mb-1">Views</p>
                            <p class="font-medium">${Math.floor(app.view_count || 0)}</p>
                        </div>
                    </div>
                    
                    ${app.manifest.requirements ? `
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-2">Requirements</h4>
                        <pre class="bg-gray-50 p-3 rounded-lg text-sm overflow-x-auto">${JSON.stringify(app.manifest.requirements, null, 2)}</pre>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.classList.remove('hidden');
        }
        
        // Close details modal
        function closeDetails() {
            document.getElementById('detailsModal').classList.add('hidden');
        }
        
        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const cards = document.querySelectorAll('.app-card');
            
            cards.forEach(card => {
                const name = card.querySelector('.app-name').textContent.toLowerCase();
                const description = card.querySelector('.app-description').textContent.toLowerCase();
                
                if (name.includes(searchTerm) || description.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
        
        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDetails();
            }
        });
        
        // Initialize on load
        fetchApps();
        populateWorkspaceDropdown();
        
        // Populate workspace dropdown
        async function populateWorkspaceDropdown() {
            try {
                const dropdown = document.getElementById('workspaceDropdown').querySelector('.py-1');
                
                // Add current workspace if available
                const currentWorkspace = '{{ workspace }}';
                if (currentWorkspace && currentWorkspace !== 'public') {
                    const option = document.createElement('div');
                    option.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    option.textContent = currentWorkspace;
                    option.onclick = () => selectWorkspace(currentWorkspace);
                    dropdown.appendChild(option);
                }
                
                // Always add public workspace option
                if (currentWorkspace !== 'public') {
                    const publicOption = document.createElement('div');
                    publicOption.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm';
                    publicOption.innerHTML = 'public <span class="text-gray-500">(shared workspace)</span>';
                    publicOption.onclick = () => selectWorkspace('public');
                    dropdown.appendChild(publicOption);
                }
                
                // Add some common workspace examples
                const examples = ['my-workspace', 'team-workspace', 'dev-workspace'];
                examples.forEach(workspace => {
                    if (workspace !== currentWorkspace) {
                        const option = document.createElement('div');
                        option.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm text-gray-600';
                        option.innerHTML = `${workspace} <span class="text-xs">(example)</span>`;
                        option.onclick = () => selectWorkspace(workspace);
                        dropdown.appendChild(option);
                    }
                });
                
                // TODO: Fetch user's accessible workspaces from server
                // This would require an API endpoint to list user workspaces
                
            } catch (error) {
                console.error('Failed to populate workspace dropdown:', error);
            }
        }
    </script>
</body>
</html>