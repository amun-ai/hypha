<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hypha Workspace Management</title>
    <!-- External Scripts -->
    <script src="../assets/hypha-rpc-websocket.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.24.7/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="https://rawcdn.githack.com/nextapps-de/winbox/0.2.82/dist/winbox.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.7.7/axios.min.js"></script>
    <!-- Favicon and Icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="./static/img/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="./static/img/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="./static/img/favicon-16x16.png">
    <!-- Stylesheets -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.3.0/github-markdown-light.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap">
    <!-- Meta Tags -->
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">
    <style>
        /* Styles for the sidebar and main content */
        .sidebar {
            width: 250px;
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #1f2937;
            padding-top: 20px;
            transition: all 0.3s;
        }

        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar .logo {
            padding-left: 10px;
            text-align: center;
            margin-bottom: 1rem;
        }

        .sidebar .menu-item {
            padding: 1rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background-color 0.3s;
        }

        .sidebar .menu-item:hover {
            background-color: #374151;
        }

        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .main-content {
            padding: 20px;
            transition: all 0.3s;
        }

        .main-content.collapsed {
            margin-left: 60px;
        }

        .file-item {
            position: relative;
        }
        .file-item-buttons {
            display: none;
            position: absolute;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            gap: 0.25rem;
            align-items: center;
            flex-wrap: wrap;
        }
        .file-item:hover .file-item-buttons {
            display: flex;
        }
        .file-card {
            position: relative;
            min-height: 60px;
        }
        .file-card.drag-over {
            background-color: #4a5568;
            border-color: #4299e1;
        }
        .border-blue-500 {
            border-color: #4299e1 !important;
            border-width: 2px !important;
        }
        .file-card.drag-over,
        .bg-gray-600.border-blue-500 {
            background-color: #4a5568 !important;
            border-color: #4299e1 !important;
            transform: scale(1.02);
        }
        .file-card:hover {
            background-color: #2d3748;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
            }

            .main-content {
                margin-left: 60px;
            }

            .sidebar .menu-item span {
                display: none;
            }
        }

        .grid {
            min-height: 30vh;
        }

        .service-card {
            background-color: #2d3748;
            border-radius: 0.5rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1f2937;
            border-radius: 0.5rem;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-body {
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>

<body class="bg-black text-white font-poppins">
    <div id="app"></div>
    <script type="module">
        import { HyphaCore } from "https://cdn.jsdelivr.net/npm/hypha-core@0.20.60/dist/hypha-core.mjs";

        const defaultService = {
            getServerConfig(context){
                let token;
                try{
                    token = document.cookie.split('; ').find(row => row.startsWith('access_token')).split('=')[1]
                }
                catch(e){
                    token = null;
                }
                // extract workspace from url
                // for example: http://127.0.0.1:9527/ws-user-github%7C478667#services => ws-user-github|478667
                const workspace = decodeURIComponent(window.location.href.split(window.location.origin)[1].split('/')[1].split("#")[0].split('?')[0]);
                return {
                    server_url: window.location.origin,
                    workspace,
                    token,
                    method_timeout: 120,
                }
            }
        }
        window.defaultService = defaultService;
        const hyphaCore = new HyphaCore({base_url: "/hypha-core-app/", default_service: defaultService});
        hyphaCore.on("add_window", (config) => {
            const root = document.getElementById("hypha-window-container");
            // get the left and top position of the root element
            // then set it to the WinBox
            const rect = root.getBoundingClientRect();

            const wb = new WinBox(config.name || config.src.slice(0, 128), {
                root: root,
                y: rect.top + 10,
                x: rect.left + 10,
                background: "#448aff",
            });
            wb.body.innerHTML = `<iframe src="${config.src}" id="${config.window_id}" style="width: 100%; height: 100%; border: none;"></iframe>`;
        });
        const api = await hyphaCore.start();

        console.log("Hypha core started:", hyphaCore.url);
        async function loadPluginFromUrl(url) {
            const plugin = await api.loadPlugin({ src: url});
            await plugin.run({ config: {}, data: {} });
            console.log("Loaded and ran plugin from URL:", url);
        }
        window.loadPlugin = loadPluginFromUrl;

                 window.loadCodeEditor = async function (ws, refreshApps) {
             if (!ws || !ws.getService) {
                 alert('WebSocket connection not ready. Please wait for the connection to be established.');
                 return;
             }
             
             const response = await fetch("/ws/code_template.hypha.html");
             const pythonPluginCode = await response.text();
             await api.createWindow({ 
                 name: "Code Editor",
                 src: "https://if.imjoy.io",
                config: {
                    fold: [1],
                    templates: [
                        {
                            name: "Basic JavaScript App",
                            url: window.location.origin + "/ws/code_template.hypha.html",
                            lang: 'javascript',
                        },
                        {
                            name: "JavaScript Test App", 
                            url: window.location.origin + "/ws/javascript_app_template.hypha.html",
                            lang: 'javascript',
                        },
                        {
                            name: "Python Test App",
                            url: window.location.origin + "/ws/python_app_template.hypha.html", 
                            lang: 'python',
                        },
                        {
                            name: "FastAPI Web App",
                            url: window.location.origin + "/ws/fastapi_app_template.hypha.html",
                            lang: 'python',
                        },
                    ],
                    ui_elements: {
                         install: {
                             _rintf: true,
                             type: "button",
                             label: "Install Application",
                             visible: true,
                             icon: "file-download-outline",
                             callback: async (source, config) => {
                                 try {
                                     // Show full page spinner
                                     window.showInstallSpinner?.();
                                     
                                     if (!ws || !ws.getService) {
                                         throw new Error('WebSocket connection not ready');
                                     }
                                     const controller = await ws.getService("public/server-apps");
                                     const appInfo = await controller.install(source, {
                                         config: config,
                                         overwrite: true,
                                         _rkwargs: true
                                     });
                                     console.log("App installed successfully:", appInfo);
                                     
                                     // Refresh the apps list
                                     await refreshApps(ws);
                                     return appInfo;
                                 } catch (error) {
                                     console.error("Failed to install app:", error);
                                     // For errors, we still show an alert since it's important feedback
                                     alert(`Failed to install app: ${error}`);
                                     throw error;
                                 } finally {
                                     // Hide spinner
                                     window.hideInstallSpinner?.();
                                 }
                             }
                         }
                     }
                },  
                data: {
                    code: pythonPluginCode,
                }
            });
            console.log("Loaded and ran code editor plugin");
        };
    </script>

    <!-- Render the App component -->
    <script type="text/babel" data-presets="env,react" data-env-targets="defaults, safari >= 12">
        const Sidebar = ({ isCollapsed, onToggle, setActivePanel, enabledPanels }) => {
            return (
                <div className={`sidebar ${isCollapsed ? 'collapsed' : ''}`}>
                    <div className="logo">
                        <a href="/"><img src="/static/img/hypha-logo-black.svg" className={`h-10 invert ${isCollapsed ? 'hidden' : 'block'}`} alt="Hypha Logo" /></a>
                    </div>
                    <div className="menu-item" onClick={() => onToggle()}>
                        <i className="fas fa-bars"></i>
                        <span className="ml-2">Menu</span>
                    </div>
                    <hr className="border-gray-700"></hr>
                    {enabledPanels.includes('dashboard') && (
                    <div className="menu-item" onClick={() => setActivePanel('dashboard')}>
                        <i className="fas fa-cogs"></i>
                        <span className="ml-2">Dashboard</span>
                    </div>
                    )}
                    {enabledPanels.includes('applications') && (
                    <div className="menu-item" onClick={() => setActivePanel('applications')}>
                        <i className="fas fa-th-large"></i>
                        <span className="ml-2">Applications</span>
                    </div>
                    )}
                    {enabledPanels.includes('files') && (
                    <div className="menu-item" onClick={() => setActivePanel('files')}>
                        <i className="fas fa-file-alt"></i>
                        <span className="ml-2">Files</span>
                    </div>
                    )}
                    {enabledPanels.includes('artifacts') && (
                    <div className="menu-item" onClick={() => setActivePanel('artifacts')}>
                        <i className="fas fa-file-alt"></i>
                        <span className="ml-2">Artifacts</span>
                    </div>
                    )}
                    {enabledPanels.includes('development') && (
                    <div className="menu-item" onClick={() => setActivePanel('development')}>
                        <i className="fas fa-code"></i>
                        <span className="ml-2">Development</span>
                    </div>
                    )}
                </div>
            );
        };

        const ClientCard = ({ client }) => {
            return (
                <div className="flex flex-col items-start p-6 bg-gray-800 rounded-lg shadow-lg mb-6 w-full">
                    <div className="flex items-center mb-4">
                        <i className="fas fa-users fa-3x text-white mr-4"></i>
                    </div>
                    <div className="text-gray-400 whitespace-pre-wrap break-words w-full">
                        <p className="mb-4">
                            <strong>Client ID:</strong> {client.id.split('/')[1]}
                        </p>
                        <p className="mb-4">
                            {client.user && (<strong>User:</strong>)} {client.user && client.user.id}
                        </p>
                        <p className="mb-4">
                            {client.user && (<strong>Email:</strong>)} {client.user && client.user.email}
                        </p>
                    </div>
                </div>
            );
        };        

        const ServiceCard = ({ service, onShowDetails, onBookmarkService }) => {
            return (
              <div className="relative flex flex-col items-start p-6 bg-gray-800 rounded-lg shadow-lg mb-6 w-full">
                {/* Bookmark icon in the upper right corner */}
                <button
                  class="absolute top-2 right-2 text-white"
                  onClick={() => onBookmarkService(service.id)}
                >
                  <i className="fas fa-bookmark"></i>
                </button>
          
                {/* Service information */}
                <div className="flex items-center mb-4">
                  <i className="fas fa-cog fa-3x text-white mr-4"></i>
                  <div>
                    <h3 className="text-xl font-bold whitespace-pre-wrap break-words">
                      {service.id.split(":")[1]}
                    </h3>
                    <p className="text-gray-400">Type: {service.type}</p>
                  </div>
                </div>
          
                <div className="text-gray-400 whitespace-pre-wrap break-words w-full">
                  <p className="mb-4">
                    <strong>ID:</strong> {service.id}
                  </p>
                  <p className="mb-4">
                    <strong>Visibility:</strong>
                    {service.config.visibility === 'public' ? (
                      <i className="fas fa-globe m-1 text-blue-500"></i>
                    ) : (
                      <i className="fas fa-lock m-1 text-red-500"></i>
                    )}
                    {service.config.visibility}
                  </p>
                  <p className="mb-4">{service.description}</p>
                </div>
          
                <button
                  className="mt-auto bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                  onClick={() => onShowDetails(service)}
                >
                  <i className="fas fa-info-circle mr-2"></i> View Details
                </button>
              </div>
            );
          };          
        

        const AppCard = ({ app, onUninstall, onShowDetails, onStart }) => {
            const [showServices, setShowServices] = React.useState(false);
            const [copiedServiceId, setCopiedServiceId] = React.useState('');
            
            const services = app.services || [];
            const serverUrl = window.location.origin;
            // For installed apps, we need to get the workspace from the current config
            const workspace = window.defaultService.getServerConfig().workspace;
            
            const copyServiceId = async (serviceId) => {
                try {
                    await navigator.clipboard.writeText(serviceId);
                    setCopiedServiceId(serviceId);
                    setTimeout(() => setCopiedServiceId(''), 2000);
                } catch (error) {
                    console.error('Failed to copy service ID:', error);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = serviceId;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    setCopiedServiceId(serviceId);
                    setTimeout(() => setCopiedServiceId(''), 2000);
                }
            };
            
            const getServiceUrl = (service) => {
                // For installed apps: [workspace]/apps/[service_id]@[app_id]/
 
                return `${serverUrl}/${workspace}/services/${service.id.split(":")[1]}@${app.id}`;
                
            };
            
            const getAppUrl = (service) => {
                // For ASGI apps, same URL as service URL
                return `${serverUrl}/${workspace}/apps/${service.id.split(":")[1]}@${app.id}/`;
            };
            
            return (
                <div className="flex flex-col items-start p-6 bg-gray-800 rounded-lg shadow-lg mb-6 w-full">
                    <div className="flex items-center mb-4 w-full">
                        <i className={`fas fa-th-large fa-3x text-white mr-4`}></i>
                        <div className="flex-1">
                            <h3 className="text-xl font-bold">{app.name || 'Untitled App'}</h3>
                            <p className="text-gray-400 text-sm">ID: <code className="bg-gray-700 px-1 rounded">{app.id}</code></p>
                            <p className="text-gray-400 mt-2">{app.description || 'No description available'}</p>
                            <div className="flex flex-wrap gap-2 mt-2">
                                <span className="bg-blue-600 text-white px-2 py-1 rounded text-xs">
                                    {app.type || 'Unknown'}
                                </span>
                                <span className="bg-gray-600 text-white px-2 py-1 rounded text-xs">
                                    v{app.version || '1.0.0'}
                                </span>
                                {app.daemon && (
                                    <span className="bg-green-600 text-white px-2 py-1 rounded text-xs">
                                        Daemon
                                    </span>
                                )}
                                {app.singleton && (
                                    <span className="bg-purple-600 text-white px-2 py-1 rounded text-xs">
                                        Singleton
                                    </span>
                                )}
                                {services.length > 0 && (
                                    <span className="bg-orange-600 text-white px-2 py-1 rounded text-xs">
                                        {services.length} Service{services.length > 1 ? 's' : ''}
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Services Section */}
                    {services.length > 0 && (
                        <div className="w-full mb-4">
                            <button
                                className="flex items-center justify-between w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300"
                                onClick={() => setShowServices(!showServices)}
                            >
                                <span className="flex items-center">
                                    <i className="fas fa-cogs mr-2"></i> 
                                    Services ({services.length})
                                </span>
                                <i className={`fas fa-chevron-${showServices ? 'up' : 'down'}`}></i>
                            </button>
                            
                            {showServices && (
                                <div className="mt-2 space-y-2 max-h-64 overflow-y-auto">
                                    {services.map((service, index) => (
                                        <div key={index} className="bg-gray-700 p-3 rounded">
                                            <div className="flex items-center justify-between mb-2">
                                                <div className="flex items-center">
                                                    <i className="fas fa-cog mr-2 text-blue-400"></i>
                                                    <span className="font-medium text-white">{service.id.split('@')[0]}</span>
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <span className={`px-2 py-1 rounded text-xs ${
                                                        service.config?.visibility === 'public' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
                                                    }`}>
                                                        {service.config?.visibility || 'protected'}
                                                    </span>
                                                    {service.type && (
                                                        <span className="bg-gray-600 text-white px-2 py-1 rounded text-xs">
                                                            {service.type}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            <div className="text-sm text-gray-300 mb-2">
                                                <code className="bg-gray-800 px-1 rounded text-xs break-all">{service.id}</code>
                                            </div>
                                            
                                            <div className="flex flex-wrap gap-2">
                                                {/* Copy Service ID Button */}
                                                <button
                                                    onClick={() => copyServiceId(service.id)}
                                                    className={`text-xs px-2 py-1 rounded transition duration-300 ${
                                                        copiedServiceId === service.id
                                                            ? 'bg-green-600 hover:bg-green-500 text-white'
                                                            : 'bg-gray-600 hover:bg-gray-500 text-white'
                                                    }`}
                                                    title="Copy service ID"
                                                >
                                                    <i className={`fas ${copiedServiceId === service.id ? 'fa-check' : 'fa-copy'} mr-1`}></i>
                                                    {copiedServiceId === service.id ? 'Copied!' : 'Copy ID'}
                                                </button>
                                                
                                                {/* Service URL Link */}
                                                <a
                                                    href={getServiceUrl(service)}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded transition duration-300 flex items-center"
                                                    title="Open service URL"
                                                >
                                                    <i className="fas fa-external-link-alt mr-1"></i>
                                                    Service URL
                                                </a>
                                                
                                                {/* App URL Link for ASGI services */}
                                                {service.type === 'asgi' && (
                                                    <a
                                                        href={getAppUrl(service)}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="text-xs bg-purple-600 hover:bg-purple-500 text-white px-2 py-1 rounded transition duration-300 flex items-center"
                                                        title="Open ASGI app"
                                                    >
                                                        <i className="fas fa-globe mr-1"></i>
                                                        Visit App
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    
                    <div className="flex gap-2 w-full justify-end">
                        <button
                            className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center"
                            onClick={() => onStart(app.id)}
                        >
                            <i className="fas fa-play mr-2"></i> Start
                        </button>
                        <button
                            className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center"
                            onClick={() => onShowDetails(app)}
                        >
                            <i className="fas fa-info-circle mr-2"></i> More
                        </button>
                        <button
                            className="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center"
                            onClick={() => onUninstall(app.id)}
                        >
                            <i className="fas fa-trash mr-2"></i> Uninstall
                        </button>
                    </div>
                </div>
            );
        };

        const RunningAppCard = ({ app, onStop, onShowDetails }) => {
            const [showServices, setShowServices] = React.useState(false);
            const [copiedServiceId, setCopiedServiceId] = React.useState('');
            
            const services = app.services || [];
            const serverUrl = window.location.origin;
            const workspace = app.workspace;
            
            const copyServiceId = async (serviceId) => {
                try {
                    await navigator.clipboard.writeText(serviceId);
                    setCopiedServiceId(serviceId);
                    setTimeout(() => setCopiedServiceId(''), 2000);
                } catch (error) {
                    console.error('Failed to copy service ID:', error);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = serviceId;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    setCopiedServiceId(serviceId);
                    setTimeout(() => setCopiedServiceId(''), 2000);
                }
            };
            
            const getServiceUrl = (service) => {
                // For running apps: [workspace]/apps/[client_id]:[service_id]/
                const serviceName = service.id.split('@')[0];
                
                return `${serverUrl}/${workspace}/services/${serviceName.split("/")[1]}`;
                
            };
            
            const getAppUrl = (service) => {
                return `${serverUrl}/${workspace}/apps/${service.id.split("/")[1]}/`;
            };
            
            return (
                <div className="flex flex-col items-start p-6 bg-gray-800 rounded-lg shadow-lg mb-6 w-full">
                    <div className="flex items-center mb-4 w-full">
                        <i className={`fas fa-play-circle fa-3x text-green-400 mr-4`}></i>
                        <div className="flex-1">
                            <h3 className="text-xl font-bold">{app.name || 'Untitled App'}</h3>
                            <p className="text-gray-400 text-sm">Session ID: <code className="bg-gray-700 px-1 rounded">{app.id}</code></p>
                            <p className="text-gray-400 text-sm">App ID: <code className="bg-gray-700 px-1 rounded">{app.app_id}</code></p>
                            <p className="text-gray-400 mt-2">{app.description || 'No description available'}</p>
                            <div className="flex flex-wrap gap-2 mt-2">
                                <span className="bg-green-600 text-white px-2 py-1 rounded text-xs">
                                    <i className="fas fa-play mr-1"></i> Running
                                </span>
                                <span className="bg-blue-600 text-white px-2 py-1 rounded text-xs">
                                    Workspace: {app.workspace}
                                </span>
                                {app.service_id && (
                                    <span className="bg-purple-600 text-white px-2 py-1 rounded text-xs">
                                        Service: {app.service_id.split('@')[0]}
                                    </span>
                                )}
                                {services.length > 0 && (
                                    <span className="bg-orange-600 text-white px-2 py-1 rounded text-xs">
                                        {services.length} Service{services.length > 1 ? 's' : ''}
                                    </span>
                                )}
                            </div>
                        </div>
                    </div>
                    
                    {/* Services Section */}
                    {services.length > 0 && (
                        <div className="w-full mb-4">
                            <button
                                className="flex items-center justify-between w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300"
                                onClick={() => setShowServices(!showServices)}
                            >
                                <span className="flex items-center">
                                    <i className="fas fa-cogs mr-2"></i> 
                                    Services ({services.length})
                                </span>
                                <i className={`fas fa-chevron-${showServices ? 'up' : 'down'}`}></i>
                            </button>
                            
                            {showServices && (
                                <div className="mt-2 space-y-2 max-h-64 overflow-y-auto">
                                    {services.map((service, index) => (
                                        <div key={index} className="bg-gray-700 p-3 rounded">
                                            <div className="flex items-center justify-between mb-2">
                                                <div className="flex items-center">
                                                    <i className="fas fa-cog mr-2 text-blue-400"></i>
                                                    <span className="font-medium text-white">{service.id.split('@')[0]}</span>
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <span className={`px-2 py-1 rounded text-xs ${
                                                        service.config?.visibility === 'public' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'
                                                    }`}>
                                                        {service.config?.visibility || 'protected'}
                                                    </span>
                                                    {service.type && (
                                                        <span className="bg-gray-600 text-white px-2 py-1 rounded text-xs">
                                                            {service.type}
                                                        </span>
                                                    )}
                                                </div>
                                            </div>
                                            
                                            <div className="text-sm text-gray-300 mb-2">
                                                <code className="bg-gray-800 px-1 rounded text-xs break-all">{service.id}</code>
                                            </div>
                                            
                                            <div className="flex flex-wrap gap-2">
                                                {/* Copy Service ID Button */}
                                                <button
                                                    onClick={() => copyServiceId(service.id)}
                                                    className={`text-xs px-2 py-1 rounded transition duration-300 ${
                                                        copiedServiceId === service.id
                                                            ? 'bg-green-600 hover:bg-green-500 text-white'
                                                            : 'bg-gray-600 hover:bg-gray-500 text-white'
                                                    }`}
                                                    title="Copy service ID"
                                                >
                                                    <i className={`fas ${copiedServiceId === service.id ? 'fa-check' : 'fa-copy'} mr-1`}></i>
                                                    {copiedServiceId === service.id ? 'Copied!' : 'Copy ID'}
                                                </button>
                                                
                                                {/* Service URL Link */}
                                                <a
                                                    href={getServiceUrl(service)}
                                                    target="_blank"
                                                    rel="noopener noreferrer"
                                                    className="text-xs bg-blue-600 hover:bg-blue-500 text-white px-2 py-1 rounded transition duration-300 flex items-center"
                                                    title="Open service URL"
                                                >
                                                    <i className="fas fa-external-link-alt mr-1"></i>
                                                    Service URL
                                                </a>
                                                
                                                {/* App URL Link for ASGI services */}
                                                {service.type === 'asgi' && (
                                                    <a
                                                        href={getAppUrl(service)}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="text-xs bg-purple-600 hover:bg-purple-500 text-white px-2 py-1 rounded transition duration-300 flex items-center"
                                                        title="Open ASGI app"
                                                    >
                                                        <i className="fas fa-globe mr-1"></i>
                                                        Visit App
                                                    </a>
                                                )}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}
                    
                    <div className="flex gap-2 w-full justify-end">
                        <button
                            className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center"
                            onClick={() => onShowDetails(app)}
                        >
                            <i className="fas fa-info-circle mr-2"></i> More
                        </button>
                        <button
                            className="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded transition duration-300 flex items-center"
                            onClick={() => onStop(app.id)}
                        >
                            <i className="fas fa-stop mr-2"></i> Stop
                        </button>
                    </div>
                </div>
            );
        };

        const FileCard = ({
            file,
            onDownload,
            onDelete,
            onToggle,
            isExpanded,
            isLoading,
            children,
            fullPath,
            onUploadToFolder,
            onCreateFolder,
            onDragOver,
            onDragEnter,
            onDragLeave,
            onDrop,
            onUploadFolderToPath,
        }) => {
            const isDirectory = file.type === 'directory';
            const [isHovered, setIsHovered] = React.useState(false);
            
            return (
                <div 
                    className="file-card flex flex-col justify-between items-start p-3 bg-gray-700 shadow-md transition-colors duration-200"
                    onDragOver={isDirectory ? onDragOver : undefined}
                    onDragEnter={isDirectory ? onDragEnter : undefined}
                    onDragLeave={isDirectory ? onDragLeave : undefined}
                    onDrop={isDirectory ? (e) => onDrop(e, fullPath) : undefined}
                    onMouseEnter={() => setIsHovered(true)}
                    onMouseLeave={() => setIsHovered(false)}
                >
                    <div className="file-item flex items-center w-full justify-between relative">
                        <div className="flex items-center">
                            {isDirectory && (
                                <button 
                                    className="mr-2 min-w-[20px] text-center" 
                                    onClick={() => onToggle(fullPath)} 
                                    disabled={isLoading}
                                    style={{ opacity: isLoading ? 0.7 : 1 }}
                                >
                                    {isLoading ? (
                                        <i className="fas fa-spinner fa-spin text-blue-400"></i>
                                    ) : (
                                        isExpanded ? '-' : '+'
                                    )}
                                </button>
                            )}
                            <i className={`fas ${isDirectory ? 'fa-folder' : 'fa-file-alt'} mr-2`}></i>
                            <span className="flex-1">
                                {file.name}
                                {isDirectory && isHovered && (
                                    <span className="text-xs text-gray-400 ml-2">(drop files/folders here)</span>
                                )}
                            </span>
                        </div>
                        <div className="file-item-buttons">
                            {isDirectory ? (
                                <>
                                <button
                                    className="bg-green-600 hover:bg-green-500 text-white font-bold py-1 px-2 rounded-full transition duration-300 mr-1"
                                    onClick={() => onUploadToFolder(fullPath)}
                                    title="Upload files to this folder"
                                >
                                    <i className="fas fa-upload"></i>
                                </button>
                                <button
                                    className="bg-purple-600 hover:bg-purple-500 text-white font-bold py-1 px-2 rounded-full transition duration-300 mr-1"
                                    onClick={() => onUploadFolderToPath(fullPath)}
                                    title="Upload folder to this folder"
                                >
                                    <i className="fas fa-folder-open"></i>
                                </button>
                                <button
                                    className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-1 px-2 rounded-full transition duration-300 mr-1"
                                    onClick={() => onCreateFolder(fullPath)}
                                    title="Create subfolder"
                                >
                                    <i className="fas fa-folder-plus"></i>
                                </button>
                                <button
                                    className="bg-red-600 hover:bg-red-500 text-white font-bold py-1 px-2 rounded-full transition duration-300"
                                    onClick={() => onDelete(fullPath, file.type)}
                                    title="Delete folder"
                                >
                                    <i className="fas fa-trash"></i>
                                </button>
                                </>
                            ) : (
                                <>
                                <button
                                    className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300"
                                    onClick={() => onDownload(fullPath)}
                                    title="Download file"
                                >
                                    <i className="fas fa-download"></i>
                                </button>
                                <button
                                    className="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 ml-2"
                                    onClick={() => onDelete(fullPath, file.type)}
                                    title="Delete file"
                                >
                                    <i className="fas fa-trash"></i>
                                </button>
                                </>
                            )}
                            
                        </div>
                    </div>
                    {isExpanded && <div className="w-full mt-3 ml-3">{children}</div>}
                </div>
            );
        };        
        
        const FileTree = ({
            files,
            onDownload,
            onDelete,
            listFiles,
            expandedDirs,
            setExpandedDirs,
            parentPath = "",
            onUploadToFolder,
            onCreateFolder,
            onDragOver,
            onDragEnter,
            onDragLeave,
            onDrop,
            onUploadFolderToPath,
        }) => {
            const [loadingDirs, setLoadingDirs] = React.useState({});
            
            const handleToggle = async (fullPath) => {
                const isExpanded = !!expandedDirs[fullPath];
                if (isExpanded) {
                    setExpandedDirs({ ...expandedDirs, [fullPath]: null });
                } else {
                    // Set loading state immediately
                    setLoadingDirs({ ...loadingDirs, [fullPath]: true });
                    
                    try {
                        const children = await listFiles(fullPath);
                        setExpandedDirs({ ...expandedDirs, [fullPath]: children });
                    } catch (error) {
                        console.error("Error loading directory:", error);
                    } finally {
                        // Clear loading state
                        setLoadingDirs({ ...loadingDirs, [fullPath]: false });
                    }
                }
            };
        
            return (
                <div>
                    {files.map((file) => {
                        const fullPath = parentPath ? `${parentPath}/${file.name}` : file.name;
                        return (
                            <FileCard
                                key={`${fullPath}-${file.type}`} // Ensure key is unique
                                file={file}
                                onDownload={onDownload}
                                onDelete={onDelete}
                                isExpanded={!!expandedDirs[fullPath]}
                                isLoading={!!loadingDirs[fullPath]}
                                onToggle={handleToggle}
                                fullPath={fullPath}
                                onUploadToFolder={onUploadToFolder}
                                onCreateFolder={onCreateFolder}
                                onDragOver={onDragOver}
                                onDragEnter={onDragEnter}
                                onDragLeave={onDragLeave}
                                onDrop={onDrop}
                                onUploadFolderToPath={onUploadFolderToPath}
                            >
                                {expandedDirs[fullPath] && (
                                    <FileTree
                                        files={expandedDirs[fullPath]}
                                        onDownload={onDownload}
                                        onDelete={onDelete}
                                        listFiles={listFiles}
                                        expandedDirs={expandedDirs}
                                        setExpandedDirs={setExpandedDirs}
                                        parentPath={fullPath}
                                        onUploadToFolder={onUploadToFolder}
                                        onCreateFolder={onCreateFolder}
                                        onDragOver={onDragOver}
                                        onDragEnter={onDragEnter}
                                        onDragLeave={onDragLeave}
                                        onDrop={onDrop}
                                        onUploadFolderToPath={onUploadFolderToPath}
                                    />
                                )}
                            </FileCard>
                        );
                    })}
                </div>
            );
        };                    

        const Modal = ({ serviceInfo, onClose }) => {
            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h2 className="text-2xl font-bold">Service Details</h2>
                            <button onClick={onClose} className="text-white text-2xl">&times;</button>
                        </div>
                        <div className="modal-body">
                            <pre className="whitespace-pre-wrap text-gray-200">
                                {JSON.stringify(serviceInfo, null, 2)}
                            </pre>
                        </div>
                    </div>
                </div>
            );
        };

        const SpinnerOverlay = ({ isVisible, message = "Loading..." }) => {
            if (!isVisible) return null;
            
            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div className="bg-gray-800 rounded-lg p-8 flex flex-col items-center">
                        <div className="animate-spin rounded-full h-16 w-16 border-b-2 border-white mb-4"></div>
                        <p className="text-white text-lg font-medium">{message}</p>
                        <p className="text-gray-400 text-sm mt-2">Please wait...</p>
                    </div>
                </div>
            );
        };

        const AppDetailsModal = ({ app, onClose }) => {
            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h2 className="text-2xl font-bold">App Details</h2>
                            <button onClick={onClose} className="text-white text-2xl">&times;</button>
                        </div>
                        <div className="modal-body">
                            <pre className="whitespace-pre-wrap text-gray-200 max-h-96 overflow-y-auto">
                                {JSON.stringify(app, null, 2)}
                            </pre>
                        </div>
                    </div>
                </div>
            );
        };

        const EnvManagementPanel = ({ ws }) => {
            const [envVars, setEnvVars] = React.useState({});
            const [showEnvVars, setShowEnvVars] = React.useState(false);
            const [newEnvKey, setNewEnvKey] = React.useState('');
            const [newEnvValue, setNewEnvValue] = React.useState('');
            const [loading, setLoading] = React.useState(false);
            const [visibleValues, setVisibleValues] = React.useState({});
            const [copiedKeys, setCopiedKeys] = React.useState({});

            const fetchEnvVars = async () => {
                if (!ws) return;
                try {
                    setLoading(true);
                    const allEnvs = await ws.getEnv();
                    setEnvVars(allEnvs || {});
                } catch (error) {
                    console.error('Failed to fetch environment variables:', error);
                    alert(`Failed to fetch environment variables: ${error}`);
                } finally {
                    setLoading(false);
                }
            };

            React.useEffect(() => {
                if (showEnvVars) {
                    fetchEnvVars();
                }
            }, [showEnvVars, ws]);

            const handleAddEnvVar = async () => {
                if (!newEnvKey.trim()) {
                    alert('Please enter a valid environment variable name');
                    return;
                }
                
                try {
                    window.showLoadingSpinner('Adding Environment Variable...');
                    setLoading(true);
                    await ws.setEnv(newEnvKey.trim(), newEnvValue);
                    setNewEnvKey('');
                    setNewEnvValue('');
                    await fetchEnvVars();
                } catch (error) {
                    console.error('Failed to set environment variable:', error);
                    alert(`Failed to set environment variable: ${error}`);
                } finally {
                    setLoading(false);
                    window.hideLoadingSpinner();
                }
            };

            const handleRemoveEnvVar = async (key) => {
                if (!confirm(`Are you sure you want to remove the environment variable "${key}"?`)) {
                    return;
                }
                
                try {
                    window.showLoadingSpinner('Removing Environment Variable...');
                    setLoading(true);
                    await ws.setEnv({key, value: null, _rkwargs: true});
                    await fetchEnvVars();
                } catch (error) {
                    console.error('Failed to remove environment variable:', error);
                    alert(`Failed to remove environment variable: ${error}`);
                } finally {
                    setLoading(false);
                    window.hideLoadingSpinner();
                }
            };

            const toggleValueVisibility = (key) => {
                setVisibleValues(prev => ({
                    ...prev,
                    [key]: !prev[key]
                }));
            };

            const copyEnvVar = async (key, value) => {
                const envString = `${key}="${value}"`;
                try {
                    await navigator.clipboard.writeText(envString);
                    // Show copied feedback
                    setCopiedKeys(prev => ({ ...prev, [key]: true }));
                    setTimeout(() => {
                        setCopiedKeys(prev => ({ ...prev, [key]: false }));
                    }, 2000);
                } catch (error) {
                    console.error('Failed to copy to clipboard:', error);
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = envString;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    // Show copied feedback for fallback too
                    setCopiedKeys(prev => ({ ...prev, [key]: true }));
                    setTimeout(() => {
                        setCopiedKeys(prev => ({ ...prev, [key]: false }));
                    }, 2000);
                }
            };

            return (
                <div className="main-content">
                    <p className="text-xl text-gray-400 mt-4">
                        Manage environment variables shared across all clients in this workspace
                    </p>
                    
                    <button
                        className={`mt-4 font-bold py-2 px-4 rounded-full transition duration-300 flex items-center ${
                            showEnvVars 
                                ? 'bg-red-600 hover:bg-red-500 text-white' 
                                : 'bg-blue-600 hover:bg-blue-500 text-white'
                        }`}
                        onClick={() => setShowEnvVars(!showEnvVars)}
                        disabled={loading}
                    >
                        <i className={`fas ${showEnvVars ? 'fa-eye-slash' : 'fa-eye'} mr-2`}></i>
                        {showEnvVars ? 'Hide' : 'Show'} Environment Variables
                    </button>

                    {showEnvVars && (
                        <div className="mt-6 p-6 bg-gray-800 rounded-lg shadow-lg">
                            {/* Add new environment variable */}
                            <div className="mb-4 p-3 bg-gray-700 rounded-lg">
                                <h3 className="text-lg font-bold mb-3 text-white">Add New Environment Variable</h3>
                                <div className="flex flex-col md:flex-row gap-3">
                                    <div className="flex-1">
                                        <label className="block text-sm font-medium text-gray-300 mb-1">
                                            Variable Name
                                        </label>
                                        <input
                                            type="text"
                                            value={newEnvKey}
                                            onChange={(e) => setNewEnvKey(e.target.value)}
                                            placeholder="e.g., API_KEY"
                                            className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-900 text-white"
                                            disabled={loading}
                                        />
                                    </div>
                                    <div className="flex-1">
                                        <label className="block text-sm font-medium text-gray-300 mb-1">
                                            Value
                                        </label>
                                        <input
                                            type="text"
                                            value={newEnvValue}
                                            onChange={(e) => setNewEnvValue(e.target.value)}
                                            placeholder="Variable value"
                                            className="w-full px-3 py-2 border border-gray-600 rounded-md bg-gray-900 text-white"
                                            disabled={loading}
                                        />
                                    </div>
                                    <div className="flex items-end">
                                        <button
                                            onClick={handleAddEnvVar}
                                            disabled={loading || !newEnvKey.trim()}
                                            className="w-full md:w-auto bg-green-600 hover:bg-green-500 disabled:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300"
                                        >
                                            {loading ? 'Adding...' : 'Add Variable'}
                                        </button>
                                    </div>
                                </div>
                            </div>

                            {/* Current environment variables */}
                            <div>
                                <h3 className="text-lg font-bold mb-4 text-white">Current Environment Variables</h3>
                                {loading ? (
                                    <div className="text-center py-4">
                                        <i className="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                                        <p className="text-gray-400 mt-2">Loading environment variables...</p>
                                    </div>
                                ) : Object.keys(envVars).length === 0 ? (
                                    <div className="text-center py-8 text-gray-400">
                                        <i className="fas fa-inbox text-4xl mb-4"></i>
                                        <p>No environment variables set</p>
                                    </div>
                                ) : (
                                                                         <div className="space-y-3">
                                        {Object.entries(envVars).map(([key, value]) => (
                                            <div
                                                key={key}
                                                className="flex items-center justify-between p-3 bg-gray-700 rounded-lg hover:bg-gray-600 transition duration-300"
                                            >
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center space-x-3">
                                                        <span className="font-mono text-sm bg-gray-800 px-2 py-1 rounded text-green-400">
                                                            {key}
                                                        </span>
                                                        <span className="text-gray-300">=</span>
                                                        <span className="font-mono text-sm text-gray-300 truncate">
                                                            {visibleValues[key] 
                                                                ? (typeof value === 'string' && value.length > 50 
                                                                    ? `${value.substring(0, 50)}...` 
                                                                    : String(value))
                                                                : '****'
                                                            }
                                                        </span>
                                                    </div>
                                                </div>
                                                <div className="flex items-center space-x-2">
                                                    <button
                                                        onClick={() => toggleValueVisibility(key)}
                                                        className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-1 px-3 rounded transition duration-300 flex items-center"
                                                        title={visibleValues[key] ? 'Hide value' : 'Show value'}
                                                    >
                                                        <i className={`fas ${visibleValues[key] ? 'fa-eye-slash' : 'fa-eye'}`}></i>
                                                    </button>
                                                    <button
                                                        onClick={() => copyEnvVar(key, value)}
                                                        className={`font-bold py-1 px-3 rounded transition duration-300 flex items-center ${
                                                            copiedKeys[key] 
                                                                ? 'bg-green-600 hover:bg-green-500 text-white' 
                                                                : 'bg-blue-600 hover:bg-blue-500 text-white'
                                                        }`}
                                                        title={copiedKeys[key] ? 'Copied!' : `Copy ${key}="${value}"`}
                                                    >
                                                        <i className={`fas ${copiedKeys[key] ? 'fa-check' : 'fa-copy'}`}></i>
                                                    </button>
                                                    <button
                                                        onClick={() => handleRemoveEnvVar(key)}
                                                        disabled={loading}
                                                        className="bg-red-600 hover:bg-red-500 disabled:bg-gray-600 text-white font-bold py-1 px-3 rounded transition duration-300 flex items-center"
                                                        title={`Remove ${key}`}
                                                    >
                                                        <i className="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>

                            {/* Info box */}
                            <div className="mt-6 p-4 bg-blue-900 bg-opacity-30 border border-blue-700 rounded-lg">
                                <div className="flex items-start">
                                    <i className="fas fa-info-circle text-blue-400 mr-3 mt-1"></i>
                                    <div className="text-sm text-blue-200">
                                        <p className="font-medium mb-1">About Environment Variables:</p>
                                        <ul className="list-disc list-inside space-y-1 text-blue-300">
                                            <li>Environment variables are shared across all clients in this workspace</li>
                                            <li>They are stored securely and persist between sessions</li>
                                            <li>Use them to store API keys, configuration values, or other shared data</li>
                                            <li>Removing a variable sets its value to null</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TokenPanel = ({ workspaceId, onGenerateToken }) => {
            const [workspace, setWorkspace] = React.useState(workspaceId);
            const [expiryTime, setExpiryTime] = React.useState(3600);
            const [clientId, setClientId] = React.useState(null);
            const [generatedToken, setGeneratedToken] = React.useState('');
            const [showSnackBar, setShowSnackBar] = React.useState(false);

            const handleGenerateToken = async () => {
                try {
                    const token = await onGenerateToken(workspace, expiryTime, clientId);
                    setGeneratedToken(token);
                } catch (error) {
                    console.error("Failed to generate token:", error);
                    alert("Failed to generate token. Please try again later.");
                }
            };
        
            const handleCopyToken = () => {
                navigator.clipboard.writeText(generatedToken);
                setShowSnackBar(true);
                setTimeout(() => setShowSnackBar(false), 2000); // Snack bar disappears after 2 seconds
            };
        
            return (
                <div className="main-content">
                    <div className="mt-4">
                        <label htmlFor="workspace" className="block text-sm font-medium text-gray-300">
                            Workspace Name
                        </label>
                        <input
                            type="text"
                            id="workspace"
                            name="workspace"
                            className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                            value={workspace}
                            onChange={(e) => setWorkspace(e.target.value)}
                        />
                    </div>
                    <div className="mt-4">
                        <label htmlFor="expiry-time" className="block text-sm font-medium text-gray-300">
                            Expiry Time (seconds)
                        </label>
                        <input
                            type="number"
                            id="expiry-time"
                            name="expiry-time"
                            className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                            placeholder="3600"
                            value={expiryTime}
                            onChange={(e) => setExpiryTime(e.target.value)}
                        />
                    </div>
                    <div className="mt-4">
                        <label htmlFor="client-id" className="block text-sm font-medium text-gray-300">
                            Client ID (Optional)
                            <p className="text-gray-500 text-xs mt-1">
                                If specified, this token can only be used by the client with this ID. Leave empty for unrestricted access.
                            </p>
                        </label>
                        <input
                            type="text"
                            id="client-id"
                            name="client-id"
                            className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                            placeholder="e.g., my-app-client"
                            value={clientId || ''}
                            onChange={(e) => setClientId(e.target.value.trim() === '' ? null : e.target.value)}
                        />
                    </div>
                    <div className="mt-4">
                        <button
                            className="bg-blue-500 text-white py-2 px-4 rounded"
                            onClick={handleGenerateToken}
                        >
                            Generate Token
                        </button>
                    </div>
                    {generatedToken && (
                        <div className="mt-4">
                            <h3 className="text-lg font-bold">Generated Token:</h3>
                            <pre className="text-black bg-gray-200 p-4 rounded break-words whitespace-pre-wrap max-h-48 overflow-y-auto">
                                {generatedToken}
                            </pre>
                            <button 
                                className="bg-gray-500 text-white py-1 px-4 rounded mt-2" 
                                onClick={handleCopyToken}
                            >
                                Copy Token
                            </button>
                        </div>
                    )}
                    {showSnackBar && (
                        <div className="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded shadow-md">
                            Token copied to clipboard!
                        </div>
                    )}
                </div>
            );
        };
        const ArtifactCard = ({
            artifact,
            onToggle,
            isExpanded,
            children,
            fullPath,
            onMoreInfo,
            onDelete,
        }) => {
            const isCollection = artifact.type === "collection";
        
            return (
                <div className="artifact-card flex flex-col justify-between items-start p-3 bg-gray-700 shadow-md">
                    <div className="artifact-item flex items-center w-full justify-between">
                        <div className="flex items-center p-6 bg-gray-800 rounded-lg shadow-lg mb-6 w-full">
                            {isCollection && (
                                <button className="mr-2" onClick={() => onToggle(fullPath)}>
                                    {isExpanded ? "-" : "+"}
                                </button>
                            )}
                            <i
                                className={`fas ${
                                    isCollection ? "fa-folder" : "fa-file-alt"
                                } mr-2`}
                            ></i>
                            <div className="w-full overflow-hidden">
                                <h4 className="text-xl font-bold truncate">{artifact.manifest?.name}</h4>
                                <p className="text-gray-400 truncate">{artifact.manifest?.description}</p>
                                <p className="text-gray-400">Type: {artifact.type}</p>
                                <code className="text-gray-400 whitespace-pre-wrap break-words w-full break-all">
                                    ID: {artifact.id}
                                </code>
                                <div className="flex justify-between w-full">
                                    {/* More Info Button */}
                                    <div>
                                        <button
                                            className="bg-blue-500 hover:bg-blue-400 text-white font-bold py-1 px-2 rounded"
                                            onClick={() => onMoreInfo(artifact)}
                                        >
                                            More Info
                                        </button>
                                    </div>
                                    {/* Delete Button */}
                                    <div>
                                        <button
                                            className="bg-red-500 hover:bg-red-400 text-white font-bold py-1 px-2 rounded"
                                            onClick={() => onDelete(artifact.id)}
                                        >
                                            Delete
                                        </button>
                                    </div>
                                </div>                                
                            </div>
                        </div>
                        
                    </div>
                    {isExpanded && <div className="w-full mt-3 ml-3">{children}</div>}
                </div>
            );
        };
        
        const ArtifactTree = ({
            artifacts,
            onToggle,
            expandedArtifacts,
            setExpandedArtifacts,
            parentPath = "",
            listArtifacts,
            onMoreInfo,
            onDelete,
        }) => {
            const handleToggle = async (fullPath) => {
                const isExpanded = !!expandedArtifacts[fullPath];
                if (isExpanded) {
                    setExpandedArtifacts({ ...expandedArtifacts, [fullPath]: null });
                } else {
                    const children = await listArtifacts(fullPath);
                    setExpandedArtifacts({ ...expandedArtifacts, [fullPath]: children });
                }
            };
        
            return (
                <div>
                    {artifacts.map((artifact) => {
                        const fullPath = parentPath
                            ? `${parentPath}/${artifact.id}`
                            : artifact.id;
                        return (
                            <ArtifactCard
                                key={`${fullPath}-${artifact.type}`}
                                artifact={artifact}
                                onToggle={handleToggle}
                                isExpanded={!!expandedArtifacts[fullPath]}
                                fullPath={fullPath}
                                onMoreInfo={onMoreInfo}
                                onDelete={(id) => onDelete(id, parentPath || null)} // Pass parent ID to onDelete
                            >
                                {expandedArtifacts[fullPath] && (
                                    <ArtifactTree
                                        artifacts={expandedArtifacts[fullPath]}
                                        onToggle={onToggle}
                                        expandedArtifacts={expandedArtifacts}
                                        setExpandedArtifacts={setExpandedArtifacts}
                                        parentPath={fullPath}
                                        listArtifacts={listArtifacts}
                                        onMoreInfo={onMoreInfo}
                                        onDelete={onDelete}
                                    />
                                )}
                            </ArtifactCard>
                        );
                    })}
                </div>
            );
        };
        
        const ArtifactInfoModal = ({ artifact, onClose, listFiles, am }) => {
            const [files, setFiles] = React.useState(null);
            const [loading, setLoading] = React.useState(false);
            const [uploading, setUploading] = React.useState(false);
        
            const handleListFiles = async () => {
                try {
                    window.showLoadingSpinner('Loading Files...');
                    setLoading(true); // Show loading state
                    const fileList = await listFiles(artifact.id, ""); // Fetch files at the root of the artifact
                    setFiles(fileList);
                } catch (error) {
                    console.error("Failed to list files:", error);
                    alert(`Failed to list files: ${error}`);
                } finally {
                    setLoading(false); // Hide loading state
                    window.hideLoadingSpinner();
                }
            };
        
            const handleDownloadFile = async (filePath) => {
                try {
                    const url = await am.getFile(artifact.id, filePath); // Get the file URL
                    window.open(url, "_blank"); // Open the URL in a new tab
                } catch (error) {
                    console.error("Failed to download file:", error);
                }
            };
        
            const handleDeleteFile = async (filePath) => {
                try {
                    window.showLoadingSpinner(`Deleting ${filePath}...`);
                    await am.removeFile(artifact.id, filePath); // Delete the file
                    setFiles(await listFiles(artifact.id, "")); // Refresh the file list
                } catch (error) {
                    console.error("Failed to delete file:", error);
                    alert(`Failed to delete file: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        
            const handleUploadFile = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
        
                const filePath = file.name; // Set the file path to the file's name
                try {
                    window.showLoadingSpinner(`Uploading ${file.name} to Artifact...`);
                    setUploading(true);
                    const uploadUrl = await am.putFile(artifact.id, filePath); // Get the upload URL
                    await axios.put(uploadUrl, file, {
                        headers: { "Content-Type": file.type || "application/octet-stream" },
                    });
                    setFiles(await listFiles(artifact.id, "")); // Refresh the file list
                } catch (error) {
                    console.error("Failed to upload file:", error);
                    alert(`Failed to upload file: ${error}`);
                } finally {
                    setUploading(false);
                    window.hideLoadingSpinner();
                }
            };
        
            return (
                <div className="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                    <div className="modal-content bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-2xl">
                        <div className="modal-header flex justify-between items-center border-b border-gray-700 pb-4">
                            <h2 className="text-2xl font-bold text-white">Artifact Details</h2>
                            <button
                                onClick={onClose}
                                className="text-white text-2xl hover:text-red-500 transition"
                            >
                                &times;
                            </button>
                        </div>
                        <div className="modal-body mt-4 text-gray-300">
                            <p>
                                <strong>Name:</strong> {artifact.manifest?.name || "N/A"}
                            </p>
                            <p>
                                <strong>Description:</strong>{" "}
                                {artifact.manifest?.description || "N/A"}
                            </p>
                            <p>
                                <strong>Type:</strong> {artifact.type}
                            </p>
                            <p>
                                <strong>ID:</strong>{" "}
                                <code className="bg-gray-700 text-gray-300 px-2 py-1 rounded">
                                    {artifact.id}
                                </code>
                            </p>
                            <p>
                                <strong>Created At:</strong>{" "}
                                {new Date(artifact.created_at * 1000).toLocaleString()}
                            </p>
                            <p>
                                <strong>File Count:</strong> {artifact.file_count}
                            </p>
                            {artifact.file_count > 0 && (
                                <button
                                    className="hover:bg-blue-500 text-white font-bold py-2 px-4 rounded mt-4 flex items-center space-x-2 transition"
                                    onClick={handleListFiles}
                                    disabled={loading}
                                >
                                    <i className="fas fa-folder-open"></i>
                                    <span>{loading ? "Loading..." : "List Files"}</span>
                                </button>
                            )}
                            {files && files.length > 0 ? (
                                <div className="mt-4">
                                    <h3 className="text-lg font-bold">Files:</h3>
                                    <ul className="list-disc list-inside text-gray-300 mt-2">
                                        {files.map((file) => (
                                            <li key={file.name} className="break-all flex mb-1 items-center justify-between">
                                                <span><i className={`fas ${file.type==='directory' ? 'fa-folder' : 'fa-file-alt'} mr-2`}></i>{file.name}</span>
                                                {file.type === "file" && (
                                                    <div className="flex space-x-2">
                                                        <button
                                                            className="bg-blue-600 hover:bg-blue-500 text-white py-1 px-3 rounded text-sm transition"
                                                            onClick={() => handleDownloadFile(file.name)}
                                                        >
                                                            Download
                                                        </button>
                                                        {artifact.staging !== null && (
                                                            <button
                                                                className="bg-red-600 hover:bg-red-500 text-white py-1 px-3 rounded text-sm transition"
                                                                onClick={() => handleDeleteFile(file.name)}
                                                            >
                                                                Delete
                                                            </button>
                                                        )}
                                                    </div>
                                                )}

                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            ) : (
                                files !== null && <p className="text-gray-400 mt-2">No files available.</p>
                            )}
                            {artifact.staging !== null && (
                                <div className="mt-4">
                                    <label
                                        htmlFor="upload-file"
                                        className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded cursor-pointer transition"
                                    >
                                        {uploading ? "Uploading..." : "Upload File"}
                                    </label>
                                    <input
                                        id="upload-file"
                                        type="file"
                                        className="hidden"
                                        onChange={handleUploadFile}
                                        disabled={uploading}
                                    />
                                </div>
                            )}
                            <br></br>
                            <p>
                                <strong>Artifact Info:</strong>
                                <pre>{JSON.stringify(artifact, null, 2)}</pre>
                            </p>
                        </div>
                        <div className="modal-footer mt-6 flex justify-end border-t border-gray-700 pt-4">
                            <button
                                onClick={onClose}
                                className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded transition"
                            >
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };                  
        
        const ArtifactsPanel = ({ am }) => {
            const [artifacts, setArtifacts] = React.useState([]);
            const [expandedArtifacts, setExpandedArtifacts] = React.useState({});
            const [selectedArtifact, setSelectedArtifact] = React.useState(null);
        
            React.useEffect(() => {
                const fetchTopLevelArtifacts = async () => {
                    if (am) {
                        const topLevelArtifacts = await am.list(); // Fetch top-level artifacts
                        setArtifacts(topLevelArtifacts);
                    }
                };
                fetchTopLevelArtifacts();
            }, [am]);
        
            const listArtifacts = async (parentId) => {
                try {
                    const children = await am.list(parentId);
                    return children;
                } catch (error) {
                    console.error("Failed to list artifacts:", error);
                    return [];
                }
            };
        
            const listFiles = async (artifactId, dir) => {
                try {
                    return await am.listFiles(artifactId, dir);
                } catch (error) {
                    console.error("Failed to list files:", error);
                    return [];
                }
            };
        
            const handleDelete = async (artifactId, parentId = null) => {
                event.preventDefault();
                if (confirm(`Are you sure you want to delete the artifact with ID: ${artifactId}?`)) {
                    try {
                        window.showLoadingSpinner('Deleting Artifact...');
                        await am.delete(artifactId, {delete_files: true, recursive: true, _rkwargs: true}); // Delete the artifact
            
                        if (parentId) {
                            // If the artifact is a child, refresh the parent's children
                            const updatedChildren = await am.list(parentId);
                            setExpandedArtifacts((prevState) => ({
                                ...prevState,
                                [parentId]: updatedChildren,
                            }));
                        } else {
                            // If the artifact is top-level, refresh the top-level artifacts
                            setArtifacts(await am.list());
                        }
                    } catch (error) {
                        alert(`Failed to delete artifact with ID: ${artifactId}. Error: ${error}`);
                    } finally {
                        window.hideLoadingSpinner();
                    }
                }
            };            
        
            return (
                <div className="main-content">
                    {artifacts.length === 0 ? (
                        <p>No artifacts available.</p>
                    ) : (
                        <ArtifactTree
                            artifacts={artifacts}
                            expandedArtifacts={expandedArtifacts}
                            setExpandedArtifacts={setExpandedArtifacts}
                            listArtifacts={listArtifacts}
                            onMoreInfo={setSelectedArtifact}
                            onDelete={handleDelete}
                        />
                    )}
                    {selectedArtifact && (
                        <ArtifactInfoModal
                            artifact={selectedArtifact}
                            onClose={() => setSelectedArtifact(null)}
                            listFiles={listFiles}
                            am={am}
                        />
                    )}
                </div>
            );
        };
        

        const WorkspaceCard = ({ workspace, onInfoClick, onEditClick, onBookmarkClick }) => {
            return (
                <div className="flex flex-col items-start p-6 bg-gray-800 rounded-lg shadow-lg mb-6 w-full relative">
                    <button
                        className="absolute top-2 right-2 text-white"
                        onClick={() => onBookmarkClick(workspace.id)}
                    >
                        <i className="fas fa-bookmark"></i>
                    </button>
                    <h3 className="text-xl font-bold">{workspace.id}</h3>
                    <p className="text-gray-400">{workspace.description}</p>
                        <div className="mt-4 flex justify-between w-full">
                        <div className="flex space-x-4">
                            <button
                                className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                                onClick={() => onInfoClick(workspace.id)}
                            >
                                <i className="fas fa-info-circle mr-2"></i> Info
                            </button>
                            <a
                                href={`/${workspace.id}`}
                                className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                            >
                                <i className="fas fa-arrow-right mr-2"></i> Open
                            </a>
                        </div>
                        <button
                            className="bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                            onClick={() => onEditClick(workspace)}
                        >
                            <i className="fas fa-edit mr-2"></i> Edit
                        </button>
                    </div>
                </div>
            );
        };        
        
        const WorkspaceInfoModal = ({ workspaceInfo, onClose }) => {
            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h2 className="text-2xl font-bold">{workspaceInfo.name}</h2>
                            <button onClick={onClose} className="text-white text-2xl">&times;</button>
                        </div>
                        <div className="modal-body">
                            <p><strong>Description:</strong> {workspaceInfo.description || "N/A"}</p>
                            <p><strong>Persistent:</strong> {workspaceInfo.persistent ? "Yes" : "No"}</p>
                            <p><strong>Read-Only:</strong> {workspaceInfo.read_only ? "Yes" : "No"}</p>
                            <p><strong>Owners:</strong> {workspaceInfo.owners.length > 0 ? workspaceInfo.owners.join(", ") : "None"}</p>
                            <p><strong>Applications:</strong> {workspaceInfo.applications ? Object.keys(workspaceInfo.applications).join(", ") : "None"}</p>
                            <p><strong>Service Types:</strong> {workspaceInfo.service_types ? Object.keys(workspaceInfo.service_types).join(", ") : "None"}</p>
                            <p><strong>Docs:</strong> {workspaceInfo.docs || "None"}</p>
                            <p><strong>Config:</strong> <pre>{JSON.stringify(workspaceInfo.config, null, 2)}</pre></p>
                        </div>
                    </div>
                </div>
            );
        };
        const CreateWorkspaceModal = ({
            onCreateWorkspace,
            onDeleteWorkspace,
            onClose,
            workspace = {},
            isEditing = false,
        }) => {
            const [id, setId] = React.useState(workspace.id || "");
            const [name, setName] = React.useState(workspace.id || "");
            const [description, setDescription] = React.useState(
                workspace.description || ""
            );
            const [persistent, setPersistent] = React.useState(
                workspace.persistent ?? true
            );
            const [readOnly, setReadOnly] = React.useState(
                workspace.read_only ?? false
            );
            const [overwrite, setOverwrite] = React.useState(true);
            const [owners, setOwners] = React.useState(
                workspace.owners ? workspace.owners.join(", ") : ""
            );
            const handleDelete = async (event) => {
                event.preventDefault();
                if (confirm("Are you sure you want to delete this workspace?")) {
                    await onDeleteWorkspace(workspace.id);
                    onClose();
                }
            };
            const handleSubmit = async (event) => {
                event.preventDefault();
                const ownersArray = owners.split(",").map((owner) => owner.trim());
                await onCreateWorkspace(
                    { id, name, description, owners: ownersArray, persistent, read_only: readOnly },
                    overwrite
                );
                onClose();
            };
        
            return (
                <div className="modal">
                    <div className="modal-content">
                        <div className="modal-header">
                            <h2 className="text-2xl font-bold">
                                {isEditing ? "Edit Workspace" : "Create Workspace"}
                            </h2>
                            <button
                                onClick={onClose}
                                className="text-white text-2xl"
                            >
                                &times;
                            </button>
                        </div>
                        <div className="modal-body">
                            <form onSubmit={handleSubmit}>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-200">ID
                                        <p className="text-gray-500">A workspace id must contain at least one hyphen (e.g. my-workspace), in lowercase letters, numbers and hyphens only.</p>
                                    </label>
                                    <input
                                        type="text"
                                        value={id}
                                        onChange={(e) => setId(e.target.value)}
                                        className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                                        required
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-200">Name
                                        <p className="text-gray-500">A human-readable name for the workspace.</p>
                                    </label>
                                    <input
                                        type="text"
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                                        required
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-200">Description
                                        <p className="text-gray-500">A brief description of the workspace, this will be displayed in the workspace list.</p>
                                    </label>
                                    <input
                                        type="text"
                                        value={description}
                                        onChange={(e) => setDescription(e.target.value)}
                                        className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                                        required
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-200">Owners (comma-separated)
                                        <p className="text-gray-500">A list of owners who can manage the workspace, it must be a comma-separated list of user ids or email addresses.</p>
                                    </label>
                                    <input
                                        type="text"
                                        value={owners}
                                        onChange={(e) => setOwners(e.target.value)}
                                        className="text-black mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-200">Persistent
                                        <p className="text-gray-500">If checked, the workspace will be persistent and will not be deleted after a period of inactivity.</p>
                                    </label>
                                    <input
                                        type="checkbox"
                                        checked={persistent}
                                        onChange={(e) => setPersistent(e.target.checked)}
                                        className="ml-2"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-200">Read-Only</label>
                                    <input
                                        type="checkbox"
                                        checked={readOnly}
                                        onChange={(e) => setReadOnly(e.target.checked)}
                                        className="ml-2"
                                    />
                                </div>
                                <div className="mb-4">
                                    <label className="block text-sm font-medium text-gray-200">Overwrite
                                        <p className="text-gray-500">If checked, the workspace will be overwritten if it already exists.</p>
                                    </label>
                                    <input
                                        type="checkbox"
                                        checked={overwrite}
                                        onChange={(e) => setOverwrite(e.target.checked)}
                                        className="ml-2"
                                    />
                                </div>

                                {isEditing && <button
                                    className="bg-red-600 mr-3 text-white font-bold py-2 px-4 rounded"
                                    onClick={(evt) => handleDelete(evt)}
                                >
                                    Delete Workspace
                                </button>}
                                
                                <button
                                    type="submit"
                                    className="bg-blue-600 text-white font-bold py-2 px-4 rounded"
                                >
                                    {isEditing ? "Save Workspace" : "Create Workspace"}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Global drag and drop handlers and utility functions
        let globalUploadProgress = 0;
        let globalSetUploadProgress = null;
        let globalSetFileList = null;
        let globalSetExpandedDirs = null;
        let globalS3 = null;
        let globalListFiles = null;

        // Drag and drop event handlers
        const handleDragOver = (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'copy';
        };

        const handleDragEnter = (e) => {
            e.preventDefault();
            e.stopPropagation();
            // Only add visual feedback to the immediate target
            if (e.target === e.currentTarget || e.currentTarget.contains(e.target)) {
                e.currentTarget.classList.add('bg-gray-600', 'border-blue-500');
            }
        };

        const handleDragLeave = (e) => {
            e.preventDefault();
            e.stopPropagation();
            // Only remove visual feedback if we're leaving the drop zone
            if (!e.currentTarget.contains(e.relatedTarget)) {
                e.currentTarget.classList.remove('bg-gray-600', 'border-blue-500');
            }
        };

        // Utility function to upload a single file to a specific path
        const uploadFileToPath = async (file, targetPath = "", showProgress = true) => {
            try {
                if (showProgress) {
                    window.showLoadingSpinner(`Uploading ${file.name}...`);
                }
                const filePath = targetPath ? `${targetPath}/${file.name}` : file.name;
                const presignedUrl = await globalS3.generatePresignedUrl(filePath, "put_object");

                const response = await axios.put(presignedUrl, file, {
                    headers: {
                        "Content-Type": file.type || "application/octet-stream",
                    },
                    onUploadProgress: (progressEvent) => {
                        if (!progressEvent.total) return;
                        const progress = (progressEvent.loaded / progressEvent.total) * 100;
                        if (showProgress && globalSetUploadProgress) {
                            globalSetUploadProgress(progress);
                        }
                    },
                    timeout: 30000, // 30 second timeout
                });

                if (response.status === 200) {
                    console.log(`File ${file.name} uploaded successfully to ${targetPath || 'root'}`);
                    return true;
                } else {
                    console.error(`File upload failed for ${file.name}:`, response.statusText);
                    throw new Error(`Upload failed with status ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                console.error(`File upload failed for ${file.name}:`, error);
                throw error; // Re-throw to allow proper error handling upstream
            } finally {
                if (showProgress) {
                    if (globalSetUploadProgress) globalSetUploadProgress(0);
                    window.hideLoadingSpinner();
                }
            }
        };

        // Utility function to create folder structure
        const createFolderStructure = async (folderPath) => {
            try {
                const keepFilePath = folderPath ? `${folderPath}/.keep` : `.keep`;
                const keepFile = new Blob([''], { type: 'text/plain' });
                const presignedUrl = await globalS3.generatePresignedUrl(keepFilePath, "put_object");
                
                const response = await axios.put(presignedUrl, keepFile, {
                    headers: {
                        "Content-Type": "text/plain",
                    },
                });
                
                return response.status === 200;
            } catch (error) {
                console.error("Folder creation failed", error);
                return false;
            }
        };

        // Utility function to process directory entry recursively
        const processDirectoryEntry = async (entry, parentPath = "") => {
            const entryPath = parentPath ? `${parentPath}/${entry.name}` : entry.name;
            
            if (entry.isFile) {
                try {
                    const file = await new Promise((resolve, reject) => {
                        entry.file(resolve, reject);
                    });
                    
                    window.showLoadingSpinner(`Uploading ${entryPath}...`);
                    
                    await uploadFileToPath(file, parentPath, false);
                    // Small delay to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                    return true;
                } catch (error) {
                    console.error(`Failed to upload file ${entry.name}:`, error);
                    return false;
                }
            } else if (entry.isDirectory) {
                const reader = entry.createReader();
                const dirEntries = [];
                
                const readEntries = () => {
                    return new Promise((resolve) => {
                        reader.readEntries((entries) => {
                            if (entries.length > 0) {
                                dirEntries.push(...entries);
                                readEntries().then(resolve);
                            } else {
                                resolve();
                            }
                        });
                    });
                };
                
                await readEntries();
                
                // Process files in this directory
                for (const subEntry of dirEntries) {
                    await processDirectoryEntry(subEntry, entryPath);
                }
                
                // Only create .keep file if directory is completely empty
                if (dirEntries.length === 0) {
                    try {
                        window.showLoadingSpinner(`Creating empty folder ${entryPath}...`);
                        const keepFile = new Blob([''], { type: 'text/plain' });
                        // Create the .keep file directly in the folder path
                        const keepFilePath = `${entryPath}/.keep`;
                        const presignedUrl = await globalS3.generatePresignedUrl(keepFilePath, "put_object");
                        await axios.put(presignedUrl, keepFile, {
                            headers: { "Content-Type": "text/plain" }
                        });
                    } catch (error) {
                        console.error(`Failed to create empty folder ${entryPath}:`, error);
                    }
                }
                return true;
            }
            return false;
        };



        // Utility function to process dropped items (files and folders)
        const processDroppedItems = async (items, targetPath = "") => {
            window.showLoadingSpinner("Processing dropped items...");
            
            try {
                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    
                    if (item.webkitGetAsEntry) {
                        const entry = item.webkitGetAsEntry();
                        if (entry) {
                            await processDirectoryEntry(entry, targetPath);
                        }
                    } else if (item.getAsFile) {
                        const file = item.getAsFile();
                        if (file) {
                            window.showLoadingSpinner(`Uploading ${file.name}...`);
                            await uploadFileToPath(file, targetPath, false);
                            await new Promise(resolve => setTimeout(resolve, 100));
                        }
                    }
                }
                
                // Refresh the appropriate file list
                await refreshFileList(targetPath);
                
            } catch (error) {
                console.error("Error processing dropped items:", error);
                alert(`Error processing dropped items: ${error}`);
            } finally {
                window.hideLoadingSpinner();
            }
        };

        // Utility function to refresh file list
        const refreshFileList = async (targetPath = "") => {
            if (targetPath) {
                const updatedFiles = await globalListFiles(targetPath);
                if (globalSetExpandedDirs) {
                    globalSetExpandedDirs(prev => ({
                        ...prev,
                        [targetPath]: updatedFiles
                    }));
                }
            } else {
                const updatedFiles = await globalListFiles();
                if (globalSetFileList) globalSetFileList(updatedFiles);
            }
        };

        const handleFileDrop = async (e, targetPath = "") => {
            e.preventDefault();
            e.stopPropagation();
            e.currentTarget.classList.remove('bg-gray-600', 'border-blue-500');
            
            const items = Array.from(e.dataTransfer.items);
            if (items.length > 0) {
                await processDroppedItems(items, targetPath);
            } else {
                // Fallback for older browsers
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    window.showLoadingSpinner(`Uploading ${files.length} files...`);
                    try {
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            try {
                                window.showLoadingSpinner(`Uploading ${file.name} (${i + 1}/${files.length})`);
                                await uploadFileToPath(file, targetPath, false);
                                // Small delay to prevent overwhelming the server
                                await new Promise(resolve => setTimeout(resolve, 100));
                            } catch (fileError) {
                                console.error(`Failed to upload ${file.name}:`, fileError);
                                // Continue with next file
                            }
                        }
                        await refreshFileList(targetPath);
                    } catch (error) {
                        console.error("Error in fallback file upload:", error);
                    } finally {
                        window.hideLoadingSpinner();
                    }
                }
            }
        };

        const handleUploadFolderToPath = async (folderPath) => {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.webkitdirectory = true;
            fileInput.multiple = true;
            fileInput.onchange = async (event) => {
                const files = Array.from(event.target.files);
                if (files.length === 0) return;
                
                window.showLoadingSpinner("Processing folder upload...");
                
                try {
                    for (const file of files) {
                        // Update progress display
                        window.showLoadingSpinner(`Uploading ${file.name}...`);
                        
                        const relativePath = file.webkitRelativePath;
                        const pathParts = relativePath.split('/');
                        const fileName = pathParts.pop();
                        const fileFolderPath = pathParts.join('/');
                        
                        // Create full target path
                        const targetFolderPath = folderPath ? `${folderPath}/${fileFolderPath}` : fileFolderPath;
                        
                        // Upload the file directly - S3 will automatically create the folder structure
                        try {
                            await uploadFileToPath(file, targetFolderPath, false);
                            // Small delay to prevent overwhelming the server
                            await new Promise(resolve => setTimeout(resolve, 100));
                        } catch (fileError) {
                            console.error(`Failed to upload ${file.name}:`, fileError);
                            // Continue with next file instead of stopping
                        }
                    }
                    
                    // Refresh the file list
                    await refreshFileList(folderPath);
                    
                } catch (error) {
                    console.error("Error uploading folder:", error);
                    alert(`Error uploading folder: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
            fileInput.click();
        };

        const MainContent = ({
            isCollapsed,
            enabledPanels,
            ws,
            s3,
            am,
            workspaceId,
            panel,
            clients,
            services,
            apps,
            files,
            runningApps,
            onShowDetails,
            onInstallApp,
            isInstallingApp,
            setClients,
            setApps,
            setRunningApps,
        }) => {
        
            const [workspaces, setWorkspaces] = React.useState([]);
            const [showCreateModal, setShowCreateModal] = React.useState(false);
            const [selectedWorkspaceInfo, setSelectedWorkspaceInfo] = React.useState(null);
            const [editingWorkspace, setEditingWorkspace] = React.useState(null);
            const [currentWorkspaceInfo, setCurrentWorkspaceInfo] = React.useState(null);
            const [bookmarkedItems, setBookmarkedItems] = React.useState([]);
            const [uploadProgress, setUploadProgress] = React.useState(0);
            const [fileList, setFileList] = React.useState(files);
            const [selectedApp, setSelectedApp] = React.useState(null);
            const [selectedRunningApp, setSelectedRunningApp] = React.useState(null);
        
            // Centralized expandedDirs state
            const [expandedDirs, setExpandedDirs] = React.useState({});

            // Set global references
            React.useEffect(() => {
                globalSetUploadProgress = setUploadProgress;
                globalSetFileList = setFileList;
                globalSetExpandedDirs = setExpandedDirs;
                globalS3 = s3;
                globalListFiles = async (path = '') => {
                    try {
                        const files = await s3.listFiles(path);
                        return files;
                    } catch (error) {
                        console.error("Failed to list files", error);
                        return [];
                    }
                };
            }, [s3]);
        
            React.useEffect(() => {
                setFileList(files); // Keep file list updated
            }, [files]);
        
            React.useEffect(() => {
                const fetchWorkspaces = async () => {
                    if (panel === 'development' && ws) {
                        const workspacesList = await ws.listWorkspaces();
                        console.log('Workspaces:', workspacesList);
                        setWorkspaces(workspacesList);
                    }
                    if (panel === 'dashboard' && ws) {
                        try {
                            const workspaceInfo = await ws.getWorkspaceInfo(workspaceId);
                            console.log('Workspace Info:', workspaceInfo);
                            setCurrentWorkspaceInfo(workspaceInfo);
                        } catch (error) {
                            console.error('Failed to fetch workspace info:', error);
                        }
                    }
                };
                fetchWorkspaces();
            }, [panel, ws]);
        
            // Update bookmarks when currentWorkspaceInfo changes
            React.useEffect(() => {
                // Check for bookmarks in config
                if (currentWorkspaceInfo && currentWorkspaceInfo.config && currentWorkspaceInfo.config.bookmarks) {
                    setBookmarkedItems(currentWorkspaceInfo.config.bookmarks);
                } else {
                    setBookmarkedItems([]);
                }
            }, [currentWorkspaceInfo]);
        
            const handleDeleteWorkspace = async (workspaceId) => {
                try {
                    window.showLoadingSpinner('Deleting Workspace...');
                    await ws.deleteWorkspace(workspaceId);
                    setWorkspaces(await ws.listWorkspaces());
                    setSelectedWorkspaceInfo(null);
                } catch (error) {
                    alert(`Failed to delete workspace: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        
            const handleCreateWorkspace = async (workspaceData, overwrite) => {
                try {
                    window.showLoadingSpinner('Creating Workspace...');
                    await ws.createWorkspace({ ...workspaceData }, overwrite);
                    setWorkspaces(await ws.listWorkspaces());
                } catch (error) {
                    alert(`Failed to create workspace: ${error}`);
                    throw error;
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        
            const handleInfoClick = async (workspaceId) => {
                try {
                    window.showLoadingSpinner('Loading Workspace Info...');
                    const workspaceInfo = await ws.getWorkspaceInfo(workspaceId);
                    setSelectedWorkspaceInfo(workspaceInfo);
                } catch (error) {
                    alert(`Failed to get workspace info: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        
            const handleEditWorkspace = (workspace) => {
                setEditingWorkspace(workspace); // Open the create modal for editing
            };
        
            const handleSaveEditedWorkspace = async (workspaceData, overwrite) => {
                try {
                    window.showLoadingSpinner('Updating Workspace...');
                    await ws.createWorkspace({ ...workspaceData }, overwrite);
                    setWorkspaces(await ws.listWorkspaces());
                    setEditingWorkspace(null); // Close the modal after editing
                } catch (error) {
                    alert(`Failed to update workspace: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        
            const handleBookmarkWorkspace = async (newWorkspaceId) => {
                try {
                    window.showLoadingSpinner('Bookmarking Workspace...');
                    await ws.bookmark({
                        bookmark_type: 'workspace',
                        id: newWorkspaceId
                    });
                    // Refresh the workspace info
                    const workspaceInfo = await ws.getWorkspaceInfo(workspaceId);
                    setCurrentWorkspaceInfo(workspaceInfo);
                } catch (error) {
                    alert(`Failed to bookmark workspace: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        
            const handleBookmarkService = async (serviceId) => {
                try {
                    window.showLoadingSpinner('Bookmarking Service...');
                    await ws.bookmark({
                        bookmark_type: 'service',
                        id: serviceId
                    });
                    // Refresh the workspace info
                    const workspaceInfo = await ws.getWorkspaceInfo(workspaceId);
                    setCurrentWorkspaceInfo(workspaceInfo);
                } catch (error) {
                    alert(`Failed to bookmark service: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        
            const handleUnbookmarkItem = async (bookmark_type, id) => {
                try {
                    window.showLoadingSpinner('Removing Bookmark...');
                    await ws.unbookmark({
                        bookmark_type,
                        id
                    });
                    // Refresh the workspace info
                    const workspaceInfo = await ws.getWorkspaceInfo(workspaceId);
                    setCurrentWorkspaceInfo(workspaceInfo);
                } catch (error) {
                    alert(`Failed to unbookmark workspace: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };
        

        
            // Legacy function for backward compatibility
            const handleFileUpload = async (file, targetPath = "") => {
                const success = await uploadFileToPath(file, targetPath, true);
                if (success) {
                    await refreshFileList(targetPath);
                }
            };
        
            const handleFileDownload = async (filePath) => {
                try {
                    const presignedUrl = await s3.generatePresignedUrl(filePath, "get_object");
                    window.open(presignedUrl, '_blank'); // Trigger file download
                } catch (error) {
                    console.error("Failed to generate download link", error);
                }
            };
        
            const handleFileDelete = async (fullPath, type) => {
                try {
                    let answer;
                    if (type === "directory") {
                        answer = confirm(
                            `Are you sure you want to delete the directory ${fullPath} and all its contents?`
                        );
                    } else {
                        answer = confirm(`Are you sure you want to delete the file ${fullPath}?`);
                    }
                    if (!answer) return;
            
                    window.showLoadingSpinner(`Deleting ${fullPath}...`);
                    
                    // Delete the file or directory
                    if (type === "directory") {
                        await s3.deleteDirectory(fullPath + "/");
                    } else {
                        await s3.deleteFile(fullPath);
                    }
            
                    // Determine the parent directory
                    const parentPath = fullPath.substring(0, fullPath.lastIndexOf("/")) || ""; // Root if no slash
            
                    if (parentPath) {
                        // Refresh the parent directory in expandedDirs
                        const updatedFiles = await listFiles(parentPath);
                        setExpandedDirs((prevState) => ({
                            ...prevState,
                            [parentPath]: updatedFiles,
                        }));
                    } else {
                        // Refresh the top-level file list
                        const updatedFiles = await listFiles("");
                        setFileList(updatedFiles);
                    }
                } catch (error) {
                    console.error("Failed to delete file/directory", error);
                    alert(`Failed to delete ${type === "directory" ? "directory" : "file"}: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };            
        
            const listFiles = async (path = '') => {
                try {
                    const files = await s3.listFiles(path); // Ensure this calls the server to get updated data
                    return files;
                } catch (error) {
                    console.error("Failed to list files", error);
                    return [];
                }
            };

            const handleUploadToFolder = async (folderPath) => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.multiple = true;
                fileInput.onchange = async (event) => {
                    const files = Array.from(event.target.files);
                    if (files.length === 0) return;
                    
                    // Reset global progress tracking
                    try {
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            try {
                                // Update progress display
                                window.showLoadingSpinner(`Uploading ${file.name}...`);
                                
                                await uploadFileToPath(file, folderPath, false);
                                // Small delay to prevent overwhelming the server
                                await new Promise(resolve => setTimeout(resolve, 100));
                            } catch (fileError) {
                                console.error(`Failed to upload file ${file.name}:`, fileError);
                                // Continue with next file instead of stopping
                            }
                        }
                        
                        // Refresh the file list
                        await refreshFileList(folderPath);
                        
                    } catch (error) {
                        console.error("Error uploading files:", error);
                        alert(`Error uploading files: ${error}`);
                    } finally {
                        window.hideLoadingSpinner();
                    }
                };
                fileInput.click();
            };



            const handleCreateFolder = async (parentPath) => {
                const folderName = prompt('Enter folder name:');
                if (!folderName || !folderName.trim()) {
                    return;
                }
                
                const sanitizedFolderName = folderName.trim().replace(/[^a-zA-Z0-9._-]/g, '_');
                if (sanitizedFolderName !== folderName.trim()) {
                    if (!confirm(`Folder name will be sanitized to: "${sanitizedFolderName}". Continue?`)) {
                        return;
                    }
                }
                
                try {
                    window.showLoadingSpinner(`Creating folder ${sanitizedFolderName}...`);
                    const keepFilePath = parentPath ? `${parentPath}/${sanitizedFolderName}/.keep` : `${sanitizedFolderName}/.keep`;
                    
                    // Create a .keep file to represent the folder
                    const keepFile = new Blob([''], { type: 'text/plain' });
                    const presignedUrl = await s3.generatePresignedUrl(keepFilePath, "put_object");
                    
                    const response = await axios.put(presignedUrl, keepFile, {
                        headers: {
                            "Content-Type": "text/plain",
                        },
                    });
                    
                    if (response.status === 200) {
                        console.log(`Folder ${sanitizedFolderName} created successfully`);
                        
                        // Refresh the appropriate file list
                        if (parentPath) {
                            const updatedFiles = await listFiles(parentPath);
                            setExpandedDirs(prev => ({
                                ...prev,
                                [parentPath]: updatedFiles
                            }));
                        } else {
                            const updatedFiles = await listFiles();
                            setFileList(updatedFiles);
                        }
                    } else {
                        console.error("Folder creation failed", response.statusText);
                        alert("Folder creation failed: " + response.statusText);
                    }
                } catch (error) {
                    console.error("Folder creation failed", error);
                    alert(`Folder creation failed: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };

            // App management handlers
            const handleUninstallApp = async (appId) => {
                if (!confirm(`Are you sure you want to uninstall app ${appId}?`)) {
                    return;
                }
                try {
                    window.showLoadingSpinner('Uninstalling Application...');
                    if (!ws || !ws.getService) {
                        throw new Error('WebSocket connection not ready. Please wait for the connection to be established.');
                    }
                    const controller = await ws.getService('public/server-apps', { case_conversion: 'camel' });
                    await controller.uninstall(appId);
                    await refreshApps(ws);
                } catch (error) {
                    console.error('Failed to uninstall app:', error);
                    alert(`Failed to uninstall app: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };

            const handleStartApp = async (appId) => {
                try {
                    window.showLoadingSpinner('Starting Application...');
                    if (!ws || !ws.getService) {
                        throw new Error('WebSocket connection not ready. Please wait for the connection to be established.');
                    }
                    const controller = await ws.getService('public/server-apps', { case_conversion: 'camel' });
                    const appInfo = await controller.start(appId);
                    console.log('App started:', appInfo);
                    // Refresh both apps and running apps lists
                    await refreshApps(ws);
                    await refreshRunningApps(ws);
                } catch (error) {
                    console.error('Failed to start app:', error);
                    // Still show alert for errors since it's important feedback
                    alert(`Failed to start app: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };

            const handleStopApp = async (sessionId) => {
                if (!confirm(`Are you sure you want to stop session ${sessionId}?`)) {
                    return;
                }
                try {
                    window.showLoadingSpinner('Stopping Application...');
                    if (!ws || !ws.getService) {
                        throw new Error('WebSocket connection not ready. Please wait for the connection to be established.');
                    }
                    const controller = await ws.getService('public/server-apps', { case_conversion: 'camel' });
                    await controller.stop(sessionId);
                    await refreshRunningApps(ws);
                } catch (error) {
                    console.error('Failed to stop app:', error);
                    alert(`Failed to stop app: ${error}`);
                } finally {
                    window.hideLoadingSpinner();
                }
            };

            const refreshApps = async (wsConnection) => {
                try {
                    if (!wsConnection || !wsConnection.getService) {
                        console.warn('WebSocket connection not ready for refreshApps');
                        return;
                    }
                    const controller = await wsConnection.getService('public/server-apps', { case_conversion: 'camel' });
                    const apps = await controller.listApps();
                    setApps(apps);
                } catch (error) {
                    console.error('Failed to refresh apps:', error);
                }
            };

            const refreshRunningApps = async (wsConnection) => {
                try {
                    if (!wsConnection || !wsConnection.getService) {
                        console.warn('WebSocket connection not ready for refreshRunningApps');
                        return;
                    }
                    const controller = await wsConnection.getService('public/server-apps', { case_conversion: 'camel' });
                    const running = await controller.listRunning();
                    setRunningApps(running);
                } catch (error) {
                    console.error('Failed to refresh running apps:', error);
                }
            };
        
            return (
                <div
                    className={`main-content transition-all duration-300 ${isCollapsed ? 'ml-16' : 'ml-64'}`}
                >
                    {panel === 'dashboard' && (
                        <>
                            <h1 className="text-4xl font-bold capitalize">Dashboard</h1>
                            {/* Header Section for Workspace Info */}
                            {currentWorkspaceInfo && (
                                <div className="relative p-6 bg-gray-800 rounded-lg shadow-lg m-10">
                                    {/* Bookmark Icon in the Upper Right Corner */}
                                    <button
                                        className="absolute top-4 right-4 text-yellow-400 hover:text-yellow-500 transition duration-300"
                                        onClick={() => handleBookmarkWorkspace(currentWorkspaceInfo.id)}
                                    >
                                        <i className="fas fa-bookmark fa-2x"></i>
                                    </button>

                                    {/* Add cleanup button - new code */}
                                    <button
                                        className="absolute top-4 right-16 text-blue-400 hover:text-blue-500 transition duration-300 flex items-center"
                                        onClick={async () => {
                                            try {
                                                window.showLoadingSpinner('Cleaning up Workspace...');
                                                await window.remoteServer.cleanup();
                                                // Refresh clients list after cleanup
                                                const updatedClients = await ws.listClients();
                                                setClients(updatedClients);
                                            } catch (error) {
                                                console.error('Cleanup failed:', error);
                                                alert(`Failed to cleanup workspace: ${error}`);
                                            } finally {
                                                window.hideLoadingSpinner();
                                            }
                                        }}
                                        title="Remove dead clients and cleanup workspace"
                                    >
                                        <i className="fas fa-broom fa-2x"></i>
                                    </button>
                                
                                    {/* Header Section */}
                                    <div className="flex items-center mb-6">
                                        <i className="fas fa-folder-open fa-2x text-blue-400 mr-4"></i>
                                        <h2 className="text-3xl font-bold text-white">Workspace: {currentWorkspaceInfo.name}</h2>
                                    </div>
                                
                                    {/* Main Info Section */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-2">
                                        <div>
                                            <p className="text-lg text-gray-400 mb-4 flex items-center">
                                                <i className="fas fa-tag mr-2 text-blue-400"></i>
                                                <strong>ID: </strong> {currentWorkspaceInfo.id}
                                            </p>
                                            <p className="text-lg text-gray-400 mb-4 flex items-center">
                                                <i className="fas fa-tag mr-2 text-blue-400"></i>
                                                <strong>Name: </strong> {currentWorkspaceInfo.name}
                                            </p>
                                            <p className="text-lg text-gray-400 mb-4 flex items-center">
                                                <i className="fas fa-shield-alt mr-2 text-green-400"></i>
                                                <strong>Persistent: </strong> {currentWorkspaceInfo.persistent ? 'Yes' : 'No'}
                                            </p>
                                            <p className="text-lg text-gray-400 mb-4 flex items-center">
                                                <i className="fas fa-lock mr-2 text-red-400"></i>
                                                <strong>Read-Only: </strong> {currentWorkspaceInfo.read_only ? 'Yes' : 'No'}
                                            </p>
                                        </div>
                                        <div>
                                            <div className="flex items-center text-lg text-gray-400 mb-4">
                                                <i className="fas fa-users mr-2 text-yellow-400"></i>
                                                <strong>Owners: </strong>
                                                <div className="flex flex-wrap ml-2">
                                                    {currentWorkspaceInfo.owners ? (
                                                        currentWorkspaceInfo.owners.map((owner, idx) => (
                                                            <span key={idx} className="bg-gray-600 text-white rounded-full px-3 py-1 mr-2 mb-2 text-sm">
                                                                {owner}
                                                            </span>
                                                        ))
                                                    ) : (
                                                        <span>No owners</span>
                                                    )}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="text-gray-300 p-2 rounded-lg mb-3">
                                        <p className="text-md">
                                            <strong>Description: </strong> {currentWorkspaceInfo.description || 'No description available'}
                                        </p>
                                    </div>
                                
                                    {/* Info Box */}
                                    <div className="bg-gray-700 text-gray-300 p-4 rounded-lg mb-6">
                                        <p className="text-md mb-4">
                                            <i className="fas fa-info-circle text-blue-400 mr-2"></i>
                                            A Hypha workspace is an isolated virtual space for connected users, computational clients, and AI agents, similar to an online meeting room. To connect to this workspace, you need to 
                                            <a href="#development" className="text-blue-400 underline ml-1">generate an access token</a>.
                                        </p>
                                    </div>
                                </div>
                                
                                
                            )}
                            {bookmarkedItems.length > 0 && (
                                <>
                                  <hr className="my-8 border-gray-700"></hr>
                                  <div className="flex items-center mb-6">
                                    {/* Icon for bookmarks */}
                                    <i className="fas fa-bookmark fa-2x text-yellow-400 mr-3"></i>
                                    <h2 className="text-2xl font-bold">Bookmarks</h2>
                                  </div>
                                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8 mt-6">
                                    {bookmarkedItems.map((item, idx) => (
                                      <div
                                        key={idx}
                                        className="p-6 bg-gray-800 rounded-lg shadow-lg relative hover:shadow-xl transition-shadow duration-300"
                                      >
                                        {/* Icon based on type */}
                                        <div className="flex items-center mb-4">
                                          {item.bookmark_type === "workspace" ? (
                                            <i className="fas fa-folder fa-2x text-blue-400 mr-3"></i>
                                          ) : (
                                            <i className="fas fa-cogs fa-2x text-green-400 mr-3"></i>
                                          )}
                                          <p className="text-white whitespace-pre-wrap break-words">{item.name}</p>
                                        </div>
                                        <p className="text-gray-400 whitespace-pre-wrap break-words">ID: <code>{item.id}</code></p>
                                        {/* Description */}
                                        <p className="text-gray-400 mb-4">{item.description || "No description available"}</p>
                              
                                        {/* Type label */}
                                        <span
                                          className={`text-sm font-semibold ${
                                            item.bookmark_type === "workspace" ? "text-blue-300" : "text-green-300"
                                          } mb-4`}
                                        >
                                          {item.bookmark_type.charAt(0).toUpperCase() + item.bookmark_type.slice(1)}
                                        </span>
                              
                                        {/* Button to go to the workspace (only for workspace type) */}
                                        {item.bookmark_type === "workspace" && (
                                          <a
                                            href={`/${item.id}`}
                                            className="absolute bottom-4 right-4 bg-blue-500 hover:bg-blue-400 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                                          >
                                            <i className="fas fa-arrow-right mr-2"></i> Go to Workspace
                                          </a>
                                        )}
                              
                                        {/* Delete Button */}
                                        <button
                                            onClick={() => handleUnbookmarkItem(item.bookmark_type, item.id)}
                                            className="absolute top-4 right-4 text-gray-400 hover:text-red-500 transition duration-300"
                                            >
                                            <i className="fas fa-times fa-2x"></i>
                                            </button>
                                      </div>
                                    ))}
                                  </div>
                                </>
                            )}
                            <hr className="my-8 border-gray-700"></hr>
                            <div className="flex items-center mb-6">
                                <i className="fas fa-users fa-2x text-yellow-400 mr-3"></i>
                                <h2 className="text-2xl font-bold">Clients</h2>
                            </div>
                            <p className="text-xl text-gray-400 mt-4">
                                Clients connected to workspace: <code>{workspaceId}</code>
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                                {clients.map(client => (
                                    <ClientCard key={client.id} client={client} />
                                ))}
                            </div>
                            <hr className="my-8 border-gray-700"></hr>
                            <div className="flex items-center mb-6">
                                <i className="fas fa-cogs fa-2x text-green-400 mr-3"></i>
                                <h2 className="text-2xl font-bold">Services</h2>
                            </div>
                            <p className="text-xl text-gray-400 mt-4">
                                Services available in workspace: <code>{workspaceId}</code>
                            </p>
                            <div className="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-8 mt-6">
                                {services.map(service => (
                                    service.type !== "built-in" && (
                                        <ServiceCard 
                                            key={service.id} 
                                            service={service} 
                                            onBookmarkService={handleBookmarkService} 
                                            onShowDetails={onShowDetails} 
                                        />
                                    )
                                ))}
                            </div>
                        </>
                    )}
        
                    {panel === 'applications' && (
                        <>
                            <h1 className="text-4xl font-bold capitalize">Applications</h1>
                            <div
                                style={{ display: 'block', width: '100%', height: '100%', zIndex: 1000 }}
                                id="hypha-window-container"
                            ></div>
                            <p className="text-xl text-gray-400 mt-4">
                                Applications installed in workspace: <code>{workspaceId}</code>
                            </p>
                            <div className="flex gap-4 mt-6">
                                <button
                                    className={`font-bold py-2 px-4 rounded-full transition duration-300 flex items-center ${
                                        isInstallingApp || !ws
                                            ? 'bg-gray-700 cursor-not-allowed' 
                                            : 'bg-green-600 hover:bg-green-500'
                                    } text-white`}
                                    onClick={() => window.loadCodeEditor(ws, refreshApps)}
                                    disabled={isInstallingApp || !ws}
                                >
                                    <i className="fas fa-code mr-2"></i> New App
                                </button>
                                <button
                                    className={`font-bold py-2 px-4 rounded-full transition duration-300 flex items-center ${
                                        isInstallingApp || !ws
                                            ? 'bg-gray-600 cursor-not-allowed' 
                                            : 'bg-gray-600 hover:bg-gray-500'
                                    } text-white`}
                                    onClick={() => onInstallApp()}
                                    disabled={isInstallingApp || !ws}
                                >
                                    {isInstallingApp ? (
                                        <>
                                            <i className="fas fa-spinner fa-spin mr-2"></i> Installing...
                                        </>
                                    ) : (
                                        <>
                                            <i className="fas fa-plus mr-2"></i> Install From URL
                                        </>
                                    )}
                                </button>
                                <button
                                    className={`font-bold py-2 px-4 rounded-full transition duration-300 flex items-center ${
                                        isInstallingApp || !ws
                                            ? 'bg-gray-700 cursor-not-allowed' 
                                            : 'bg-gray-600 hover:bg-gray-500'
                                    } text-white`}
                                    onClick={() => refreshApps(ws)}
                                    disabled={isInstallingApp || !ws}
                                >
                                    <i className="fas fa-sync mr-2"></i> Refresh
                                </button>
                            </div>
                            
                            <hr className="my-8 border-gray-700"></hr>
                            
                            <div className="flex items-center mb-6">
                                <i className="fas fa-th-large fa-2x text-blue-400 mr-3"></i>
                                <h2 className="text-2xl font-bold">Installed Applications</h2>
                            </div>
                            
                            {apps.length === 0 ? (
                                <div className="text-center py-8 text-gray-400">
                                    <i className="fas fa-inbox text-4xl mb-4"></i>
                                    <p>No apps installed</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-8">
                                    {apps.map(app => (
                                        <AppCard 
                                            key={app.id} 
                                            app={app} 
                                            onUninstall={handleUninstallApp}
                                            onShowDetails={setSelectedApp}
                                            onStart={handleStartApp}
                                        />
                                    ))}
                                </div>
                            )}
                            
                            <hr className="my-8 border-gray-700"></hr>
                            
                            <div className="flex items-center justify-between mb-6">
                                <div className="flex items-center">
                                    <i className="fas fa-play-circle fa-2x text-green-400 mr-3"></i>
                                    <h2 className="text-2xl font-bold">Running Applications</h2>
                                </div>
                                <button
                                    className={`font-bold py-2 px-4 rounded-full transition duration-300 flex items-center ${
                                        isInstallingApp || !ws
                                            ? 'bg-gray-700 cursor-not-allowed' 
                                            : 'bg-gray-600 hover:bg-gray-500'
                                    } text-white`}
                                    onClick={() => refreshRunningApps(ws)}
                                    disabled={isInstallingApp || !ws}
                                >
                                    <i className="fas fa-sync mr-2"></i> Refresh
                                </button>
                            </div>
                            
                            {runningApps.length === 0 ? (
                                <div className="text-center py-8 text-gray-400">
                                    <i className="fas fa-sleep text-4xl mb-4"></i>
                                    <p>No apps currently running</p>
                                </div>
                            ) : (
                                <div className="grid grid-cols-1 md:grid-cols-1 lg:grid-cols-2 gap-8">
                                    {runningApps.map(app => (
                                        <RunningAppCard 
                                            key={app.id} 
                                            app={app} 
                                            onStop={handleStopApp}
                                            onShowDetails={setSelectedRunningApp}
                                        />
                                    ))}
                                </div>
                            )}
                        </>
                    )}
        
                    {panel === 'files' && (
                        <>
                            <h1 className="text-4xl font-bold capitalize">Files</h1>
                            <p className="text-xl text-gray-400 mt-4">
                                Files in workspace: <code>{workspaceId}</code>
                            </p>
                            
                            {/* Root folder management buttons */}
                            <div className="flex gap-4 mt-6">
                                <button
                                    className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                                    onClick={() => handleUploadToFolder("")}
                                >
                                    <i className="fas fa-upload mr-2"></i> Upload Files
                                </button>
                                <button
                                    className="bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                                    onClick={() => handleUploadFolderToPath("")}
                                >
                                    <i className="fas fa-folder-open mr-2"></i> Upload Folder
                                </button>
                                <button
                                    className="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                                    onClick={() => handleCreateFolder("")}
                                >
                                    <i className="fas fa-folder-plus mr-2"></i> Create Folder
                                </button>
                            </div>
                            
                            <div 
                                className="p-4 border-dashed border-4 border-gray-600 rounded mt-6 transition-all duration-200"
                                onDragOver={handleDragOver}
                                onDragEnter={handleDragEnter}
                                onDragLeave={handleDragLeave}
                                onDrop={(e) => handleFileDrop(e, "")}
                            >
                                <p className="text-center text-gray-500">
                                    Drag and drop files or folders here to upload to root folder
                                </p>
                                <p className="text-center text-gray-400 text-sm mt-2">
                                    Supports nested folder structures
                                </p>
                                {!!uploadProgress && (
                                    <div className="w-full bg-gray-600 h-4 rounded relative flex items-center justify-center mt-4">
                                        <div
                                            className="bg-blue-500 h-4 rounded"
                                            style={{ width: `${uploadProgress}%` }}
                                        ></div>
                                        <span className="absolute text-white text-sm">
                                            {Math.round(uploadProgress, 1)}%
                                        </span>
                                    </div>
                                )}
                            </div>
                            <div className="mt-6">
                                {fileList.length === 0 ? (
                                    <p>No files available.</p>
                                ) : (
                                    <FileTree
                                        files={fileList}
                                        onDelete={handleFileDelete}
                                        onDownload={handleFileDownload}
                                        listFiles={listFiles}
                                        // Pass the centralized expandedDirs and setExpandedDirs
                                        expandedDirs={expandedDirs}
                                        setExpandedDirs={setExpandedDirs}
                                        onUploadToFolder={handleUploadToFolder}
                                        onCreateFolder={handleCreateFolder}
                                        onDragOver={handleDragOver}
                                        onDragEnter={handleDragEnter}
                                        onDragLeave={handleDragLeave}
                                        onDrop={handleFileDrop}
                                        onUploadFolderToPath={handleUploadFolderToPath}
                                    />
                                )}
                            </div>
                        </>
                    )}
        
                    {panel === 'development' && (
                        <>
                            <h1 className="text-4xl font-bold capitalize">Development</h1>


                            <hr className="my-8 border-gray-700"></hr>
        
                            <h2 className="text-2xl font-bold mt-5">
                                Workspaces <i className="fas fa-folder-open text-xl text-gray-400"></i>
                            </h2>
                            <p className="text-xl text-gray-400 mt-4">
                                Workspaces accessible to you
                            </p>
                            <div className="flex justify-between items-center mt-6">
                                <button
                                    className="bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded-full transition duration-300 flex items-center"
                                    onClick={() => setShowCreateModal(true)}
                                >
                                    <i className="fas fa-plus mr-2"></i> Create Workspace
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-2 gap-8 mt-6">
                                {workspaces.map((workspace) => (
                                    <WorkspaceCard
                                        key={workspace.id}
                                        workspace={workspace}
                                        onInfoClick={handleInfoClick}
                                        onEditClick={handleEditWorkspace}
                                        onBookmarkClick={handleBookmarkWorkspace}
                                    />
                                ))}
                            </div>

                            <hr className="my-8 border-gray-700"></hr>

                            <h2 className="text-2xl font-bold mt-5">
                                Connection Tokens <i className="fas fa-key text-xl text-gray-400"></i>
                            </h2>
                            <TokenPanel
                                workspaceId={workspaceId}
                                onGenerateToken={async (workspace, expiryTime, clientId) => {
                                    const tokenConfig = { expires_in: expiryTime, workspace };
                                    if (clientId && clientId.trim()) {
                                        tokenConfig.client_id = clientId.trim();
                                    }
                                    const token = await ws.generateToken(tokenConfig);
                                    return token;
                                }}
                            />

                            <hr className="my-8 border-gray-700"></hr>

                            <h2 className="text-2xl font-bold mt-5">
                                Environment Variables <i className="fas fa-cog text-xl text-gray-400"></i>
                            </h2>
                            <EnvManagementPanel ws={ws} />
                        </>
                    )}
                    { panel === 'artifacts' && (
                        <>
                            <h1 className="text-4xl font-bold capitalize">Artifacts</h1>
                            <p className="text-xl text-gray-400 mt-4">
                                Artifacts in workspace: <code>{workspaceId}</code>
                            </p>
                            <div className="mt-6">
                                <ArtifactsPanel am={am} />
                            </div>
                        </>
                    )}
        
                    {showCreateModal && (
                        <CreateWorkspaceModal
                            onDeleteWorkspace={handleDeleteWorkspace}
                            onCreateWorkspace={handleCreateWorkspace}
                            onClose={() => setShowCreateModal(false)}
                        />
                    )}
        
                    {editingWorkspace && (
                        <CreateWorkspaceModal
                            workspace={editingWorkspace} // Prefill with existing workspace data
                            onDeleteWorkspace={handleDeleteWorkspace}
                            onCreateWorkspace={handleSaveEditedWorkspace} // Save edited data
                            onClose={() => setEditingWorkspace(null)}
                            isEditing={true} // Indicator to show that it's editing mode
                        />
                    )}
        
                    {selectedWorkspaceInfo && (
                        <WorkspaceInfoModal
                            workspaceInfo={selectedWorkspaceInfo}
                            onClose={() => setSelectedWorkspaceInfo(null)}
                        />
                    )}
                    
                    {selectedApp && (
                        <AppDetailsModal
                            app={selectedApp}
                            onClose={() => setSelectedApp(null)}
                        />
                    )}
                    
                    {selectedRunningApp && (
                        <AppDetailsModal
                            app={selectedRunningApp}
                            onClose={() => setSelectedRunningApp(null)}
                        />
                    )}
                    
                    <footer className="bg-gray-900 text-gray-400 py-6 mt-16">
                        <div className="container mx-auto text-center">
                            <p>Hypha is an open-source platform released under the MIT license.</p>
                            <p>
                                Visit our <a href="https://github.com/amun-ai/hypha" target="_blank" className="text-gray-300 hover:text-white">GitHub repository</a> for more information.
                            </p>
                        </div>
                    </footer>
                </div>
            );
        };

        const config = window.defaultService.getServerConfig();

        const getActivePanelFromHash = () => {
            const hash = window.location.hash.slice(1); // Remove the "#" from the hash
            return hash || 'dashboard'; // Default to 'dashboard' panel if no hash
        };

        const App = () => {
            const [isCollapsed, setIsCollapsed] = React.useState(false);
            const [enabledPanels, setEnabledPanels] = React.useState(['dashboard', 'development']);
            const [activePanel, setActivePanel] = React.useState(getActivePanelFromHash);
            const [clients, setClients] = React.useState([]);
            const [services, setServices] = React.useState([]);
            const [apps, setApps] = React.useState([]);
            const [runningApps, setRunningApps] = React.useState([]);
            const [files, setFiles] = React.useState([]);
            const [ws, setWs] = React.useState(null);
            const [s3, setS3] = React.useState(null);
            const [am, setAM] = React.useState(null);
            const [selectedService, setSelectedService] = React.useState(null);
            const [isInstallingApp, setIsInstallingApp] = React.useState(false);
            const [isLoadingSpinnerVisible, setIsLoadingSpinnerVisible] = React.useState(true); // Show loading initially
            const [loadingMessage, setLoadingMessage] = React.useState('Connecting to Hypha server...');
        
            // Expose spinner control functions globally for code editor and other components
            window.showLoadingSpinner = (message = 'Loading...') => {
                setLoadingMessage(message);
                setIsLoadingSpinnerVisible(true);
            };
            
            window.hideLoadingSpinner = () => {
                setIsLoadingSpinnerVisible(false);
                setLoadingMessage('Loading...');
            };
            
            // Keep backward compatibility
            window.showInstallSpinner = (message = 'Installing Application...') => {
                window.showLoadingSpinner(message);
            };
            
            window.hideInstallSpinner = () => {
                window.hideLoadingSpinner();
            };

            React.useEffect(() => {
                // Connect to the Hypha server
                const connectToServer = async () => {
                    try{
                        setLoadingMessage('Connecting to Hypha server...');
                        const remoteServer = await hyphaWebsocketClient.connectToServer(config);
                        window.remoteServer = remoteServer;
                        
                        setLoadingMessage('Loading services...');
                        const newPanels = [];
                        try{
                            await remoteServer.getService('public/server-apps', { case_conversion: 'camel' });
                            newPanels.push('applications');
                        }
                        catch(e){
                            console.log("Server apps service not available");
                        }
                        try {
                            const s3 = await remoteServer.getService('public/s3-storage', { case_conversion: 'camel' });
                            newPanels.push('files');
                            setS3(s3);
                        }
                        catch(e){
                            console.log("S3 storage service not available");
                        }
                        try {
                            // get artifact service
                            const am = await remoteServer.getService('public/artifact-manager', { case_conversion: 'camel' });
                            newPanels.push('artifacts');
                            setAM(am);
                        }
                        catch(e){
                            console.log("Artifacts service not available");
                        }
                        
                        setLoadingMessage('Initializing workspace...');
                        setEnabledPanels([...enabledPanels, ...newPanels]);
                        setWs(remoteServer);
                        
                        // Hide loading overlay after successful connection
                        setTimeout(() => {
                            setIsLoadingSpinnerVisible(false);
                        }, 500); // Small delay to show "Initializing workspace..." message
                    }
                    catch(e){
                        // Hide loading overlay on error
                        setIsLoadingSpinnerVisible(false);
                        // clear access token
                        document.cookie = 'access_token=; path=/; max-age=0; samesite=lax';
                        const redirectUrl = '/public/apps/hypha-login/?redirect=' + window.location.href;
                        alert(`Failed to connect to the server: ${e}, redirecting to login: ${redirectUrl}`);
                        window.location.href = redirectUrl;
                    }
                };
                connectToServer();
            }, []);
        
            React.useEffect(() => {
                // Fetch initial workspace data based on active panel
                const fetchWorkspaceData = async () => {
                    if (!ws) {
                        return;
                    }
                    
                    // Show loading overlay for data fetching when switching panels
                    if (activePanel === 'dashboard') {
                        setLoadingMessage('Loading dashboard data...');
                        setIsLoadingSpinnerVisible(true);
                        try {
                            setClients(await ws.listClients());
                            setServices(await ws.listServices(config.workspace));
                        } finally {
                            setIsLoadingSpinnerVisible(false);
                        }
                    } else if (activePanel === 'applications') {
                        setLoadingMessage('Loading applications...');
                        setIsLoadingSpinnerVisible(true);
                        try {
                            const controller = await ws.getService('public/server-apps', { case_conversion: 'camel' });
                            const apps = await controller.listApps();
                            const running = await controller.listRunning();
                            setApps(apps);
                            setRunningApps(running);
                        } catch (e) {
                            alert(`Failed to list apps: ${e.message}`);
                        } finally {
                            setIsLoadingSpinnerVisible(false);
                        }
                    } else if (activePanel === 'files') {
                        setLoadingMessage('Loading files...');
                        setIsLoadingSpinnerVisible(true);
                        try {
                            const s3 = await ws.getService('public/s3-storage', { case_conversion: 'camel' });
                            const files = await s3.listFiles();
                            setFiles(files);
                        } catch (e) {
                            alert(`Failed to list files: ${e.message}`);
                        } finally {
                            setIsLoadingSpinnerVisible(false);
                        }
                    } else if (activePanel === 'artifacts') {
                        setLoadingMessage('Loading artifacts...');
                        setIsLoadingSpinnerVisible(true);
                        try {
                            const am = await ws.getService('public/artifact-manager', { case_conversion: 'camel' });
                            setAM(am);
                        } catch (e) {
                            alert(`Failed to list artifacts: ${e.message}`);
                        } finally {
                            setIsLoadingSpinnerVisible(false);
                        }
                    }
                };
                fetchWorkspaceData();
                document.title = `${activePanel.charAt(0).toUpperCase() + activePanel.slice(1)} - Hypha Workspace Management`;
            }, [activePanel, ws]);
        
            const onShowDetails = (service) => {
                setSelectedService(service);
            };
        
            const onInstallApp = async () => {
                if (!ws || !ws.getService) {
                    alert('WebSocket connection not ready. Please wait for the connection to be established.');
                    return;
                }
                
                const url = prompt(
                    'Enter the URL of the app to install (*.hypha.html)',
                    window.location.origin + '/ws/code_template.hypha.html'
                );
                if (!url) return;
                
                setIsInstallingApp(true);
                try {
                    window.showLoadingSpinner('Installing Application...');
                    const controller = await ws.getService('public/server-apps', { case_conversion: 'camel' });
                    const appInfo = await controller.install(url, { overwrite: true, _rkwargs: true});
                    console.log('App installed:', appInfo);
                    setApps(await controller.listApps());
                } catch (e) {
                    console.error(e);
                    alert(`Failed to install app: ${e.message}`);
                } finally {
                    setIsInstallingApp(false);
                    window.hideLoadingSpinner();
                }
            };
        
            const closeModal = () => {
                setSelectedService(null);
            };

            React.useEffect(() => {
                const updateHash = () => {
                    window.location.hash = activePanel; // Update the URL hash when the active panel changes
                };
                updateHash();
            }, [activePanel]);

            React.useEffect(() => {
                const handleHashChange = () => {
                    setActivePanel(getActivePanelFromHash()); // Set the active panel based on the URL hash when it changes
                };

                window.addEventListener('hashchange', handleHashChange);
                return () => window.removeEventListener('hashchange', handleHashChange); // Cleanup event listener
            }, []);

            return (
                <div>
                    <Sidebar isCollapsed={isCollapsed} enabledPanels={enabledPanels} onToggle={() => setIsCollapsed(!isCollapsed)} setActivePanel={setActivePanel} />
                    <MainContent
                        isCollapsed={isCollapsed}
                        enabledPanels={enabledPanels}
                        ws={ws}
                        s3={s3}
                        am={am}
                        workspaceId={config.workspace}
                        panel={activePanel}
                        clients={clients}
                        services={services}
                        apps={apps}
                        runningApps={runningApps}
                        files={files}
                        onShowDetails={onShowDetails}
                        onInstallApp={onInstallApp}
                        isInstallingApp={isInstallingApp}
                        setClients={setClients}
                        setApps={setApps}
                        setRunningApps={setRunningApps}
                    />
                    {selectedService && <Modal serviceInfo={selectedService} onClose={() => setSelectedService(null)} />}
                    <SpinnerOverlay isVisible={isLoadingSpinnerVisible} message={loadingMessage} />
                </div>
            );
        };
        
        ReactDOM.render(<App />, document.getElementById('app'));
        
    </script>
</body>

</html>
